"use strict";function _typeof(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}function _typeof(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}function _typeof(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}function _typeof(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}function _typeof(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}function _typeof(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}function _typeof(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}!function(){var e,t,r,o;!function(){var i={},n={};e=function(e,t,r){i[e]={deps:t,callback:r}},o=r=t=function(e){function r(t){if("."!==t.charAt(0))return t;for(var r=t.split("/"),o=e.split("/").slice(0,-1),i=0,n=r.length;n>i;i++){var a=r[i];if(".."===a)o.pop();else{if("."===a)continue;o.push(a)}}return o.join("/")}if(o._eak_seen=i,n[e])return n[e];if(n[e]={},!i[e])throw new Error("Could not find module "+e);for(var a,s=i[e],c=s.deps,l=s.callback,u=[],d=0,p=c.length;p>d;d++)"exports"===c[d]?u.push(a={}):u.push(t(r(c[d])));var y=l.apply(this,u);return n[e]=a||y}}(),e("promise/all",["./utils","exports"],function(e,t){function r(e){var t=this;if(!o(e))throw new TypeError("You must pass an array to all.");return new t(function(t,r){function o(e){return function(t){n(e,t)}}function n(e,r){s[e]=r,0===--c&&t(s)}var a,s=[],c=e.length;0===c&&t([]);for(var l=0;l<e.length;l++)a=e[l],a&&i(a.then)?a.then(o(l),r):n(l,a)})}var o=e.isArray,i=e.isFunction;t.all=r}),e("promise/asap",["exports"],function(e){function t(){return function(){process.nextTick(i)}}function r(){var e=0,t=new c(i),r=document.createTextNode("");return t.observe(r,{characterData:!0}),function(){r.data=e=++e%2}}function o(){return function(){l.setTimeout(i,1)}}function i(){for(var e=0;e<u.length;e++){var t=u[e],r=t[0],o=t[1];r(o)}u=[]}function n(e,t){var r=u.push([e,t]);1===r&&a()}var a,s="undefined"!=typeof window?window:{},c=s.MutationObserver||s.WebKitMutationObserver,l="undefined"!=typeof global?global:this,u=[];a="undefined"!=typeof process&&"[object process]"==={}.toString.call(process)?t():c?r():o(),e.asap=n}),e("promise/cast",["exports"],function(e){function t(e){if(e&&"object"==("undefined"==typeof e?"undefined":_typeof(e))&&e.constructor===this)return e;var t=this;return new t(function(t){t(e)})}e.cast=t}),e("promise/config",["exports"],function(e){function t(e,t){return 2!==arguments.length?r[e]:void(r[e]=t)}var r={instrument:!1};e.config=r,e.configure=t}),e("promise/polyfill",["./promise","./utils","exports"],function(e,t,r){function o(){var e="Promise"in window&&"cast"in window.Promise&&"resolve"in window.Promise&&"reject"in window.Promise&&"all"in window.Promise&&"race"in window.Promise&&function(){var e;return new window.Promise(function(t){e=t}),n(e)}();e||(window.Promise=i)}var i=e.Promise,n=t.isFunction;r.polyfill=o}),e("promise/promise",["./config","./utils","./cast","./all","./race","./resolve","./reject","./asap","exports"],function(e,t,r,o,i,n,a,s,c){function l(e){if(!j(e))throw new TypeError("You must pass a resolver function as the first argument to the promise constructor");if(!(this instanceof l))throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.");this._subscribers=[],u(e,this)}function u(e,t){function r(e){g(t,e)}function o(e){m(t,e)}try{e(r,o)}catch(i){o(i)}}function d(e,t,r,o){var i,n,a,s,c=j(r);if(c)try{i=r(o),a=!0}catch(l){s=!0,n=l}else i=o,a=!0;b(t,i)||(c&&a?g(t,i):s?m(t,n):e===D?g(t,i):e===A&&m(t,i))}function p(e,t,r,o){var i=e._subscribers,n=i.length;i[n]=t,i[n+D]=r,i[n+A]=o}function y(e,t){for(var r,o,i=e._subscribers,n=e._detail,a=0;a<i.length;a+=3)r=i[a],o=i[a+t],d(t,r,o,n);e._subscribers=null}function b(e,t){var r,o=null;try{if(e===t)throw new TypeError("A promises callback cannot return that same promise.");if(w(t)&&(o=t.then,j(o)))return o.call(t,function(o){return r?!0:(r=!0,void(t!==o?g(e,o):f(e,o)))},function(t){return r?!0:(r=!0,void m(e,t))}),!0}catch(i){return r?!0:(m(e,i),!0)}return!1}function g(e,t){e===t?f(e,t):b(e,t)||f(e,t)}function f(e,t){e._state===k&&(e._state=S,e._detail=t,v.async(h,e))}function m(e,t){e._state===k&&(e._state=S,e._detail=t,v.async(Z,e))}function h(e){y(e,e._state=D)}function Z(e){y(e,e._state=A)}var v=e.config,w=(e.configure,t.objectOrFunction),j=t.isFunction,I=(t.now,r.cast),O=o.all,T=i.race,C=n.resolve,x=a.reject,L=s.asap;v.async=L;var k=void 0,S=0,D=1,A=2;l.prototype={constructor:l,_state:void 0,_detail:void 0,_subscribers:void 0,then:function(e,t){var r=this,o=new this.constructor(function(){});if(this._state){var i=arguments;v.async(function(){d(r._state,o,i[r._state-1],r._detail)})}else p(this,o,e,t);return o},"catch":function(e){return this.then(null,e)}},l.all=O,l.cast=I,l.race=T,l.resolve=C,l.reject=x,c.Promise=l}),e("promise/race",["./utils","exports"],function(e,t){function r(e){var t=this;if(!o(e))throw new TypeError("You must pass an array to race.");return new t(function(t,r){for(var o,i=0;i<e.length;i++)o=e[i],o&&"function"==typeof o.then?o.then(t,r):t(o)})}var o=e.isArray;t.race=r}),e("promise/reject",["exports"],function(e){function t(e){var t=this;return new t(function(t,r){r(e)})}e.reject=t}),e("promise/resolve",["exports"],function(e){function t(e){var t=this;return new t(function(t){t(e)})}e.resolve=t}),e("promise/utils",["exports"],function(e){function t(e){return r(e)||"object"==("undefined"==typeof e?"undefined":_typeof(e))&&null!==e}function r(e){return"function"==typeof e}function o(e){return"[object Array]"===Object.prototype.toString.call(e)}var i=Date.now||function(){return(new Date).getTime()};e.objectOrFunction=t,e.isFunction=r,e.isArray=o,e.now=i}),t("promise/polyfill").polyfill()}(),function(e){if("object"===("undefined"==typeof exports?"undefined":_typeof(exports)))module.exports=e();else if("function"==typeof define&&define.amd)define(e);else{var t;try{t=window}catch(r){t=self}t.SparkMD5=e()}}(function(e){var t=function(e,t){return e+t&4294967295},r=function(e,r,o,i,n,a){return r=t(t(r,e),t(i,a)),t(r<<n|r>>>32-n,o)},o=function(e,t,o,i,n,a,s){return r(t&o|~t&i,e,t,n,a,s)},i=function(e,t,o,i,n,a,s){return r(t&i|o&~i,e,t,n,a,s)},n=function(e,t,o,i,n,a,s){return r(t^o^i,e,t,n,a,s)},a=function(e,t,o,i,n,a,s){return r(o^(t|~i),e,t,n,a,s)},s=function(e,r){var s=e[0],c=e[1],l=e[2],u=e[3];s=o(s,c,l,u,r[0],7,-680876936),u=o(u,s,c,l,r[1],12,-389564586),l=o(l,u,s,c,r[2],17,606105819),c=o(c,l,u,s,r[3],22,-1044525330),s=o(s,c,l,u,r[4],7,-176418897),u=o(u,s,c,l,r[5],12,1200080426),l=o(l,u,s,c,r[6],17,-1473231341),c=o(c,l,u,s,r[7],22,-45705983),s=o(s,c,l,u,r[8],7,1770035416),u=o(u,s,c,l,r[9],12,-1958414417),l=o(l,u,s,c,r[10],17,-42063),c=o(c,l,u,s,r[11],22,-1990404162),s=o(s,c,l,u,r[12],7,1804603682),u=o(u,s,c,l,r[13],12,-40341101),l=o(l,u,s,c,r[14],17,-1502002290),c=o(c,l,u,s,r[15],22,1236535329),s=i(s,c,l,u,r[1],5,-165796510),u=i(u,s,c,l,r[6],9,-1069501632),l=i(l,u,s,c,r[11],14,643717713),c=i(c,l,u,s,r[0],20,-373897302),s=i(s,c,l,u,r[5],5,-701558691),u=i(u,s,c,l,r[10],9,38016083),l=i(l,u,s,c,r[15],14,-660478335),c=i(c,l,u,s,r[4],20,-405537848),s=i(s,c,l,u,r[9],5,568446438),u=i(u,s,c,l,r[14],9,-1019803690),l=i(l,u,s,c,r[3],14,-187363961),c=i(c,l,u,s,r[8],20,1163531501),s=i(s,c,l,u,r[13],5,-1444681467),u=i(u,s,c,l,r[2],9,-51403784),l=i(l,u,s,c,r[7],14,1735328473),c=i(c,l,u,s,r[12],20,-1926607734),s=n(s,c,l,u,r[5],4,-378558),u=n(u,s,c,l,r[8],11,-2022574463),l=n(l,u,s,c,r[11],16,1839030562),c=n(c,l,u,s,r[14],23,-35309556),s=n(s,c,l,u,r[1],4,-1530992060),u=n(u,s,c,l,r[4],11,1272893353),l=n(l,u,s,c,r[7],16,-155497632),c=n(c,l,u,s,r[10],23,-1094730640),s=n(s,c,l,u,r[13],4,681279174),u=n(u,s,c,l,r[0],11,-358537222),l=n(l,u,s,c,r[3],16,-722521979),c=n(c,l,u,s,r[6],23,76029189),s=n(s,c,l,u,r[9],4,-640364487),u=n(u,s,c,l,r[12],11,-421815835),l=n(l,u,s,c,r[15],16,530742520),c=n(c,l,u,s,r[2],23,-995338651),s=a(s,c,l,u,r[0],6,-198630844),u=a(u,s,c,l,r[7],10,1126891415),l=a(l,u,s,c,r[14],15,-1416354905),c=a(c,l,u,s,r[5],21,-57434055),s=a(s,c,l,u,r[12],6,1700485571),u=a(u,s,c,l,r[3],10,-1894986606),l=a(l,u,s,c,r[10],15,-1051523),c=a(c,l,u,s,r[1],21,-2054922799),s=a(s,c,l,u,r[8],6,1873313359),u=a(u,s,c,l,r[15],10,-30611744),l=a(l,u,s,c,r[6],15,-1560198380),c=a(c,l,u,s,r[13],21,1309151649),s=a(s,c,l,u,r[4],6,-145523070),u=a(u,s,c,l,r[11],10,-1120210379),l=a(l,u,s,c,r[2],15,718787259),c=a(c,l,u,s,r[9],21,-343485551),e[0]=t(s,e[0]),e[1]=t(c,e[1]),e[2]=t(l,e[2]),e[3]=t(u,e[3])},c=function(e){var t,r=[];for(t=0;64>t;t+=4)r[t>>2]=e.charCodeAt(t)+(e.charCodeAt(t+1)<<8)+(e.charCodeAt(t+2)<<16)+(e.charCodeAt(t+3)<<24);return r},l=function(e){var t,r=[];for(t=0;64>t;t+=4)r[t>>2]=e[t]+(e[t+1]<<8)+(e[t+2]<<16)+(e[t+3]<<24);return r},u=function(e){var t,r,o,i,n,a,l=e.length,u=[1732584193,-271733879,-1732584194,271733878];for(t=64;l>=t;t+=64)s(u,c(e.substring(t-64,t)));for(e=e.substring(t-64),r=e.length,o=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t=0;r>t;t+=1)o[t>>2]|=e.charCodeAt(t)<<(t%4<<3);if(o[t>>2]|=128<<(t%4<<3),t>55)for(s(u,o),t=0;16>t;t+=1)o[t]=0;return i=8*l,i=i.toString(16).match(/(.*?)(.{0,8})$/),n=parseInt(i[2],16),a=parseInt(i[1],16)||0,o[14]=n,o[15]=a,s(u,o),u},d=function(e){var t,r,o,i,n,a,c=e.length,u=[1732584193,-271733879,-1732584194,271733878];for(t=64;c>=t;t+=64)s(u,l(e.subarray(t-64,t)));for(e=c>t-64?e.subarray(t-64):new Uint8Array(0),r=e.length,o=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t=0;r>t;t+=1)o[t>>2]|=e[t]<<(t%4<<3);if(o[t>>2]|=128<<(t%4<<3),t>55)for(s(u,o),t=0;16>t;t+=1)o[t]=0;return i=8*c,i=i.toString(16).match(/(.*?)(.{0,8})$/),n=parseInt(i[2],16),a=parseInt(i[1],16)||0,o[14]=n,o[15]=a,s(u,o),u},p=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],y=function(e){var t,r="";for(t=0;4>t;t+=1)r+=p[e>>8*t+4&15]+p[e>>8*t&15];return r},b=function(e){var t;for(t=0;t<e.length;t+=1)e[t]=y(e[t]);return e.join("")},g=function(e){return b(u(e))},f=function(){this.reset()};return"5d41402abc4b2a76b9719d911017c592"!==g("hello")&&(t=function(e,t){var r=(65535&e)+(65535&t),o=(e>>16)+(t>>16)+(r>>16);return o<<16|65535&r}),f.prototype.append=function(e){return/[\u0080-\uFFFF]/.test(e)&&(e=unescape(encodeURIComponent(e))),this.appendBinary(e),this},f.prototype.appendBinary=function(e){this._buff+=e,this._length+=e.length;var t,r=this._buff.length;for(t=64;r>=t;t+=64)s(this._state,c(this._buff.substring(t-64,t)));return this._buff=this._buff.substr(t-64),this},f.prototype.end=function(e){var t,r,o=this._buff,i=o.length,n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;i>t;t+=1)n[t>>2]|=o.charCodeAt(t)<<(t%4<<3);return this._finish(n,i),r=e?this._state:b(this._state),this.reset(),r},f.prototype._finish=function(e,t){var r,o,i,n=t;if(e[n>>2]|=128<<(n%4<<3),n>55)for(s(this._state,e),n=0;16>n;n+=1)e[n]=0;r=8*this._length,r=r.toString(16).match(/(.*?)(.{0,8})$/),o=parseInt(r[2],16),i=parseInt(r[1],16)||0,e[14]=o,e[15]=i,s(this._state,e)},f.prototype.reset=function(){return this._buff="",this._length=0,this._state=[1732584193,-271733879,-1732584194,271733878],this},f.prototype.destroy=function(){delete this._state,delete this._buff,delete this._length},f.hash=function(e,t){/[\u0080-\uFFFF]/.test(e)&&(e=unescape(encodeURIComponent(e)));var r=u(e);return t?r:b(r)},f.hashBinary=function(e,t){var r=u(e);return t?r:b(r)},f.ArrayBuffer=function(){this.reset()},f.ArrayBuffer.prototype.append=function(e){var t,r=this._concatArrayBuffer(this._buff,e),o=r.length;for(this._length+=e.byteLength,t=64;o>=t;t+=64)s(this._state,l(r.subarray(t-64,t)));return this._buff=o>t-64?r.subarray(t-64):new Uint8Array(0),this},f.ArrayBuffer.prototype.end=function(e){var t,r,o=this._buff,i=o.length,n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;i>t;t+=1)n[t>>2]|=o[t]<<(t%4<<3);return this._finish(n,i),r=e?this._state:b(this._state),this.reset(),r},f.ArrayBuffer.prototype._finish=f.prototype._finish,f.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._state=[1732584193,-271733879,-1732584194,271733878],this},f.ArrayBuffer.prototype.destroy=f.prototype.destroy,f.ArrayBuffer.prototype._concatArrayBuffer=function(e,t){var r=e.length,o=new Uint8Array(r+t.byteLength);return o.set(e),o.set(new Uint8Array(t),r),o},f.ArrayBuffer.hash=function(e,t){var r=d(new Uint8Array(e));return t?r:b(r)},f});var J=jQuery.noConflict(),Zotero={ajax:{},callbacks:{},ui:{callbacks:{},keyCode:{BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38}},url:{},utils:{},offline:{},temp:{},localizations:{},config:{librarySettings:{},baseApiUrl:"https://api.zotero.org",baseWebsiteUrl:"https://zotero.org",baseFeedUrl:"https://api.zotero.org",baseZoteroWebsiteUrl:"https://www.zotero.org",baseDownloadUrl:"https://www.zotero.org",nonparsedBaseUrl:"",debugLogEndpoint:"",storeDebug:!0,directDownloads:!0,proxyPath:"/proxyrequest",ignoreLoggedInStatus:!1,storePrefsRemote:!0,preferUrlItem:!0,sessionAuth:!1,proxy:!1,apiKey:"",apiVersion:3,locale:"en-US",cacheStoreType:"localStorage",preloadCachedLibrary:!0,sortOrdering:{dateAdded:"desc",dateModified:"desc",date:"desc",year:"desc",accessDate:"desc",title:"asc",creator:"asc"},defaultSortColumn:"title",defaultSortOrder:"asc",largeFields:{title:1,abstractNote:1,extra:1},richTextFields:{note:1},maxFieldSummaryLength:{title:60},exportFormats:["bibtex","bookmarks","mods","refer","rdf_bibliontology","rdf_dc","rdf_zotero","ris","wikipedia"],exportFormatsMap:{bibtex:"BibTeX",bookmarks:"Bookmarks",mods:"MODS",refer:"Refer/BibIX",rdf_bibliontology:"Bibliontology RDF",rdf_dc:"Unqualified Dublin Core RDF",rdf_zotero:"Zotero RDF",ris:"RIS",wikipedia:"Wikipedia Citation Templates"},defaultApiArgs:{order:"title",sort:"asc",limit:50,start:0}},debug:function(e,t){var r=3;Zotero.config.storeDebug&&r>=t&&(Zotero.debugstring+="DEBUG:"+e+"\n"),"undefined"!=typeof console&&("number"!=typeof t&&(t=1),void 0!==Zotero.preferences&&(r=Zotero.preferences.getPref("debug_level")),r>=t&&console.log(e))},warn:function(e){Zotero.config.storeDebug&&(Zotero.debugstring+="WARN:"+e+"\n"),"undefined"==typeof console||"undefined"==typeof console.warn?this.debug(e):console.warn(e)},error:function(e){Zotero.config.storeDebug&&(Zotero.debugstring+="ERROR:"+e+"\n"),"undefined"==typeof console||"undefined"==typeof console.error?this.debug(e):console.error(e)},submitDebugLog:function(){Zotero.net.ajax({url:Zotero.config.debugLogEndpoint,data:{debug_string:Zotero.debugstring}}).then(function(e){var t=JSON.parse(e.responseText);t.logID?alert("ZoteroWWW debug logID:"+t.logID):t.error&&alert("Error submitting ZoteroWWW debug log:"+t.error)})},catchPromiseError:function(e){Zotero.error(e)},libraries:{},validator:{patterns:{itemKey:/^.+$/,collectionKey:/^([A-Z0-9]{8,})|trash$/,libraryID:/^[0-9]+$/,libraryType:/^(user|group|)$/,target:/^(items?|collections?|tags|children|deleted|userGroups|key|settings|publications)$/,targetModifier:/^(top|file|file\/view)$/,sort:/^(asc|desc)$/,start:/^[0-9]*$/,limit:/^[0-9]*$/,order:/^\S*$/,content:/^((html|json|data|bib|none|bibtex|bookmarks|coins|csljson|mods|refer|rdf_bibliontology|rdf_dc|ris|tei|wikipedia),?)+$/,include:/^((html|json|data|bib|none|bibtex|bookmarks|coins|csljson|mods|refer|rdf_bibliontology|rdf_dc|ris|tei|wikipedia),?)+$/,q:/^.*$/,fq:/^\S*$/,itemType:/^\S*$/,locale:/^\S*$/,tag:/^.*$/,tagType:/^(0|1)$/,key:/^\S*/,format:/^(json|atom|bib|keys|versions|bibtex|bookmarks|mods|refer|rdf_bibliontology|rdf_dc|rdf_zotero|ris|wikipedia)$/,style:/^\S*$/,linkwrap:/^(0|1)*$/},validate:function(e,t){if(Z.debug("Zotero.validate",4),""===e)return null;if(null===e)return!0;Z.debug(e+" "+t,4);var r=this.patterns;return r.hasOwnProperty(t)?r[t].test(e):null}},_logEnabled:0,enableLogging:function(){Zotero._logEnabled++,Zotero._logEnabled>0},disableLogging:function(){Zotero._logEnabled--,Zotero._logEnabled<=0&&(Zotero._logEnabled=0)},init:function(){var e;e="localStorage"==Zotero.config.cacheStoreType&&"undefined"!=typeof localStorage?localStorage:"sessionStorage"==Zotero.config.cacheStoreType&&"undefined"!=typeof sessionStorage?sessionStorage:{},Zotero.store=e,Zotero.cache=new Zotero.Cache(e),Zotero.preferences=new Zotero.Preferences(Zotero.store,"global");var t="en-US";Zotero.config.locale&&(t=Zotero.config.locale),t="en-US"}};Zotero.Cache=function(e){this.store=e;var t=this.store._registry;(null===t||"undefined"==typeof t)&&(t={},this.store._registry=JSON.stringify(t))},Zotero.Cache.prototype.objectCacheString=function(e){var t=[];Object.keys(e).forEach(function(r){var o=e[r];o&&(Array.isArray(o)?o.forEach(function(e){t.push(r+"/"+encodeURIComponent(e))}):t.push(r+"/"+encodeURIComponent(o)))}),t.sort(),Z.debug(t,4);var r=t.join("/");return r},Zotero.Cache.prototype.save=function(e,t,r){Array.isArray(r)||(r=[]);var o=JSON.parse(this.store._registry);o||(o={});var i=this.objectCacheString(e);this.store[i]=JSON.stringify(t);var n={id:i,saved:Date.now(),cachetags:r};o[i]=n,this.store._registry=JSON.stringify(o)},Zotero.Cache.prototype.load=function(e){Z.debug("Zotero.Cache.load",3);var t=this.objectCacheString(e);Z.debug(t,4);try{var r=this.store[t];return r?JSON.parse(r):(Z.warn("No value found in cache store - "+t,3),null)}catch(o){return Z.error("Error parsing retrieved cache data: "+t+" : "+r),null}},Zotero.Cache.prototype.expireCacheTag=function(e){Z.debug("Zotero.Cache.expireCacheTag",3);var t=JSON.parse(this.store._registry),r=this.store;Object.keys(t).forEach(function(o){var i=t[o];-1!=i.cachetags.indexOf(e)&&(Z.debug("tag "+e+" found for item "+i.id+" : expiring",4),delete r[i.id],delete t[i.id])})},Zotero.Cache.prototype.clear=function(){"function"==typeof this.store.clear?this.store.clear():this.store={}},Zotero.ajaxRequest=function(e,t,r){Z.debug("Zotero.ajaxRequest ==== "+e,3),t||(t="GET"),r||(r={});var o={url:e,type:t};return o=Z.extend({},o,r),Z.debug(o,3),Zotero.net.queueRequest(o)},Zotero.eventmanager={callbacks:{}},Zotero.trigger=function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=arguments.length<=2||void 0===arguments[2]?!1:arguments[2];r&&(Z.debug("filter is not false",3),e+="_"+r),Zotero.debug("Triggering eventful "+e,3),Z.debug(t),t.zeventful=!0,(null===t.triggeringElement||void 0===t.triggeringElement)&&(t.triggeringElement=J("#eventful"));try{if(Zotero.eventmanager.callbacks.hasOwnProperty(e)){var o=Zotero.eventmanager.callbacks[e];o.forEach(function(e){var r=Z.extend({},t,e.data),o={data:r};e.f(o)})}}catch(i){Z.error("failed triggering:"+e),Z.error(i)}},Zotero.listen=function(e,t,r,o){Z.debug("Zotero.listen: "+e);var i=e.split(" ");if(i.length>0&&o)for(var n=0;n<i.length;n++)i[n]+="_"+o;i.forEach(function(e){Zotero.eventmanager.callbacks.hasOwnProperty(e)?Zotero.eventmanager.callbacks[e].push({data:r,f:t}):Zotero.eventmanager.callbacks[e]=[{data:r,f:t}]})};var Z=Zotero;Zotero.ajax.errorCallback=function(e){Z.error(e),Z.debug("ajax error callback",2),Z.debug("textStatus: "+e.textStatus,2),Z.debug("errorThrown: ",2),Z.debug(e.errorThrown,2),Z.debug(e.jqxhr,2)},Zotero.ajax.error=Zotero.ajax.errorCallback,Zotero.ajax.activeRequests=[],Zotero.ajax.apiRequestUrl=function(e){if(Z.debug("Zotero.ajax.apiRequestUrl",4),Z.debug(e,4),Object.keys(e).forEach(function(t){var r=e[t];"string"==typeof r&&(r=r.split("#",1),e[t]=r[0]),Zotero.validator.validate(r,t)===!1&&(Zotero.warn("API argument failed validation: "+t+" cannot be "+r),Zotero.warn(e),delete e[t])}),!e.target)throw new Error("No target defined for api request");if("user"!=e.libraryType&&"group"!=e.libraryType&&""!==e.libraryType)throw new Error("Unexpected libraryType for api request "+JSON.stringify(e));if(e.libraryType&&!e.libraryID)throw new Error("No libraryID defined for api request");if("publications"==e.target&&"user"!=e.libraryType)throw new Error("publications is only valid for user libraries");var t,r=Zotero.config.baseApiUrl;if(""!==e.libraryType){if(t=r+"/"+e.libraryType+"s/"+e.libraryID,e.collectionKey){if("trash"==e.collectionKey)return t+="/items/trash";-1!==e.collectionKey.indexOf(",")||"collections"!=e.target&&(t+="/collections/"+e.collectionKey)}}else t=r;switch(e.target){case"items":t+="/items";break;case"item":t+=e.itemKey?"/items/"+e.itemKey:"/items";break;case"collections":t+="/collections";break;case"childCollections":t+="/collections";break;case"collection":break;case"tags":t+="/tags";break;case"children":t+="/items/"+e.itemKey+"/children";break;case"key":t=r+"/users/"+e.libraryID+"/keys/"+e.apiKey;break;case"deleted":t+="/deleted";break;case"userGroups":t=r+"/users/"+e.libraryID+"/groups";break;case"settings":t+="/settings/"+(e.settingsKey||"");break;case"publications":t+="/publications/items";break;default:return!1}switch(e.targetModifier){case"top":t+="/top";break;case"file":t+="/file";break;case"viewsnapshot":t+="/file/view"}return t},Zotero.ajax.apiQueryString=function(e,t){if(Z.debug("Zotero.ajax.apiQueryString",4),Z.debug(e,4),(null===t||"undefined"==typeof t)&&(t=!0),Object.keys(e).forEach(function(t){var r=e[t];"string"==typeof r&&(r=r.split("#",1),e[t]=r[0])}),e.hasOwnProperty("order")&&"creatorSummary"==e.order&&(e.order="creator"),e.hasOwnProperty("order")&&"year"==e.order&&(e.order="date"),t&&Zotero.config.sessionAuth){var r=Zotero.utils.readCookie(Zotero.config.sessionCookieName);e.session=r}else t&&Zotero.config.apiKey&&(e.key=Zotero.config.apiKey);e.hasOwnProperty("sort")&&"undefined"==e.sort&&(e.sort="asc"),Z.debug(e,4);var o="?",i=[],n=["start","limit","order","sort","content","include","format","q","fq","itemType","itemKey","collectionKey","searchKey","locale","tag","tagType","key","style","linkMode","linkwrap","session","newer","since"];n.sort();var a={};return n.forEach(function(t){e.hasOwnProperty(t)&&""!==e[t]&&(a[t]=e[t])}),e.hasOwnProperty("target")&&"items"!==e.target&&a.hasOwnProperty("itemKey")&&-1==a.itemKey.indexOf(",")&&delete a.itemKey,e.hasOwnProperty("target")&&"collections"!==e.target&&a.hasOwnProperty("collectionKey")&&-1===a.collectionKey.indexOf(",")&&delete a.collectionKey,Object.keys(a).forEach(function(e){var t=a[e];Array.isArray(t)?t.forEach(function(t){"tag"==e&&"-"==t[0]&&(t="\\"+t),i.push(encodeURIComponent(e)+"="+encodeURIComponent(t))}):("tag"==e&&"-"==t[0]&&(t="\\"+t),i.push(encodeURIComponent(e)+"="+encodeURIComponent(t)))}),o+=i.join("&")},Zotero.ajax.apiRequestString=function(e){return Zotero.ajax.apiRequestUrl(e)+Zotero.ajax.apiQueryString(e)},Zotero.ajax.proxyWrapper=function(e,t){return Zotero.config.proxy?(t||(t="GET"),Zotero.config.proxyPath+"?requestMethod="+t+"&requestUrl="+encodeURIComponent(e)):e},Zotero.ajax.parseQueryString=function(e){},Zotero.ajax.webUrl=function(e){},Zotero.ajax.downloadBlob=function(e){return new Promise(function(t,r){var o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType="blob",o.addEventListener("load",function(){200===o.status?(Z.debug("downloadBlob Image retrieved. resolving",3),t(o.response)):r(o.response)}),o.send()})},Zotero.ApiObject=function(){this.instance="Zotero.ApiObject",this.version=0},Zotero.ApiObject.prototype.associateWithLibrary=function(e){var t=this;return t.owningLibrary=e,"object"==_typeof(this.apiObj.library)&&(this.apiObj.library.type=e.type,this.apiObj.library.id=e.libraryID),t},Zotero.ApiObject.prototype.fieldComparer=function(e){if(window.Intl){var t=new window.Intl.Collator;return function(r,o){return t.compare(r.apiObj.data[e],o.apiObj.data[e])}}return function(t,r){return t.apiObj.data[e].toLowerCase()==r.apiObj.data[e].toLowerCase()?0:t.apiObj.data[e].toLowerCase()<r.apiObj.data[e].toLowerCase()?-1:1}},Zotero.ApiResponse=function(e){Z.debug("Zotero.ApiResponse",3),this.totalResults=0,this.apiVersion=null,this.lastModifiedVersion=0,this.linkHeader="",this.links={},e&&(e.isError?this.isError=!0:this.isError=!1,this.data=e.data,this.parseResponse(e))},Zotero.ApiResponse.prototype.parseResponse=function(e){Z.debug("parseResponse");var t=this;if(t.jqxhr=e.jqxhr,t.status=e.jqxhr.status,t.lastModifiedVersion=e.jqxhr.getResponseHeader("Last-Modified-Version"),t.apiVersion=e.jqxhr.getResponseHeader("Zotero-API-Version"),t.backoff=e.jqxhr.getResponseHeader("Backoff"),t.retryAfter=e.jqxhr.getResponseHeader("Retry-After"),t.contentType=e.jqxhr.getResponseHeader("Content-Type"),t.linkHeader=e.jqxhr.getResponseHeader("Link"),t.totalResults=e.jqxhr.getResponseHeader("Total-Results"),t.backoff&&(t.backoff=parseInt(t.backoff,10)),t.retryAfter&&(t.retryAfter=parseInt(t.retryAfter,10)),Z.debug("parse link header"),Z.debug(t.linkHeader),t.linkHeader){for(var r=t.linkHeader.split(","),o={},i=/^<([^>]+)>; rel="([^\"]*)"$/,n=0;n<r.length;n++){var a=i.exec(r[n].trim());a[2]&&(o[a[2]]=a[1])}t.parsedLinks=o}Z.debug("done parsing response")},Zotero.Net=function(){this.deferredQueue=[],this.numRunning=0,this.numConcurrent=3,this.backingOff=!1},Zotero.Net.prototype.queueDeferred=function(){var e=this,t=new J.Deferred;return e.deferredQueue.push(t),Promise.resolve(t)},Zotero.Net.prototype.queueRequest=function(e){Z.debug("Zotero.Net.queueRequest",3);var t,r=this;return t=Array.isArray(e)?r.queueDeferred().then(function(){return Z.debug("running sequential after queued deferred resolved",4),r.runSequential(e)}).then(function(e){return Z.debug("runSequential done",3),r.queuedRequestDone(),e}):r.queueDeferred().then(function(){return Z.debug("running concurrent after queued deferred resolved",4),r.runConcurrent(e)}).then(function(e){return Z.debug("done with queuedRequest"),r.queuedRequestDone(),e}),r.runNext(),t["catch"](function(e){Z.error("Error before leaving Zotero.Net"),Z.error(e)})},Zotero.Net.prototype.runConcurrent=function(e){return Z.debug("Zotero.Net.runConcurrent",3),this.ajaxRequest(e).then(function(e){return Z.debug("done with runConcurrent request"),e})},Zotero.Net.prototype.runSequential=function(e){Z.debug("Zotero.Net.runSequential",3);for(var t=this,r=[],o=Promise.resolve(),i=0;i<e.length;i++){var n=e[i];o=o.then(function(){var e=t.ajaxRequest(n).then(function(e){Z.debug("pushing sequential response into result array"),r.push(e)});return e})}return o.then(function(){return Z.debug("done with sequential aggregator promise - returning responses"),r})},Zotero.Net.prototype.individualRequestDone=function(e){Z.debug("Zotero.Net.individualRequestDone",3);var t=this,r=t.checkDelay(e);if(r>0){var o=1e3*r;t.backingOff=!0;var i=Date.now()+o;i>t.waitingExpires&&(t.waitingExpires=i),window.setTimeout(t.runNext,o)}return e},Zotero.Net.prototype.queuedRequestDone=function(e){Z.debug("queuedRequestDone",3);var t=this;return t.numRunning--,t.runNext(),e},Zotero.Net.prototype.runNext=function(){Z.debug("Zotero.Net.runNext",3);var e=this,t=Date.now();if(e.backingOff&&e.waitingExpires>t-100){Z.debug("currently backing off",3);var r=e.waitingExpires-t;return void window.setTimeout(e.runNext,r)}for(e.backingOff&&e.waitingExpires<=t-100&&(e.backingOff=!1),Z.debug(e.numRunning+"/"+e.numConcurrent+" Running. "+e.deferredQueue.length+" queued.",3);e.deferredQueue.length>0&&e.numRunning<e.numConcurrent;){e.numRunning++;var o=e.deferredQueue.shift();o.resolve(),Z.debug(e.numRunning+"/"+e.numConcurrent+" Running. "+e.deferredQueue.length+" queued.",3)}},Zotero.Net.prototype.checkDelay=function(e){Z.debug("Zotero.Net.checkDelay"),Z.debug(e);var t=this,r=0;if(Array.isArray(e))for(var o=0;o<e.length;o++){var i=t.checkDelay(e[o]);i>r&&(r=i)}else 429==e.status?r=e.retryAfter:e.backoff&&(r=e.backoff);return r},Zotero.Net.prototype.ajaxRequest=function(e){Z.debug("Zotero.Net.ajaxRequest",3);var t=this,r={type:"GET",headers:{"Zotero-API-Version":Zotero.config.apiVersion,"Content-Type":"application/json"},success:function(e){return e},error:function(e){return Z.error("ajaxRequest rejected:"+e.jqxhr.status+" - "+e.jqxhr.responseText),e}},o=Z.extend({},r.headers,e.headers),i=Z.extend({},r,e);if(i.headers=o,"object"==_typeof(i.url)&&(i.url=Zotero.ajax.apiRequestString(i.url)),i.url=Zotero.ajax.proxyWrapper(i.url,i.type),!i.url)throw"No url specified in Zotero.Net.ajaxRequest";i.zsuccess=i.success,i.zerror=i.error,delete i.success,delete i.error,Z.debug("AJAX config"),Z.debug(i);var n=new Promise(function(e,r){t.ajax(i).then(function(t){var r;switch(t.responseType){case"json":case"":try{r=JSON.parse(t.response)}catch(o){r=t.response}break;case"text":default:r=t.response}var i=new Zotero.ApiResponse({jqxhr:t,data:r,textStatus:t.responseText});e(i)},function(e){var t=new Zotero.ApiResponse({jqxhr:e,textStatus:e.responseText,isError:!0});r(t)})}).then(t.individualRequestDone.bind(t)).then(function(e){if(e.isError)throw Z.error("re-throwing ApiResponse that was a rejection"),e;return e}).then(i.zsuccess,i.zerror);return n},Zotero.Net.prototype.ajax=function(e){e=Zotero.extend({type:"GET"},e);var t=new Promise(function(t,r){var o=new XMLHttpRequest,i=e.url;o.open(e.type,i),e.headers&&Object.keys(e.headers).forEach(function(t){var r=e.headers[t];o.setRequestHeader(t,r)}),o.send(e.data),o.onload=function(){Z.debug("XMLHttpRequest done"),Z.debug(o),o.status>=200&&o.status<300?(Z.debug("200-300 response: resolving Net.ajax promise"),t(o)):(Z.debug("not 200-300 response: rejecting Net.ajax promise"),r(o))},o.onerror=function(){r(o)}});return t},Zotero.net=new Zotero.Net,Zotero.Library=function(e,t,r,o){Z.debug("Zotero.Library constructor",3),Z.debug("Library Constructor: "+e+" "+t+" ",3);var i=this;if(Z.debug(r,4),i.instance="Zotero.Library",i.libraryVersion=0,i.syncState={earliestVersion:null,latestVersion:null},i._apiKey=o||"",Zotero.config.librarySettings?i.libraryBaseWebsiteUrl=Zotero.config.librarySettings.libraryPathString:(i.libraryBaseWebsiteUrl=Zotero.config.baseWebsiteUrl,"group"==e&&(i.libraryBaseWebsiteUrl+="groups/"),r?this.libraryBaseWebsiteUrl+=r+"/items":Z.warn("no libraryUrlIdentifier specified")),i.items=new Zotero.Items,i.items.owningLibrary=i,i.itemKeys=[],i.collections=new Zotero.Collections,i.collections.libraryUrlIdentifier=i.libraryUrlIdentifier,i.collections.owningLibrary=i,i.tags=new Zotero.Tags,i.searches=new Zotero.Searches,i.searches.owningLibrary=i,i.groups=new Zotero.Groups,i.groups.owningLibrary=i,i.deleted=new Zotero.Deleted,i.deleted.owningLibrary=i,!e)return void Z.warn("No type specified for library");i.type=e,i.libraryType=e,i.libraryID=t,i.libraryString=Zotero.utils.libraryString(i.libraryType,i.libraryID),i.libraryUrlIdentifier=r,i.preferences=new Zotero.Preferences(Zotero.store,i.libraryString);var n=navigator.userAgent.indexOf("Chrome")>-1,a=(navigator.userAgent.indexOf("MSIE")>-1,navigator.userAgent.indexOf("Firefox")>-1,navigator.userAgent.indexOf("Safari")>-1),s=navigator.userAgent.toLowerCase().indexOf("op")>-1;if(n&&a&&(a=!1),n&&s&&(n=!1),a&&(Zotero.config.useIndexedDB=!1,Zotero.warn("Safari detected; disabling indexedDB")),Zotero.config.useIndexedDB===!0){Z.debug("Library Constructor: indexedDB init",3);var c=new Zotero.Idb.Library(i.libraryString);c.owningLibrary=this,i.idbLibrary=c,c.init().then(function(){if(Z.debug("Library Constructor: idbInitD Done",3),Zotero.config.preloadCachedLibrary===!0){Z.debug("Library Constructor: preloading cached library",3);var e=i.loadIndexedDBCache();e.then(function(){Z.debug("Library Constructor: Library.items.itemsVersion: "+i.items.itemsVersion,3),Z.debug("Library Constructor: Library.collections.collectionsVersion: "+i.collections.collectionsVersion,3),Z.debug("Library Constructor: Library.tags.tagsVersion: "+i.tags.tagsVersion,3),Z.debug("Library Constructor: Triggering cachedDataLoaded",3),i.trigger("cachedDataLoaded")},function(e){throw Z.error("Error loading cached library"),Z.error(e),new Error("Error loading cached library")})}else i.trigger("cachedDataLoaded")},function(){Zotero.config.useIndexedDB=!1,i.trigger("indexedDBError"),i.trigger("cachedDataLoaded"),Z.error("Error initializing indexedDB. Promise rejected.")})}i.dirty=!1,i.tagsChanged=function(){},i.collectionsChanged=function(){},i.itemsChanged=function(){}},Zotero.Library.prototype.sortableColumns=["title","creator","itemType","date","year","publisher","publicationTitle","journalAbbreviation","language","accessDate","libraryCatalog","callNumber","rights","dateAdded","dateModified","addedBy"],
Zotero.Library.prototype.displayableColumns=["title","creator","itemType","date","year","publisher","publicationTitle","journalAbbreviation","language","accessDate","libraryCatalog","callNumber","rights","dateAdded","dateModified","numChildren","addedBy"],Zotero.Library.prototype.groupOnlyColumns=["addedBy"],Zotero.Library.prototype.comparer=function(){return window.Intl?(new window.Intl.Collator).compare:function(e,t){return e.toLocaleLowerCase()==t.toLocaleLowerCase()?0:e.toLocaleLowerCase()<t.toLocaleLowerCase()?-1:1}},Zotero.Library.prototype.ajaxRequest=function(e,t,r){Z.debug("Library.ajaxRequest",3),t||(t="GET"),r||(r={});var o={url:e,type:t};return o=Z.extend({},o,r),Z.debug(o,3),Zotero.net.queueRequest(o)},Zotero.Library.prototype.sequentialRequests=function(e){Z.debug("Zotero.Library.sequentialRequests",3);return Zotero.net.queueRequest(e)},Zotero.Library.prototype.websiteUrl=function(e){Z.debug("Zotero.library.websiteUrl",3),Z.debug(e,4);var t=this,r=[];Object.keys(e).forEach(function(t){var o=e[t];""!==o&&r.push(t+"/"+o)}),r.sort(),Z.debug(r,4);var o=r.join("/");return t.libraryBaseWebsiteUrl+"/"+o},Zotero.Library.prototype.synchronize=function(){},Zotero.Library.prototype.loadUpdatedItems=function(){Z.debug("Zotero.Library.loadUpdatedItems",3);var e=this,t=e.libraryVersion?e.libraryVersion:e.items.itemsVersion;return Promise.resolve(e.updatedVersions("items",t)).then(function(t){Z.debug("itemVersions resolved",3),Z.debug("items Last-Modified-Version: "+t.lastModifiedVersion,3),e.items.updateSyncState(t.lastModifiedVersion);var r=t.data;e.itemVersions=r;var o=[];return Object.keys(r).forEach(function(t){var i=r[t],n=e.items.getItem(t);n&&n.apiObj.key==i||o.push(t)}),e.loadItemsFromKeys(o)}).then(function(t){Z.debug("loadItemsFromKeys resolved",3),e.items.updateSyncedVersion();var r=Zotero.state.getUrlVars();if(e.buildItemDisplayView(r),Zotero.config.useIndexedDB){e.idbLibrary.updateItems(e.items.objectArray)}})},Zotero.Library.prototype.loadUpdatedCollections=function(){Z.debug("Zotero.Library.loadUpdatedCollections",3);var e=this;Z.debug("library.collections.collectionsVersion:"+e.collections.collectionsVersion);var t=e.libraryVersion?e.libraryVersion:e.collections.collectionsVersion;return e.updatedVersions("collections",t).then(function(t){Z.debug("collectionVersions finished",3),Z.debug("Collections Last-Modified-Version: "+t.lastModifiedVersion,3),e.collections.updateSyncState(t.lastModifiedVersion);var r=t.data;e.collectionVersions=r;var o=[];return Object.keys(r).forEach(function(t){var i=r[t],n=e.collections.getCollection(t);n&&n.apiObj.version==i||o.push(t)}),0===o.length?(Z.debug("No collectionKeys need updating. resolving",3),t):(Z.debug("fetching collections by key",3),e.loadCollectionsFromKeys(o).then(function(){var t=e.collections;t.initSecondaryData(),Z.debug("All updated collections loaded",3),e.collections.updateSyncedVersion();Zotero.state.getUrlVars();return Z.debug("loadUpdatedCollections complete - saving collections to cache before resolving",3),Z.debug("collectionsVersion: "+e.collections.collectionsVersion,3),Zotero.config.useIndexedDB?e.idbLibrary.updateCollections(t.collectionsArray):void 0}))}).then(function(){return Z.debug("done getting collection data. requesting deleted data",3),e.getDeleted(e.libraryVersion)}).then(function(t){Z.debug("got deleted collections data: removing local copies",3),Z.debug(e.deleted),e.deleted.deletedData.collections&&e.deleted.deletedData.collections.length>0&&e.collections.removeLocalCollections(e.deleted.deletedData.collections)})},Zotero.Library.prototype.loadUpdatedTags=function(){Z.debug("Zotero.Library.loadUpdatedTags",3);var e=this;return Z.debug("tagsVersion: "+e.tags.tagsVersion,3),Promise.resolve(e.loadAllTags({since:e.tags.tagsVersion})).then(function(){return Z.debug("done getting tags, request deleted tags data",3),e.getDeleted(e.libraryVersion)}).then(function(t){if(Z.debug("got deleted tags data"),e.deleted.deletedData.tags&&e.deleted.deletedData.tags.length>0&&e.tags.removeTags(e.deleted.deletedData.tags),Zotero.config.useIndexedDB){Z.debug("saving updated tags to IDB",3);e.idbLibrary.updateTags(e.tags.tagsArray)}})},Zotero.Library.prototype.getDeleted=function(e){Z.debug("Zotero.Library.getDeleted",3);var t=this,r={target:"deleted",libraryType:t.libraryType,libraryID:t.libraryID,since:e};return t.deleted.pending?(Z.debug("getDeleted resolving with previously pending promise"),Promise.resolve(t.deleted.pendingPromise)):(Z.debug("version:"+e),Z.debug("sinceVersion:"+t.deleted.sinceVersion),Z.debug("untilVersion:"+t.deleted.untilVersion),t.deleted.untilVersion&&e>=t.deleted.sinceVersion?(Z.debug("deletedVersion matches requested: immediately resolving"),Promise.resolve(t.deleted.deletedData)):(t.deleted.pending=!0,t.deleted.pendingPromise=t.ajaxRequest(r).then(function(r){Z.debug("got deleted response"),t.deleted.deletedData=r.data,Z.debug("Deleted Last-Modified-Version:"+r.lastModifiedVersion,3),t.deleted.untilVersion=r.lastModifiedVersion,t.deleted.sinceVersion=e}).then(function(e){Z.debug("cleaning up deleted pending"),t.deleted.pending=!1,t.deleted.pendingPromise=!1}),t.deleted.pendingPromise))},Zotero.Library.prototype.processDeletions=function(e){var t=this;t.collections.processDeletions(e.collections),t.items.processDeletions(e.items)},Zotero.Library.prototype.loadFullBib=function(e,t){var r=this,o=e.join(","),i={target:"items",libraryType:r.libraryType,libraryID:r.libraryID,itemKey:o,format:"bib",linkwrap:"1"};1==e.length&&(i.target="item"),t&&(i.style=t);var n=r.ajaxRequest(i).then(function(e){return e.data});return n},Zotero.Library.prototype.loadItemBib=function(e,t){Z.debug("Zotero.Library.loadItemBib",3);var r=this,o={target:"item",libraryType:r.libraryType,libraryID:r.libraryID,itemKey:e,content:"bib"};t&&(o.style=t);var i=r.ajaxRequest(o).then(function(e){var t=new Zotero.Item(e.data),r=t.apiObj.bib;return r});return i},Zotero.Library.prototype.loadSettings=function(){Z.debug("Zotero.Library.loadSettings",3);var e=this,t={target:"settings",libraryType:e.libraryType,libraryID:e.libraryID};return e.ajaxRequest(t).then(function(t){var r;if(r="string"==typeof t.data?JSON.parse(t.data):t.data,e.preferences.setPref("settings",r),r.tagColors){var o=r.tagColors.value;e.preferences.setPref("tagColors",o)}return e.trigger("settingsLoaded"),e.preferences})},Zotero.Library.prototype.matchColoredTags=function(e){var t,r=this,o=r.preferences.getPref("tagColors");if(!o)return[];var i={};for(t=0;t<o.length;t++)i[o[t].name.toLowerCase()]=o[t].color;var n=[];for(t=0;t<e.length;t++)i.hasOwnProperty(e[t])&&n.push(i[e[t]]);return n},Zotero.Library.prototype.sendToLibrary=function(e,t){for(var r=[],o=0;o<e.length;o++){var i=e[o],n=i.emptyJsonItem();n.data=Z.extend({},e[o].apiObj.data),n.data.key="",n.data.version=0,n.data.collections=[],delete n.data.dateModified,delete n.data.dateAdded;var a=new Zotero.Item(n);a.pristine=Z.extend({},a.apiObj),a.initSecondaryData(),a.apiObj.data.relations||(a.apiObj.data.relations={}),a.apiObj.data.relations["owl:sameAs"]=Zotero.url.relationUrl(i.owningLibrary.libraryType,i.owningLibrary.libraryID,i.key),r.push(a)}return t.items.writeItems(r)},Zotero.Library.prototype.updatedVersions=function(){var e=arguments.length<=0||void 0===arguments[0]?"items":arguments[0],t=arguments.length<=1||void 0===arguments[1]?this.libraryVersion:arguments[1];Z.debug("Library.updatedVersions",3);var r=this,o={target:e,format:"versions",libraryType:r.libraryType,libraryID:r.libraryID,since:t};return r.ajaxRequest(o)},Zotero.Library.prototype.loadItemsFromKeys=function(e){Zotero.debug("Zotero.Library.loadItemsFromKeys",3);var t=this;return t.loadFromKeys(e,"items")},Zotero.Library.prototype.loadCollectionsFromKeys=function(e){Zotero.debug("Zotero.Library.loadCollectionsFromKeys",3);var t=this;return t.loadFromKeys(e,"collections")},Zotero.Library.prototype.loadSeachesFromKeys=function(e){Zotero.debug("Zotero.Library.loadSearchesFromKeys",3);var t=this;return t.loadFromKeys(e,"searches")},Zotero.Library.prototype.loadFromKeys=function(e,t){Zotero.debug("Zotero.Library.loadFromKeys",3),t||(t="items");for(var r=this,o=[];e.length>0;)o.push(e.splice(0,50));var i=[];o.forEach(function(e){var o=e.join(",");switch(t){case"items":i.push({url:{target:"items",targetModifier:null,itemKey:o,limit:50,libraryType:r.libraryType,libraryID:r.libraryID},type:"GET",success:r.processLoadedItems.bind(r)});break;case"collections":i.push({url:{target:"collections",targetModifier:null,collectionKey:o,limit:50,libraryType:r.libraryType,libraryID:r.libraryID},type:"GET",success:r.processLoadedCollections.bind(r)});break;case"searches":i.push({url:{target:"searches",targetModifier:null,searchKey:o,limit:50,libraryType:r.libraryType,libraryID:r.libraryID},type:"GET"})}});for(var n=[],a=0;a<i.length;a++)n.push(Zotero.net.queueRequest(i[a]));return Promise.all(n)},Zotero.Library.prototype.buildItemDisplayView=function(e){Z.debug("Zotero.Library.buildItemDisplayView",3),Z.debug(e,4);var t=this;if(!t.idbLibrary.db)return Promise.resolve([]);var r=[];e.collectionKey?"trash"==e.collectionKey?r.push(t.idbLibrary.filterItems("deleted",1)):r.push(t.idbLibrary.filterItems("collectionKeys",e.collectionKey)):r.push(t.idbLibrary.getOrderedItemKeys("title"));var o=e.tag||[];"string"==typeof o&&(o=[o]);for(var i=0;i<o.length;i++)Z.debug("adding selected tag filter",3),r.push(t.idbLibrary.filterItems("itemTagStrings",o[i]));return Promise.all(r).then(function(r){var o;for(o=0;o<r.length;o++)Z.debug("result from filterPromise: "+r[o].length,3),Z.debug(r[o],3);var i=t.idbLibrary.intersectAll(r),n=t.items.getItems(i);Z.debug("All filters applied - Down to "+n.length+" items displayed",3),Z.debug("remove child items and, if not viewing trash, deleted items",3);var a=[];for(o=0;o<n.length;o++)n[o].apiObj.data.parentItem||"trash"!=e.collectionKey&&n[o].apiObj.deleted||a.push(n[o]);var s=e.order||"title",c=e.sort||"asc";Z.debug("Sorting by "+s+" - "+c,3);var l=Zotero.Library.prototype.comparer();return a.sort(function(e,t){var r=e.get(s),o=t.get(s);return l(r,o)}),"desc"==c&&(Z.debug("sort is desc - reversing array",4),a.reverse()),Z.debug("triggering publishing displayedItemsUpdated",3),t.trigger("displayedItemsUpdated"),a})},Zotero.Library.prototype.trigger=function(e,t){var r=this;Zotero.trigger(e,t,r.libraryString)},Zotero.Library.prototype.listen=function(e,t,r){var o=this,i=o.libraryString;Zotero.listen(e,t,r,i)},Zotero.Container=function(){},Zotero.Container.prototype.initSecondaryData=function(){},Zotero.Container.prototype.addObject=function(e){Zotero.debug("Zotero.Container.addObject",4);var t=this;return t.objectArray.push(e),t.objectMap[e.key]=e,t.owningLibrary&&e.associateWithLibrary(t.owningLibrary),t},Zotero.Container.prototype.fieldComparer=function(e){if(window.Intl){var t=new window.Intl.Collator;return function(r,o){return t.compare(r.apiObj.data[e],o.apiObj.data[e])}}return function(t,r){return t.apiObj.data[e].toLowerCase()==r.apiObj.data[e].toLowerCase()?0:t.apiObj.data[e].toLowerCase()<r.apiObj.data[e].toLowerCase()?-1:1}},Zotero.Container.prototype.getObject=function(e){var t=this;return t.objectMap.hasOwnProperty(e)?t.objectMap[e]:!1},Zotero.Container.prototype.getObjects=function(e){for(var t,r=this,o=[],i=0;i<e.length;i++)t=r.getObject(e[i]),t&&o.push(t);return o},Zotero.Container.prototype.removeObject=function(e){var t=this;t.objectMap.hasOwnProperty(e)&&(delete t.objectmap[e],t.initSecondaryData())},Zotero.Container.prototype.removeObjects=function(e){for(var t=this,r=0;r<e.length;r++)delete t.objectMap[e[r]];t.initSecondaryData()},Zotero.Container.prototype.writeObjects=function(e){},Zotero.Container.prototype.assignKeys=function(e){for(var t,r=0;r<e.length;r++){t=e[r];var o=t.get("key");if(!o){var i=Zotero.utils.getKey();t.set("key",i),t.set("version",0)}}return e},Zotero.Container.prototype.chunkObjectsArray=function(e){for(var t=50,r=[],o=0;o<e.length;o+=t)r.push(e.slice(o,o+t));return r},Zotero.Container.prototype.rawChunks=function(e){for(var t=[],r=0;r<e.length;r++){t[r]=[];for(var o=0;o<e[r].length;o++)t[r].push(e[r][o].writeApiObj())}return t},Zotero.Container.prototype.updateSyncState=function(e){var t=this;if(Z.debug("updateSyncState: "+e,3),!t.hasOwnProperty("syncState"))throw Z.debug("no syncState property"),new Error("Attempt to update sync state of object with no syncState property");null===t.syncState.earliestVersion&&(t.syncState.earliestVersion=e),null===t.syncState.latestVersion&&(t.syncState.latestVersion=e),e<t.syncState.earliestVersion&&(t.syncState.earliestVersion=e),e>t.syncState.latestVersion&&(t.syncState.latestVersion=e),Z.debug("done updating sync state",3)},Zotero.Container.prototype.updateSyncedVersion=function(e){var t=this;null!==t.syncState.earliestVersion&&t.syncState.earliestVersion==t.syncState.latestVersion?(t.version=t.syncState.latestVersion,t.synced=!0):null!==t.syncState.earliestVersion&&(t.version=t.syncState.earliestVersion)},Zotero.Container.prototype.processDeletions=function(e){for(var t=this,r=0;r<e.length;r++){var o=t.get(e[r]);o!==!1&&o.synced===!0&&t.removeObjects([e[r]])}},Zotero.Container.prototype.updateObjectsFromWriteResponse=function(e,t){Z.debug("Zotero.Container.updateObjectsFromWriteResponse",3),Z.debug("statusCode: "+t.status,3);var r=t.data;200==t.status?(Z.debug("newLastModifiedVersion: "+t.lastModifiedVersion,3),r.hasOwnProperty("success")&&Object.keys(r.success).forEach(function(o){var i=parseInt(o,10),n=r.success[o],a=e[i];if(""!==a.key&&a.key!==n)throw new Error("object key mismatch in multi-write response");""===a.key&&a.updateObjectKey(n),a.set("version",t.lastModifiedVersion),a.synced=!0,a.writeFailure=!1}),r.hasOwnProperty("failed")&&(Z.debug("updating objects with failed writes",3),Object.keys(r.failed).forEach(function(t){var o=r.failed[t];Z.error("failed write "+t+" - "+o);var i=parseInt(t,10),n=e[i];n.writeFailure=o}))):204==t.status&&(e[0].synced=!0)},Zotero.Container.prototype.extractKey=function(e){return"string"==typeof e?e:e.get("key")},Zotero.Collections=function(e){this.instance="Zotero.Collections",this.version=0,this.syncState={earliestVersion:null,latestVersion:null},this.collectionObjects={},this.collectionsArray=[],this.objectMap=this.collectionObjects,this.objectArray=this.collectionsArray,this.dirty=!1,this.loaded=!1,e&&(this.addCollectionsFromJson(e),this.initSecondaryData())},Zotero.Collections.prototype=new Zotero.Container,Zotero.Collections.prototype.initSecondaryData=function(){Z.debug("Zotero.Collections.initSecondaryData",3);var e=this;e.collectionsArray=[],Object.keys(e.collectionObjects).forEach(function(t){var r=e.collectionObjects[t];e.collectionsArray.push(r)}),e.collectionsArray.sort(Zotero.ApiObject.prototype.fieldComparer("name")),e.nestCollections(),e.assignDepths(0,e.collectionsArray)},Zotero.Collections.prototype.addCollection=function(e){return this.addObject(e),this},Zotero.Collections.prototype.addCollectionsFromJson=function(e){Z.debug("addCollectionsFromJson"),Z.debug(e);var t=this,r=[];return e.forEach(function(e){var o=new Zotero.Collection(e);t.addObject(o),r.push(o)}),r},Zotero.Collections.prototype.assignDepths=function(e,t){Z.debug("Zotero.Collections.assignDepths",3);var r=this,o=function i(e,t){t.forEach(function(t){t.nestingDepth=e,t.hasChildren&&i(e+1,t.children)})};r.collectionsArray.forEach(function(e){e.topLevel&&(e.nestingDepth=1,e.hasChildren&&o(2,e.children))})},Zotero.Collections.prototype.nestedOrderingArray=function(){Z.debug("Zotero.Collections.nestedOrderingArray",3);var e=this,t=[],r=function o(e,t){t.forEach(function(t){e.push(t),t.hasChildren&&o(e,t.children)})};return e.collectionsArray.forEach(function(e){e.topLevel&&(t.push(e),e.hasChildren&&r(t,e.children))}),Z.debug("Done with nestedOrderingArray",3),t},Zotero.Collections.prototype.getCollection=function(e){return this.getObject(e)},Zotero.Collections.prototype.remoteDeleteCollection=function(e){var t=this;return t.removeLocalCollection(e)},Zotero.Collections.prototype.removeLocalCollection=function(e){var t=this;return t.removeLocalCollections([e])},Zotero.Collections.prototype.removeLocalCollections=function(e){for(var t=this,r=0;r<e.length;r++)delete t.collectionObjects[e[r]];t.initSecondaryData()},Zotero.Collections.prototype.nestCollections=function(){var e=this;e.collectionsArray.forEach(function(e){e.children=[]}),e.collectionsArray.sort(Zotero.ApiObject.prototype.fieldComparer("name")),e.collectionsArray.forEach(function(t){t.nestCollection(e.collectionObjects)})},Zotero.Collections.prototype.writeCollections=function(e){Z.debug("Zotero.Collections.writeCollections",3);var t,r=this,o=r.owningLibrary,i={target:"collections",libraryType:r.owningLibrary.libraryType,libraryID:r.owningLibrary.libraryID},n=Zotero.ajax.apiRequestString(i);for(t=0;t<e.length;t++){var a=e[t],s=a.get("key");if(""===s||null===s){var c=Zotero.utils.getKey();a.set("key",c),a.set("version",0)}}var l=r.chunkObjectsArray(e),u=r.rawChunks(l),d=function(e){Z.debug("writeCollections successCallback",3);var t=this.library,r=this.writeChunk;t.collections.updateObjectsFromWriteResponse(this.writeChunk,e);for(var o=0;o<r.length;o++){var i=r[o];i.synced&&!i.writeFailure&&(t.collections.addCollection(i),Zotero.config.useIndexedDB&&(Z.debug("updating indexedDB collections"),t.idbLibrary.updateCollections(r)))}return e.returnCollections=r,e};Z.debug("collections.version: "+r.version,3),Z.debug("collections.libraryVersion: "+r.libraryVersion,3);var p=[];for(t=0;t<l.length;t++){var y={writeChunk:l[t],library:o},b=JSON.stringify(u[t]);p.push({url:n,type:"POST",data:b,processData:!1,headers:{},success:d.bind(y)})}return o.sequentialRequests(p).then(function(e){return Z.debug("Done with writeCollections sequentialRequests promise",3),r.initSecondaryData(),e.forEach(function(e){if(e.isError||e.data.hasOwnProperty("failed")&&Object.keys(e.data.failed).length>0)throw new Error("failure when writing collections")}),e})["catch"](function(e){throw Z.error(e),e})},Zotero.Items=function(e){this.instance="Zotero.Items",this.itemsVersion=0,this.syncState={earliestVersion:null,latestVersion:null},this.itemObjects={},this.objectMap=this.itemObjects,this.objectArray=[],this.unsyncedItemKeys=[],e&&this.addItemsFromJson(e)},Zotero.Items.prototype=new Zotero.Container,Zotero.Items.prototype.getItem=function(e){return this.getObject(e)},Zotero.Items.prototype.getItems=function(e){return this.getObjects(e)},Zotero.Items.prototype.addItem=function(e){return this.addObject(e),this},Zotero.Items.prototype.addItemsFromJson=function(e){Z.debug("addItemsFromJson",3);var t=this,r=e,o=[];return Z.debug("looping"),r.forEach(function(e){Z.debug("creating new Item");var r=new Zotero.Item(e);t.addItem(r),o.push(r)}),o},Zotero.Items.prototype.removeLocalItem=function(e){return this.removeObject(e)},Zotero.Items.prototype.removeLocalItems=function(e){return this.removeObjects(e)},Zotero.Items.prototype.deleteItem=function(e){Z.debug("Zotero.Items.deleteItem",3);var t,r=this;if(!e)return!1;e=r.extractKey(e),t=r.getItem(e);var o={target:"item",libraryType:r.owningLibrary.libraryType,libraryID:r.owningLibrary.libraryID,itemKey:t.key},i={url:Zotero.ajax.apiRequestString(o),type:"DELETE",headers:{"If-Unmodified-Since-Version":t.get("version")}};return Zotero.net.ajaxRequest(i)},Zotero.Items.prototype.deleteItems=function(e,t){Z.debug("Zotero.Items.deleteItems",3);var r,o=this,i=[];t||0===o.itemsVersion||(t=o.itemsVersion);var n;for(r=0;r<e.length;r++)e[r]&&(n=o.extractKey(e[r]),n&&i.push(n));var a=o.chunkObjectsArray(i),s=[];for(r=0;r<a.length;r++){var c=a[r].join(","),l={target:"items",libraryType:o.owningLibrary.libraryType,libraryID:o.owningLibrary.libraryID,itemKey:c},u={url:l,type:"DELETE"};s.push(u)}return Zotero.net.queueRequest(s)},Zotero.Items.prototype.trashItems=function(e){var t,r=this;for(t=0;t<e.length;t++){var o=e[t];o.set("deleted",1)}return r.writeItems(e)},Zotero.Items.prototype.untrashItems=function(e){var t,r=this;for(t=0;t<e.length;t++){var o=e[t];o.set("deleted",0)}return r.writeItems(e)},Zotero.Items.prototype.findItems=function(e){var t=this,r=[];return Object.keys(t.itemObjects).forEach(function(o){var i=i.itemObjects[o];e.collectionKey&&-1===i.apiObj.collections.indexOf(e.collectionKey)||r.push(t.itemObjects[o])}),r},Zotero.Items.prototype.atomizeItems=function(e){for(var t,r=[],o=0;o<e.length;o++){t=e[o];var i=t.get("key");if(""===i||null===i){var n=Zotero.utils.getKey();t.set("key",n),t.set("version",0)}if(r.push(t),t.hasOwnProperty("notes")&&t.notes.length>0){for(var a=0;a<t.notes.length;a++)t.notes[a].set("parentItem",t.get("key"));r=r.concat(t.notes)}if(t.hasOwnProperty("attachments")&&t.attachments.length>0){for(var s=0;s<t.attachments.length;s++)t.attachments[s].set("parentItem",t.get("key"));r=r.concat(t.attachments)}}return r},Zotero.Items.prototype.writeItems=function(e){var t,r=this,o=r.owningLibrary,i=r.atomizeItems(e),n={target:"items",libraryType:r.owningLibrary.libraryType,libraryID:r.owningLibrary.libraryID},a=Zotero.ajax.apiRequestString(n),s=r.chunkObjectsArray(i),c=r.rawChunks(s),l=function(e){return Z.debug("writeItem successCallback",3),r.updateObjectsFromWriteResponse(this.writeChunk,e),Zotero.config.useIndexedDB&&this.library.idbLibrary.updateItems(this.writeChunk),Zotero.trigger("itemsChanged",{library:this.library}),e.returnItems=this.writeChunk,e};Z.debug("items.itemsVersion: "+r.itemsVersion,3),Z.debug("items.libraryVersion: "+r.libraryVersion,3);var u=[];for(t=0;t<s.length;t++){var d={writeChunk:s[t],library:o},p=JSON.stringify(c[t]);u.push({url:a,type:"POST",data:p,processData:!1,success:l.bind(d)})}return o.sequentialRequests(u).then(function(e){return Z.debug("Done with writeItems sequentialRequests promise",3),e})},Zotero.Tags=function(e){this.instance="Zotero.Tags",this.tagsVersion=0,this.syncState={earliestVersion:null,latestVersion:null},this.displayTagsArray=[],this.displayTagsUrl="",this.tagObjects={},this.tagsArray=[],this.loaded=!1,e&&this.addTagsFromJson(e)},Zotero.Tags.prototype=new Zotero.Container,Zotero.Tags.prototype.addTag=function(e){var t=this;t.tagObjects[e.apiObj.tag]=e,t.tagsArray.push(e),t.owningLibrary&&e.associateWithLibrary(t.owningLibrary)},Zotero.Tags.prototype.getTag=function(e){var t=this;return t.tagObjects.hasOwnProperty(e)?this.tagObjects[e]:null},Zotero.Tags.prototype.removeTag=function(e){var t=this;delete t.tagObjects[e],t.updateSecondaryData()},Zotero.Tags.prototype.removeTags=function(e){var t=this;e.forEach(function(e){delete t.tagObjects[e]}),t.updateSecondaryData()},Zotero.Tags.prototype.plainTagsList=function(e){Z.debug("Zotero.Tags.plainTagsList",3);var t=[];return e.forEach(function(e){t.push(e.apiObj.tag)}),t},Zotero.Tags.prototype.clear=function(){Z.debug("Zotero.Tags.clear",3),this.tagsVersion=0,this.syncState.earliestVersion=null,this.syncState.latestVersion=null,this.displayTagsArray=[],this.displayTagsUrl="",this.tagObjects={},this.tagsArray=[]},Zotero.Tags.prototype.updateSecondaryData=function(){Z.debug("Zotero.Tags.updateSecondaryData",3);var e=this;e.tagsArray=[],Object.keys(e.tagObjects).forEach(function(t){var r=e.tagObjects[t];e.tagsArray.push(r)}),e.tagsArray.sort(Zotero.Tag.prototype.tagComparer());var t=e.plainTagsList(e.tagsArray);t.sort(Zotero.Library.prototype.comparer()),e.plainList=t},Zotero.Tags.prototype.updateTagsVersion=function(e){var t=this;Object.keys(t.tagObjects).forEach(function(r){var o=t.tagObjects[r];o.set("version",e)})},Zotero.Tags.prototype.rebuildTagsArray=function(){var e=this;e.tagsArray=[],Object.keys(e.tagObjects).forEach(function(t){var r=e.tagObjects[t];e.tagsArray.push(r)})},Zotero.Tags.prototype.addTagsFromJson=function(e){Z.debug("Zotero.Tags.addTagsFromJson",3);var t=this,r=[];return e.forEach(function(e){var o=new Zotero.Tag(e);t.addTag(o),r.push(o)}),r},Zotero.Groups=function(){this.instance="Zotero.Groups",this.groupsArray=[]},Zotero.Groups.prototype.addGroupsFromJson=function(e){var t=this,r=[];return e.forEach(function(e){Z.debug(e,3);var o=new Zotero.Group(e);t.groupsArray.push(o),r.push(o)}),r},Zotero.Groups.prototype.fetchUserGroups=function(e,t){var r=this,o={target:"userGroups",libraryType:"user",libraryID:e,order:"title"};return t?o.key=t:r.owningLibrary&&(o.key=r.owningLibrary._apiKey),Zotero.ajaxRequest(o).then(function(e){Z.debug("fetchUserGroups proxied callback",3);var t=r.addGroupsFromJson(e.data);return e.fetchedGroups=t,e})},Zotero.Searches=function(){this.instance="Zotero.Searches",this.searchObjects={},this.syncState={earliestVersion:null,latestVersion:null}},Zotero.Deleted=function(e){this.instance="Zotero.Deleted","string"==typeof e?this.deletedData=JSON.parse(e):this.deletedData=e,this.untilVersion=null,this.sinceVersion=null,this.waitingPromises=[],this.pending=!1},Zotero.Deleted.prototype.addWaiter=function(){},Zotero.Collection=function(e){this.instance="Zotero.Collection",this.libraryUrlIdentifier="",this.itemKeys=!1,this.key="",this.version=0,this.synced=!1,this.pristineData=null,this.apiObj={key:"",version:0,library:{},links:{},meta:{},data:{key:"",version:0,name:"",parentCollection:!1,relations:{}}},this.children=[],this.topLevel=!0,e&&this.parseJsonCollection(e)},Zotero.Collection.prototype=new Zotero.ApiObject,Zotero.Collection.prototype.instance="Zotero.Collection",Zotero.Collection.prototype.updateObjectKey=function(e){this.updateCollectionKey(e)},Zotero.Collection.prototype.updateCollectionKey=function(e){var t=this;return t.key=e,t.apiObj.key=e,t.apiObj.data.key=e,t},Zotero.Collection.prototype.parseJsonCollection=function(e){Z.debug("parseJsonCollection",4);var t=this;t.key=e.key,t.version=e.version,t.apiObj=Z.extend({},e),t.pristineData=Z.extend({},e.data),t.parentCollection=!1,t.topLevel=!0,t.synced=!0,t.initSecondaryData()},Zotero.Collection.prototype.initSecondaryData=function(){var e=this;e.apiObj.data.parentCollection?e.topLevel=!1:e.topLevel=!0,Zotero.config.librarySettings.libraryPathString?e.websiteCollectionLink=Zotero.config.librarySettings.libraryPathString+"/collectionKey/"+e.apiObj.key:e.websiteCollectionLink="",e.hasChildren=e.apiObj.meta.numCollections?!0:!1},Zotero.Collection.prototype.nestCollection=function(e){Z.debug("Zotero.Collection.nestCollection",4);var t=this,r=t.get("parentCollection");if(r!==!1&&e.hasOwnProperty(r)){var o=e[r];return o.children.push(t),o.hasChildren=!0,t.topLevel=!1,!0}return!1},Zotero.Collection.prototype.addItems=function(e){Z.debug("Zotero.Collection.addItems",3);var t=this,r={target:"items",libraryType:t.apiObj.library.type,libraryID:t.apiObj.library.id,collectionKey:t.key},o=e.join(" ");return Zotero.ajaxRequest(r,"POST",{data:o})},Zotero.Collection.prototype.getMemberItemKeys=function(){Z.debug("Zotero.Collection.getMemberItemKeys",3);var e=this,t={target:"items",libraryType:e.apiObj.library.type,libraryID:e.apiObj.library.id,collectionKey:e.key,format:"keys"};return Zotero.ajaxRequest(t,"GET",{processData:!1}).then(function(t){Z.debug("getMemberItemKeys proxied callback",3);var r=t.data,o=r.trim().split(/[\s]+/);return e.itemKeys=o,o})},Zotero.Collection.prototype.removeItem=function(e){var t=this,r={target:"item",libraryType:t.apiObj.library.type,libraryID:t.apiObj.library.id,collectionKey:t.key,itemKey:e};return Zotero.ajaxRequest(r,"DELETE",{processData:!1,cache:!1})},Zotero.Collection.prototype.update=function(e,t){var r=this;t||(t=!1);var o={target:"collection",libraryType:r.apiObj.library.type,libraryID:r.apiObj.library.id,collectionKey:r.key};r.set("name",e),r.set("parentCollection",t);var i=r.writeApiObj(),n=JSON.stringify(i);return Zotero.ajaxRequest(o,"PUT",{data:n,processData:!1,headers:{"If-Unmodified-Since-Version":r.version},cache:!1})},Zotero.Collection.prototype.writeApiObj=function(){var e=this,t=Z.extend({},e.pristineData,e.apiObj.data);return t},Zotero.Collection.prototype.remove=function(){Z.debug("Zotero.Collection.delete",3);var e=this,t=e.owningLibrary,r={target:"collection",libraryType:e.apiObj.library.type,libraryID:e.apiObj.library.id,collectionKey:e.key};return Zotero.ajaxRequest(r,"DELETE",{processData:!1,headers:{"If-Unmodified-Since-Version":e.version},cache:!1}).then(function(){Z.debug("done deleting collection. remove local copy.",3),t.collections.removeLocalCollection(e.key),t.trigger("libraryCollectionsUpdated")})},Zotero.Collection.prototype.get=function(e){var t=this;switch(e){case"title":case"name":return t.apiObj.data.name;case"collectionKey":case"key":return t.apiObj.key||t.key;case"collectionVersion":case"version":return t.apiObj.version;case"parentCollection":return t.apiObj.data.parentCollection}return e in t.apiObj.data?t.apiObj.data[e]:t.apiObj.meta.hasOwnProperty(e)?t.apiObj.meta[e]:t.hasOwnProperty(e)?t[e]:null},Zotero.Collection.prototype.set=function(e,t){var r=this;switch(e in r.apiObj.data&&(r.apiObj.data[e]=t),e){case"title":case"name":r.apiObj.data.name=t;break;case"collectionKey":case"key":r.key=t,r.apiObj.key=t,r.apiObj.data.key=t;break;case"parentCollection":r.apiObj.data.parentCollection=t;break;case"collectionVersion":case"version":r.version=t,r.apiObj.version=t,r.apiObj.data.version=t}r.hasOwnProperty(e)&&(r[e]=t)},Zotero.Item=function(e){this.instance="Zotero.Item",this.version=0,this.key="",this.synced=!1,this.apiObj={},this.pristineData=null,this.childItemKeys=[],this.writeErrors=[],this.notes=[],e?this.parseJsonItem(e):this.parseJsonItem(this.emptyJsonItem()),this.initSecondaryData()},Zotero.Item.prototype=new Zotero.ApiObject,Zotero.Item.prototype.parseJsonItem=function(e){Z.debug("parseJsonItem",3);var t=this;t.version=e.version,t.key=e.key,t.apiObj=Z.extend({},e),t.pristineData=Z.extend({},e.data),t.apiObj._supplement||(t.apiObj._supplement={})},Zotero.Item.prototype.emptyJsonItem=function(){return{key:"",version:0,library:{},links:{},data:{key:"",version:0,title:"",creators:[],collections:[],tags:[],relations:{}},meta:{},_supplement:{}}},Zotero.Item.prototype.initSecondaryData=function(){Z.debug("initSecondaryData",3);var e=this;e.version=e.apiObj.version,"attachment"==e.apiObj.data.itemType&&(e.mimeType=e.apiObj.data.contentType,e.translatedMimeType=Zotero.utils.translateMimeType(e.mimeType)),"linkMode"in e.apiObj&&(e.linkMode=e.apiObj.data.linkMode),e.attachmentDownloadUrl=Zotero.url.attachmentDownloadUrl(e),e.apiObj.meta.parsedDate?e.parsedDate=new Date(e.apiObj.meta.parsedDate):e.parsedDate=!1,e.synced=!1,e.updateTagStrings(),Z.debug("done with initSecondaryData",3)},Zotero.Item.prototype.updateTagStrings=function(){for(var e=this,t=[],r=0;r<e.apiObj.data.tags.length;r++)t.push(e.apiObj.data.tags[r].tag);e.apiObj._supplement.tagstrings=t},Zotero.Item.prototype.initEmpty=function(e,t){var r=this;return r.getItemTemplate(e,t).then(function(e){return r.initEmptyFromTemplate(e),r})},Zotero.Item.prototype.initEmptyNote=function(){var e=this;e.version=0;var t={itemType:"note",note:"",tags:[],collections:[],relations:{}};return e.initEmptyFromTemplate(t),e},Zotero.Item.prototype.initEmptyFromTemplate=function(e){var t=this;return t.version=0,t.key="",t.pristineData=Z.extend({},e),t.apiObj={key:"",version:0,library:{},links:{},data:e,meta:{},_supplement:{}},t.initSecondaryData(),t},Zotero.Item.prototype.isSupplementaryItem=function(){var e=this,t=e.get("itemType");return"attachment"==t||"note"==t?!0:!1},Zotero.Item.prototype.isSnapshot=function(){var e=this;if(e.apiObj.links.enclosure){var t=e.apiObj.links.enclosure.type;if(!e.apiObj.links.enclosure.length&&"text/html"==t)return!0}return!1},Zotero.Item.prototype.updateObjectKey=function(e){return this.updateItemKey(e)},Zotero.Item.prototype.updateItemKey=function(e){var t=this;return t.key=e,t.apiObj.key=e,t.apiObj.data.key=e,t.pristineData.key=e,t},Zotero.Item.prototype.writeItem=function(){var e=this;if(!e.owningLibrary)throw new Error("Item must be associated with a library");return e.owningLibrary.items.writeItems([e])},Zotero.Item.prototype.writeApiObj=function(){var e=this;if(e.apiObj.data.creators){var t=e.apiObj.data.creators.filter(function(e){return e.name||e.firstName||e.lastName?!0:!1;
});e.apiObj.data.creators=t}var r=Z.extend({},e.pristineData,e.apiObj.data);return r},Zotero.Item.prototype.createChildNotes=function(e){var t=this,r=[],o=[];return e.forEach(function(e){var i=new Zotero.Item,n=i.initEmpty("note").then(function(o){o.set("note",e.note),o.set("parentItem",t.key),r.push(o)});o.push(n)}),Promise.all(o).then(function(){return t.owningLibrary.writeItems(r)})},Zotero.Item.prototype.writePatch=function(){},Zotero.Item.prototype.getChildren=function(e){Z.debug("Zotero.Item.getChildren");var t=this;return Promise.resolve().then(function(){if(!t.apiObj.meta.numChildren)return[];var r={url:{target:"children",libraryType:t.apiObj.library.type,libraryID:t.apiObj.library.id,itemKey:t.key}};return Zotero.net.queueRequest(r).then(function(t){Z.debug("getChildren proxied callback",4);for(var r=e.items,o=r.addItemsFromJson(t.data),i=o.length-1;i>=0;i--)o[i].associateWithLibrary(e);return o})})},Zotero.Item.prototype.getItemTypes=function(e){Z.debug("Zotero.Item.prototype.getItemTypes",3),e||(e="en-US"),e="en-US";var t=Zotero.cache.load({locale:e,target:"itemTypes"});if(t)return Z.debug("have itemTypes in localStorage",3),void(Zotero.Item.prototype.itemTypes=t);var r=Zotero.ajax.apiQueryString({locale:e}),o=Zotero.config.baseApiUrl+"/itemTypes"+r;Zotero.net.ajax({url:Zotero.ajax.proxyWrapper(o,"GET"),type:"GET"}).then(function(t){Z.debug("got itemTypes response",3),Z.debug(t.response,4),Zotero.Item.prototype.itemTypes=JSON.parse(t.responseText),Zotero.cache.save({locale:e,target:"itemTypes"},Zotero.Item.prototype.itemTypes)})},Zotero.Item.prototype.getItemFields=function(e){Z.debug("Zotero.Item.prototype.getItemFields",3),e||(e="en-US"),e="en-US";var t=Zotero.cache.load({locale:e,target:"itemFields"});if(t)return Z.debug("have itemFields in localStorage",3),Zotero.Item.prototype.itemFields=t,void Object.keys(Zotero.Item.prototype.itemFields).forEach(function(e){var t=Zotero.Item.prototype.itemFields[e];Zotero.localizations.fieldMap[t.field]=t.localized});var r=Zotero.ajax.apiQueryString({locale:e}),o=Zotero.config.baseApiUrl+"/itemFields"+r;Zotero.net.ajax({url:Zotero.ajax.proxyWrapper(o),type:"GET"}).then(function(t){Z.debug("got itemTypes response",4);var r=JSON.parse(t.responseText);Zotero.Item.prototype.itemFields=r,Zotero.cache.save({locale:e,target:"itemFields"},r),Object.keys(Zotero.Item.prototype.itemFields).forEach(function(e){var t=Zotero.Item.prototype.itemFields[e];Zotero.localizations.fieldMap[t.field]=t.localized})})},Zotero.Item.prototype.getItemTemplate=function(){var e=arguments.length<=0||void 0===arguments[0]?"document":arguments[0],t=arguments.length<=1||void 0===arguments[1]?"":arguments[1];if(Z.debug("Zotero.Item.prototype.getItemTemplate",3),"attachment"==e&&""==t)throw new Error("attachment template requested with no linkMode");var r=Zotero.ajax.apiQueryString({itemType:e,linkMode:t}),o=Zotero.config.baseApiUrl+"/items/new"+r,i={itemType:e,target:"itemTemplate"},n=Zotero.cache.load(i);if(n){Z.debug("have itemTemplate in localStorage",3);var a=n;return Promise.resolve(a)}return Zotero.ajaxRequest(o,"GET",{dataType:"json"}).then(function(e){return Z.debug("got itemTemplate response",3),Zotero.cache.save(i,e.data),e.data})},Zotero.Item.prototype.getUploadAuthorization=function(e){Z.debug("Zotero.Item.getUploadAuthorization",3);var t=this,r={target:"item",targetModifier:"file",libraryType:t.owningLibrary.type,libraryID:t.owningLibrary.libraryID,itemKey:t.key},o={"Content-Type":"application/x-www-form-urlencoded"},i=t.get("md5");return i?o["If-Match"]=i:o["If-None-Match"]="*",Zotero.ajaxRequest(r,"POST",{processData:!0,data:e,headers:o})},Zotero.Item.prototype.registerUpload=function(e){Z.debug("Zotero.Item.registerUpload",3);var t=this,r={target:"item",targetModifier:"file",libraryType:t.owningLibrary.type,libraryID:t.owningLibrary.libraryID,itemKey:t.key},o={"Content-Type":"application/x-www-form-urlencoded"},i=t.get("md5");return i?o["If-Match"]=i:o["If-None-Match"]="*",Zotero.ajaxRequest(r,"POST",{processData:!0,data:{upload:e},headers:o})},Zotero.Item.prototype.fullUpload=function(e){},Zotero.Item.prototype.creatorTypes={},Zotero.Item.prototype.getCreatorTypes=function(e){Z.debug("Zotero.Item.prototype.getCreatorTypes: "+e,3),e||(e="document");var t=Zotero.cache.load({target:"creatorTypes"});if(t&&(Z.debug("have creatorTypes in localStorage",3),Zotero.Item.prototype.creatorTypes=t),Zotero.Item.prototype.creatorTypes[e])return Z.debug("creatorTypes of requested itemType available in localStorage",3),Z.debug(Zotero.Item.prototype.creatorTypes,4),Promise.resolve(Zotero.Item.prototype.creatorTypes[e]);Z.debug("sending request for creatorTypes",3);var r=Zotero.ajax.apiQueryString({itemType:e}),o=Zotero.config.baseApiUrl+"/itemTypeCreatorTypes"+r;return Zotero.ajaxRequest(o,"GET",{dataType:"json"}).then(function(t){return Z.debug("got creatorTypes response",4),Zotero.Item.prototype.creatorTypes[e]=t.data,Zotero.cache.save({target:"creatorTypes"},Zotero.Item.prototype.creatorTypes),Zotero.Item.prototype.creatorTypes[e]})},Zotero.Item.prototype.getCreatorFields=function(e){Z.debug("Zotero.Item.prototype.getCreatorFields",3);var t=Zotero.cache.load({target:"creatorFields"});if(t)return Z.debug("have creatorFields in localStorage",3),Zotero.Item.prototype.creatorFields=t,Promise.resolve(t);var r=Zotero.config.baseApiUrl+"/creatorFields";return Zotero.ajaxRequest(r,"GET",{dataType:"json"}).then(function(e){Z.debug("got itemTypes response",4),Zotero.Item.prototype.creatorFields=e.data,Zotero.cache.save({target:"creatorFields"},e.data)})},Zotero.Item.prototype.addItemTypes=function(e,t){},Zotero.Item.prototype.addItemFields=function(e,t){},Zotero.Item.prototype.addCreatorTypes=function(e,t){},Zotero.Item.prototype.addCreatorFields=function(e,t){},Zotero.Item.prototype.addItemTemplates=function(e){},Zotero.Item.prototype.itemTypeImageClass=function(){var e=this;if("attachment"!=e.apiObj.data.itemType)return e.apiObj.data.itemType;switch(e.apiObj.data.linkMode){case"imported_file":return"pdf"==e.translatedMimeType?e.itemTypeImageSrc.attachmentPdf:e.itemTypeImageSrc.attachmentFile;case"imported_url":return"pdf"==e.translatedMimeType?e.itemTypeImageSrc.attachmentPdf:e.itemTypeImageSrc.attachmentSnapshot;case"linked_file":return e.itemTypeImageSrc.attachmentLink;case"linked_url":return e.itemTypeImageSrc.attachmentWeblink;default:return e.itemTypeImageSrc.attachment}},Zotero.Item.prototype.itemTypeIconClass=function(){var e=this,t="fa fa-file-text-o";switch(e.apiObj.data.itemType){case"attachment":switch(e.apiObj.data.linkMode){case"imported_file":return"pdf"==e.translatedMimeType?"fa fa-file-pdf-o":"glyphicons glyphicons-file";case"imported_url":return"pdf"==e.translatedMimeType?"fa fa-file-pdf-o":"glyphicons glyphicons-file";case"linked_file":return"glyphicons glyphicons-link";case"linked_url":return"glyphicons glyphicons-link";default:return"glyphicons glyphicons-paperclip"}return"glyphicons file";case"artwork":return"glyphicons glyphicons-picture";case"audioRecording":return"glyphicons glyphicons-microphone";case"bill":return t;case"blogPost":return"glyphicons glyphicons-blog";case"book":return"glyphicons glyphicons-book";case"bookSection":return"glyphicons glyphicons-book-open";case"case":return t;case"computerProgram":return"glyphicons glyphicons-floppy-disk";case"conferencePaper":return t;case"dictionaryEntry":return"glyphicons glyphicons-translate";case"document":return"glyphicons glyphicons-file";case"email":return"glyphicons glyphicons-envelope";case"encyclopediaArticle":return"glyphicons glyphicons-bookmark";case"film":return"glyphicons glyphicons-film";case"forumPost":return"glyphicons glyphicons-bullhorn";case"hearing":return"fa fa-gavel";case"instantMessage":return"fa fa-comment-o";case"interview":return"fa fa-comments-o";case"journalArticle":return"fa fa-file-text-o";case"letter":return"glyphicons glyphicons-message-full";case"magazineArticle":return t;case"manuscript":return"glyphicons glyphicons-pen";case"map":return"glyphicons glyphicons-google-maps";case"newspaperArticle":return"fa fa-newspaper-o";case"note":return"glyphicons glyphicons-notes noteyellow";case"patent":return"glyphicons glyphicons-lightbulb";case"podcast":return"glyphicons glyphicons-ipod";case"presentation":return"glyphicons glyphicons-keynote";case"radioBroadcast":return"glyphicons glyphicons-wifi-alt";case"report":return"glyphicons glyphicons-notes-2";case"statue":return"glyphicons glyphicons-bank";case"thesis":return"fa fa-graduation-cap";case"tvBroadcast":return"glyphicons glyphicons-display";case"videoRecording":return"glyphicons glyphicons-facetime-video";case"webpage":return"glyphicons glyphicons-embed-close";default:return"glyphicons file"}},Zotero.Item.prototype.get=function(e){var t=this;switch(e){case"title":;return"note"==t.apiObj.data.itemType?t.noteTitle(t.apiObj.data.note):t.apiObj.data.title;case"creatorSummary":case"creator":return"undefined"!=typeof t.apiObj.meta.creatorSummary?t.apiObj.meta.creatorSummary:"";case"year":return t.parsedDate?t.parsedDate.getFullYear():""}return e in t.apiObj.data?t.apiObj.data[e]:e in t.apiObj.meta?t.apiObj.meta[e]:t.hasOwnProperty(e)?t[e]:null},Zotero.Item.prototype.set=function(e,t){var r=this;switch(e in r.apiObj&&(r.apiObj[e]=t),e in r.apiObj.data&&(r.apiObj.data[e]=t),e in r.apiObj.meta&&(r.apiObj.meta[e]=t),e){case"itemKey":case"key":r.key=t,r.apiObj.data.key=t;break;case"itemVersion":case"version":r.version=t,r.apiObj.data.version=t;break;case"itemType":r.itemType=t;break;case"linkMode":break;case"deleted":r.apiObj.data.deleted=t;break;case"parentItem":""===t&&(t=!1),r.apiObj.data.parentItem=t}return r},Zotero.Item.prototype.noteTitle=function(e){var t=120,r=J(e).text(),o=r.indexOf("\n");return-1!=o&&t>o?r.substr(0,o):r.substr(0,t)},Zotero.Item.prototype.setParent=function(e){var t=this;return"string"!=typeof e&&e.hasOwnProperty("instance")&&"Zotero.Item"==e.instance&&(e=e.key),t.set("parentItem",e),t},Zotero.Item.prototype.addToCollection=function(e){var t=this;"string"!=typeof e&&"Zotero.Collection"==e.instance&&(e=e.key),-1===t.apiObj.data.collections.indexOf(e)&&t.apiObj.data.collections.push(e)},Zotero.Item.prototype.removeFromCollection=function(e){var t=this;"string"!=typeof e&&"Zotero.Collection"==e.instance&&(e=e.key);var r=t.apiObj.data.collections.indexOf(e);-1!=r&&t.apiObj.data.collections.splice(r,1)},Zotero.Item.prototype.uploadChildAttachment=function(e,t,r){var o=this;return Z.debug("uploadChildAttachment",3),o.owningLibrary?(e.set("parentItem",o.key),e.associateWithLibrary(o.owningLibrary),e.writeItem().then(function(i){return o.numChildren++,e.uploadFile(t,r)},function(e){throw{message:"Failure during attachmentItem write.",code:e.status,serverMessage:e.jqxhr.responseText,response:e}})):Promise.reject(new Error("Item must be associated with a library"))},Zotero.Item.prototype.uploadFile=function(e,t){var r=this;Z.debug("Zotero.Item.uploadFile",3);var o={md5:e.md5,filename:r.get("title"),filesize:e.filesize,mtime:e.mtime,contentType:e.contentType,params:1};return""===e.contentType&&(o.contentType="application/octet-stream"),r.getUploadAuthorization(o).then(function(t){Z.debug("uploadAuth callback",3);var o;return o="string"==typeof t.data?JSON.parse(t.data):t.data,1==o.exists?{message:"File Exists"}:Zotero.file.uploadFile(o,e).then(function(){return r.registerUpload(o.uploadKey).then(function(e){if(e.isError){var t={message:"Failed to register uploaded file.",code:e.status,serverMessage:e.jqxhr.responseText,response:e};throw Z.error(t),t}return{message:"Upload Successful"}})})})["catch"](function(e){throw Z.debug("Failure caught during upload",3),Z.debug(e,3),{message:"Failure during upload.",code:e.status,serverMessage:e.jqxhr.responseText,response:e}})},Zotero.Item.prototype.cslItem=function(){var e=this,t=e.get("itemType"),r=e.cslTypeMap.hasOwnProperty(t)?e.cslTypeMap[t]:!1;r||(r="article");var o=(e.get("accessDate")||e.get("url"))&&t in{journalArticle:1,newspaperArticle:1,magazineArticle:1}&&e.get("pages")&&e.citePaperJournalArticleURL,i={type:r};e.owningLibrary?i.id=e.apiObj.library.id+"/"+e.get("key"):i.id=Zotero.utils.getKey(),Object.keys(e.cslFieldMap).forEach(function(t){var r=e.cslFieldMap[t];"URL"==t&&o||r.forEach(function(r){var o=e.get(r);o&&(i[t]=o)})});var n=e.get("creators");return n.forEach(function(e){var t=e.creatorType;if(t){var r;r=e.hasOwnProperty("name")?{literal:e.name}:{family:e.lastName,given:e.firstName},i.hasOwnProperty(t)?i[t].push(r):i[t]=[r]}}),Object.keys(e.cslDateMap).forEach(function(t){var r=e.cslDateMap[t],o=e.get(r);o&&(i[t]={raw:o})}),i},Zotero.Item.prototype.fieldMap={itemType:"Item Type",title:"Title",dateAdded:"Date Added",dateModified:"Date Modified",source:"Source",notes:"Notes",tags:"Tags",attachments:"Attachments",related:"Related",url:"URL",rights:"Rights",series:"Series",volume:"Volume",issue:"Issue",edition:"Edition",place:"Place",publisher:"Publisher",pages:"Pages",ISBN:"ISBN",publicationTitle:"Publication",ISSN:"ISSN",date:"Date",year:"Year",section:"Section",callNumber:"Call Number",archive:"Archive",archiveLocation:"Loc. in Archive",libraryCatalog:"Library Catalog",distributor:"Distributor",extra:"Extra",journalAbbreviation:"Journal Abbr",DOI:"DOI",accessDate:"Accessed",seriesTitle:"Series Title",seriesText:"Series Text",seriesNumber:"Series Number",institution:"Institution",reportType:"Report Type",code:"Code",session:"Session",legislativeBody:"Legislative Body",history:"History",reporter:"Reporter",court:"Court",numberOfVolumes:"# of Volumes",committee:"Committee",assignee:"Assignee",patentNumber:"Patent Number",priorityNumbers:"Priority Numbers",issueDate:"Issue Date",references:"References",legalStatus:"Legal Status",codeNumber:"Code Number",artworkMedium:"Medium",number:"Number",artworkSize:"Artwork Size",repository:"Repository",videoRecordingType:"Recording Type",interviewMedium:"Medium",letterType:"Type",manuscriptType:"Type",mapType:"Type",scale:"Scale",thesisType:"Type",websiteType:"Website Type",audioRecordingType:"Recording Type",label:"Label",presentationType:"Type",meetingName:"Meeting Name",studio:"Studio",runningTime:"Running Time",network:"Network",postType:"Post Type",audioFileType:"File Type",versionNumber:"Version Number",system:"System",company:"Company",conferenceName:"Conference Name",encyclopediaTitle:"Encyclopedia Title",dictionaryTitle:"Dictionary Title",language:"Language",programmingLanguage:"Language",university:"University",abstractNote:"Abstract",websiteTitle:"Website Title",reportNumber:"Report Number",billNumber:"Bill Number",codeVolume:"Code Volume",codePages:"Code Pages",dateDecided:"Date Decided",reporterVolume:"Reporter Volume",firstPage:"First Page",documentNumber:"Document Number",dateEnacted:"Date Enacted",publicLawNumber:"Public Law Number",country:"Country",applicationNumber:"Application Number",forumTitle:"Forum/Listserv Title",episodeNumber:"Episode Number",blogTitle:"Blog Title",caseName:"Case Name",nameOfAct:"Name of Act",subject:"Subject",proceedingsTitle:"Proceedings Title",bookTitle:"Book Title",shortTitle:"Short Title",docketNumber:"Docket Number",numPages:"# of Pages",note:"Note",numChildren:"# of Children",addedBy:"Added By",creator:"Creator"},Zotero.localizations.fieldMap=Zotero.Item.prototype.fieldMap,Zotero.Item.prototype.typeMap={note:"Note",attachment:"Attachment",book:"Book",bookSection:"Book Section",journalArticle:"Journal Article",magazineArticle:"Magazine Article",newspaperArticle:"Newspaper Article",thesis:"Thesis",letter:"Letter",manuscript:"Manuscript",interview:"Interview",film:"Film",artwork:"Artwork",webpage:"Web Page",report:"Report",bill:"Bill","case":"Case",hearing:"Hearing",patent:"Patent",statute:"Statute",email:"E-mail",map:"Map",blogPost:"Blog Post",instantMessage:"Instant Message",forumPost:"Forum Post",audioRecording:"Audio Recording",presentation:"Presentation",videoRecording:"Video Recording",tvBroadcast:"TV Broadcast",radioBroadcast:"Radio Broadcast",podcast:"Podcast",computerProgram:"Computer Program",conferencePaper:"Conference Paper",document:"Document",encyclopediaArticle:"Encyclopedia Article",dictionaryEntry:"Dictionary Entry"},Zotero.localizations.typeMap=Zotero.Item.prototype.typeMap,Zotero.Item.prototype.creatorMap={author:"Author",contributor:"Contributor",editor:"Editor",translator:"Translator",seriesEditor:"Series Editor",interviewee:"Interview With",interviewer:"Interviewer",director:"Director",scriptwriter:"Scriptwriter",producer:"Producer",castMember:"Cast Member",sponsor:"Sponsor",counsel:"Counsel",inventor:"Inventor",attorneyAgent:"Attorney/Agent",recipient:"Recipient",performer:"Performer",composer:"Composer",wordsBy:"Words By",cartographer:"Cartographer",programmer:"Programmer",reviewedAuthor:"Reviewed Author",artist:"Artist",commenter:"Commenter",presenter:"Presenter",guest:"Guest",podcaster:"Podcaster"},Zotero.Item.prototype.hideFields=["mimeType","linkMode","charset","md5","mtime","version","key","collections","relations","parentItem","contentType","filename","tags"],Zotero.Item.prototype.noEditFields=["accessDate","modified","filename","dateAdded","dateModified"],Zotero.localizations.creatorMap=Zotero.Item.prototype.creatorMap,Zotero.Item.prototype.itemTypeImageSrc={note:"note",attachment:"attachment-pdf",attachmentPdf:"attachment-pdf",attachmentWeblink:"attachment-web-link",attachmentSnapshot:"attachment-snapshot",attachmentFile:"attachment-file",attachmentLink:"attachment-link",book:"book",bookSection:"book_open",journalArticle:"page_white_text",magazineArticle:"layout",newspaperArticle:"newspaper",thesis:"report",letter:"email_open",manuscript:"script",interview:"comments",film:"film",artwork:"picture",webpage:"page",report:"report",bill:"page_white","case":"page_white",hearing:"page_white",patent:"page_white",statute:"page_white",email:"email",map:"map",blogPost:"layout",instantMessage:"page_white",forumPost:"page",audioRecording:"ipod",presentation:"page_white",videoRecording:"film",tvBroadcast:"television",radioBroadcast:"transmit",podcast:"ipod_cast",computerProgram:"page_white_code",conferencePaper:"treeitem-conferencePaper",document:"page_white",encyclopediaArticle:"page_white",dictionaryEntry:"page_white"},Zotero.Item.prototype.cslNameMap={author:"author",editor:"editor",bookAuthor:"container-author",composer:"composer",interviewer:"interviewer",recipient:"recipient",seriesEditor:"collection-editor",translator:"translator"},Zotero.Item.prototype.cslFieldMap={title:["title"],"container-title":["publicationTitle","reporter","code"],"collection-title":["seriesTitle","series"],"collection-number":["seriesNumber"],publisher:["publisher","distributor"],"publisher-place":["place"],authority:["court"],page:["pages"],volume:["volume"],issue:["issue"],"number-of-volumes":["numberOfVolumes"],"number-of-pages":["numPages"],edition:["edition"],versionNumber:["version"],section:["section"],genre:["type","artworkSize"],medium:["medium","system"],archive:["archive"],archive_location:["archiveLocation"],event:["meetingName","conferenceName"],"event-place":["place"],"abstract":["abstractNote"],URL:["url"],DOI:["DOI"],ISBN:["ISBN"],"call-number":["callNumber"],note:["extra"],number:["number"],references:["history"],shortTitle:["shortTitle"],journalAbbreviation:["journalAbbreviation"],language:["language"]},Zotero.Item.prototype.cslDateMap={issued:"date",accessed:"accessDate"},Zotero.Item.prototype.cslTypeMap={book:"book",bookSection:"chapter",journalArticle:"article-journal",magazineArticle:"article-magazine",newspaperArticle:"article-newspaper",thesis:"thesis",encyclopediaArticle:"entry-encyclopedia",dictionaryEntry:"entry-dictionary",conferencePaper:"paper-conference",letter:"personal_communication",manuscript:"manuscript",interview:"interview",film:"motion_picture",artwork:"graphic",webpage:"webpage",report:"report",bill:"bill","case":"legal_case",hearing:"bill",patent:"patent",statute:"bill",email:"personal_communication",map:"map",blogPost:"webpage",instantMessage:"personal_communication",forumPost:"webpage",audioRecording:"song",presentation:"speech",videoRecording:"motion_picture",tvBroadcast:"broadcast",radioBroadcast:"broadcast",podcast:"song",computerProgram:"book"},Zotero.Item.prototype.citePaperJournalArticleURL=!1,Zotero.Tag=function(e){this.instance="Zotero.Tag",this.color=null,this.version=0,"object"==("undefined"==typeof e?"undefined":_typeof(e))?this.parseJsonTag(e):"string"==typeof e?this.parseJsonTag(this.templateApiObj(e)):this.parseJsonTag(this.tamplateApiObj(""))},Zotero.Tag.prototype=new Zotero.ApiObject,Zotero.Tag.prototype.parseJsonTag=function(e){var t=this;t.apiObj=Z.extend({},e),t.urlencodedtag=encodeURIComponent(t.apiObj.tag),t.version=t.apiObj.version},Zotero.Tag.prototype.templateApiObj=function(e){return{tag:e,links:{},meta:{type:0,numItems:1}}},Zotero.Tag.prototype.tagComparer=function(){if(window.Intl){var e=new window.Intl.Collator;return function(t,r){return e.compare(t.apiObj.tag,r.apiObj.tag)}}return function(e,t){return e.apiObj.tag.toLocaleLowerCase()==t.apiObj.tag.toLocaleLowerCase()?0:e.apiObj.tag.toLocaleLowerCase()<t.apiObj.tag.toLocaleLowerCase()?-1:1}},Zotero.Tag.prototype.set=function(e,t){var r=this;switch(e in r.apiObj&&(r.apiObj[e]=t),e in r.apiObj.meta&&(r.apiObj.meta[e]=t),e){case"tagVersion":case"version":r.version=t,r.apiObj.version=t}return r},Zotero.Search=function(){this.instance="Zotero.Search",this.searchObject={}},Zotero.Group=function(e){var t=this;t.instance="Zotero.Group",e&&this.parseJsonGroup(e)},Zotero.Group.prototype=new Zotero.ApiObject,Zotero.Group.prototype.parseJsonGroup=function(e){var t=this;t.apiObj=e},Zotero.Group.prototype.get=function(e){var t=this;switch(e){case"title":case"name":return t.apiObj.data.name}return e in t.apiObj?t.apiObj[e]:e in t.apiObj.data?t.apiObj.data[e]:e in t.apiObj.meta?t.apiObj.meta[e]:t.hasOwnProperty(e)?t[e]:null},Zotero.Group.prototype.isWritable=function(e){var t=this;switch(!0){case t.get("owner")==e:return!0;case t.apiObj.data.admins&&-1!=t.apiObj.data.admins.indexOf(e):return!0;case"members"==t.apiObj.data.libraryEditing&&t.apiObj.data.members&&-1!=t.apiObj.data.members.indexOf(e):return!0;default:return!1}},Zotero.Group.prototype.typeMap={Private:"Private",PublicOpen:"Public, Open Membership",PublicClosed:"Public, Closed Membership"},Zotero.Group.prototype.accessMap={all:{members:"Anyone can view, only members can edit",admins:"Anyone can view, only admins can edit"},members:{members:"Only members can view and edit",admins:"Only members can view, only admins can edit"},admins:{members:"Only admins can view, only members can edit",admins:"Only admins can view and edit"}},Zotero.User=function(){this.instance="Zotero.User"},Zotero.User.prototype=new Zotero.ApiObject,Zotero.User.prototype.loadObject=function(e){this.title=e.title,this.author=e.author,this.tagID=e.tagID,this.published=e.published,this.updated=e.updated,this.links=e.links,this.numItems=e.numItems,this.items=e.items,this.tagType=e.tagType,this.modified=e.modified,this.added=e.added,this.key=e.key},Zotero.User.prototype.parseXmlUser=function(e){this.parseXmlEntry(e);var t=e.find("content>tag");0!==t.length&&(this.tagKey=t.attr("key"),this.libraryID=t.attr("libraryID"),this.tagName=t.attr("name"),this.dateAdded=t.attr("dateAdded"),this.dateModified=t.attr("dateModified"))},Zotero.utils={randomString:function(e,t){t||(t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"),e||(e=8);for(var r="",o=0;e>o;o++){var i=Math.floor(Math.random()*t.length);r+=t.substring(i,i+1)}return r},getKey:function(){var e="23456789ABCDEFGHIJKMNPQRSTUVWXZ";return Zotero.utils.randomString(8,e)},slugify:function(e){var t=e.trim();return t=t.toLowerCase(),t=t.replace(/[^a-z0-9 ._-]/g,""),t=t.replace(/\s/g,"_")},prependAutocomplete:function(e,t){Z.debug("Zotero.utils.prependAutocomplete",3),Z.debug("prepend match: "+e);var r;if(t||Z.debug("source is not defined"),""===e)return r=t.slice(0);var o=e.length,i=e.toLowerCase();return r=t.map(function(e){return e.substr(0,o).toLowerCase()==i?e:null})},matchAnyAutocomplete:function(e,t){Z.debug("Zotero.utils.matchAnyAutocomplete",3),Z.debug("matchAny match: "+e);var r;if(t||Z.debug("source is not defined"),""===e)return r=t.slice(0);var o=(e.length,e.toLowerCase());return r=t.map(function(e){return-1!=e.toLowerCase().indexOf(o)?e:null})},libraryString:function(e,t){var r="";return"user"==e?r="u":"group"==e&&(r="g"),r+=t},parseLibString:function(e){var t,r;if("u"==e.charAt(0))t="user";else{if("g"!=e.charAt(0))throw new Error("unexpected type character in libraryString");t="group"}return r=parseInt(e.substring(1)),{libraryType:t,libraryID:r}},stale:function(e,t){var r=Date.now(),o=r.getTime()-e.getTime();return o/6e4>t?!0:!1},entityify:function(e){var t={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"};return e.replace(/[<>&"]/g,function(e){return t[e]})},parseApiDate:function(e,t){var r=/([0-9]+)-([0-9]+)-([0-9]+)T([0-9]+):([0-9]+):([0-9]+)Z/,o=r.exec(e);return null===o?(Z.error("error parsing api date: "+e),null):t=new Date(Date.UTC(o[1],o[2]-1,o[3],o[4],o[5],o[6]))},readCookie:function(e){for(var t=e+"=",r=document.cookie.split(";"),o=0;o<r.length;o++){for(var i=r[o];" "==i.charAt(0);)i=i.substring(1,i.length);if(0===i.indexOf(t))return i.substring(t.length,i.length)}return null},translateMimeType:function(e){switch(e){case"text/html":return"html";case"application/pdf":case"application/x-pdf":case"application/acrobat":case"applications/vnd.pdf":case"text/pdf":case"text/x-pdf":return"pdf";case"image/jpg":case"image/jpeg":return"jpg";case"image/gif":return"gif";case"application/msword":case"application/doc":case"application/vnd.msword":case"application/vnd.ms-word":case"application/winword":case"application/word":case"application/x-msw6":case"application/x-msword":return"doc";case"application/vnd.oasis.opendocument.text":case"application/x-vnd.oasis.opendocument.text":return"odt";case"video/flv":case"video/x-flv":return"flv";case"image/tif":case"image/tiff":case"image/x-tif":case"image/x-tiff":case"application/tif":case"application/x-tif":case"application/tiff":case"application/x-tiff":return"tiff";case"application/zip":case"application/x-zip":case"application/x-zip-compressed":case"application/x-compress":case"application/x-compressed":case"multipart/x-zip":return"zip";case"video/quicktime":case"video/x-quicktime":return"mov";case"video/avi":case"video/msvideo":case"video/x-msvideo":return"avi";case"audio/wav":case"audio/x-wav":case"audio/wave":return"wav";case"audio/aiff":case"audio/x-aiff":case"sound/aiff":return"aiff";case"text/plain":return"plain text";case"application/rtf":return"rtf";default:return e}},getKeyPermissions:function(e,t){if(!e)return!1;if(!t)return!1;var r={target:"key",libraryType:"user",libraryID:e,apiKey:t},o=Zotero.ajax.apiRequestString(r);return Zotero.ajaxRequest(o).then(function(e){var t=JSON.parse(e.data);return t})},parseQuery:function(e){for(var t,r={},o=/\+/g,i=/([^&=]+)=?([^&]*)/g,n=function(e){return decodeURIComponent(e.replace(o," "))};t=i.exec(e);)r[n(t[1])]=n(t[2]);return r},querystring:function(e){var t=-1!=e.indexOf("#")?e.indexOf("#"):void 0,r=e.substring(e.indexOf("?")+1,t);return r}},Zotero.extend=function(){for(var e={},t=0;t<arguments.length;t++){var r=arguments[t];"object"==("undefined"==typeof r?"undefined":_typeof(r))&&Object.keys(r).forEach(function(t){e[t]=r[t]})}return e},Zotero.url.itemHref=function(e){var t="";return t+=Zotero.config.librarySettings.libraryPathString+"/itemKey/"+e.get("key")},Zotero.url.attachmentDownloadLink=function(e){var t="",r=e.attachmentDownloadUrl;e.get("contentType");if(e.apiObj.links&&e.apiObj.links.enclosure){if(e.apiObj.links.enclosure.length||!e.isSnapshot()){var o=Zotero.utils.translateMimeType(e.apiObj.links.enclosure.type),i=e.apiObj.links.enclosure,n=parseInt(i.length,10),a=""+n+" B";return n>1073741824?a=""+(n/1073741824).toFixed(1)+" GB":n>1048576?a=""+(n/1048576).toFixed(1)+" MB":n>1024&&(a=""+(n/1024).toFixed(1)+" KB"),Z.debug(o,3),t+='<a href="'+r+'">',t+="undefined"==o||""===o||"undefined"==typeof o?a+"</a>":o+", "+a+"</a>"}t+='<a href="'+r+'">View Snapshot</a>'}return t},Zotero.url.attachmentDownloadUrl=function(e){return e.apiObj.links&&e.apiObj.links.enclosure?Zotero.config.proxyDownloads?Zotero.url.wwwDownloadUrl(e):Zotero.url.apiDownloadUrl(e):!1},Zotero.url.apiDownloadUrl=function(e){return e.apiObj.links.enclosure?e.apiObj.links.enclosure.href:!1},Zotero.url.proxyDownloadUrl=function(e){return e.apiObj.links.enclosure?Zotero.config.proxyDownloads?Zotero.config.baseDownloadUrl+"?itemkey="+e.get("key"):Zotero.url.apiDownloadUrl(e):!1},Zotero.url.wwwDownloadUrl=function(e){return e.apiObj.links.enclosure?Zotero.config.baseZoteroWebsiteUrl+Zotero.config.librarySettings.libraryPathString+"/"+e.get("key")+"/file/view":!1},Zotero.url.publicationsDownloadUrl=function(e){return e.apiObj.links.enclosure?e.apiObj.links.enclosure.href:!1},Zotero.url.attachmentFileDetails=function(e){if(!e.apiObj.links.enclosure)return"";var t=Zotero.utils.translateMimeType(e.apiObj.links.enclosure.type),r=e.apiObj.links.enclosure,o="";if(r.length){var i=parseInt(r.length,10);return o=""+i+" B",i>1073741824?o=""+(i/1073741824).toFixed(1)+" GB":i>1048576?o=""+(i/1048576).toFixed(1)+" MB":i>1024&&(o=""+(i/1024).toFixed(1)+" KB"),"("+t+", "+o+")"}return"("+t+")"},Zotero.url.userWebLibrary=function(e){return[Zotero.config.baseWebsiteUrl,e,"items"].join("/")},Zotero.url.groupWebLibrary=function(e){return"Private"==e.type?[Zotero.config.baseWebsiteUrl,"groups",e.get("id"),"items"].join("/"):[Zotero.config.baseWebsiteUrl,"groups",Zotero.utils.slugify(e.get("name")),"items"].join("/")},Zotero.url.exportUrls=function(e){Z.debug("Zotero.url.exportUrls",3);var t={},r={};return Zotero.config.exportFormats.forEach(function(o){r=Z.extend(e,{format:o}),t[o]=Zotero.ajax.apiRequestUrl(r)+Zotero.ajax.apiQueryString({format:o,limit:"25"})}),t},Zotero.url.relationUrl=function(e,t,r){return"http://zotero.org/"+e+"s/"+t+"/items/"+r},Zotero.file={},Zotero.file.getFileInfo=function(e){return"undefined"==typeof FileReader?Promise.reject(new Error("FileReader not supported")):new Promise(function(t,r){var o={},i=new FileReader;i.onload=function(r){Z.debug("Zotero.file.getFileInfo onloadFunc",3);var i=r.target.result;Zotero.debug(i,3),o.md5=SparkMD5.ArrayBuffer.hash(i),o.filename=e.name,o.filesize=e.size,o.mtime=Date.now(),o.contentType=e.type,o.filedata=i,t(o)},i.readAsArrayBuffer(e)})},Zotero.file.uploadFile=function(e,t){Z.debug("Zotero.file.uploadFile",3),Z.debug(e,4);var r=new FormData;Object.keys(e.params).forEach(function(t){var o=e.params[t];r.append(t,o)});var o=new Blob([t.filedata],{type:t.contentType});r.append("file",o);var i=new XMLHttpRequest;return i.open("POST",e.url,!0),new Promise(function(e,t){i.onload=function(r){Z.debug("uploadFile onload event",3),201==this.status?(Z.debug("successful upload - 201",3),e()):(Z.error("uploadFile failed - "+i.status),t({message:"Failure uploading file.",code:i.status,serverMessage:i.responseText}))},i.onprogress=function(e){Z.debug("progress event"),Z.debug(e)},i.send(r)})},Zotero.Idb={},Zotero.Idb.Library=function(e){Z.debug("Zotero.Idb.Library",3),Z.debug("Initializing Zotero IDB",3),this.libraryString=e,this.owningLibrary=null,this.initialized=!1},Zotero.Idb.Library.prototype.init=function(){var e=this;return new Promise(function(t,r){var o=window.indexedDB;e.indexedDB=o,Z.debug("requesting indexedDb from browser",3);var i=o.open("Zotero_"+e.libraryString,4);i.onerror=function(e){Zotero.error("ERROR OPENING INDEXED DB"),r()};var n=function(t){Z.debug("Zotero.Idb onupgradeneeded or onsuccess",3);var r=t.oldVersion;Z.debug("oldVersion: "+t.oldVersion,3);var o=t.target.result;if(e.db=o,4>r){Z.debug("Existing object store names:",3),Z.debug(JSON.stringify(o.objectStoreNames),3),Z.debug("Deleting old object stores",3),o.objectStoreNames.items&&o.deleteObjectStore("items"),o.objectStoreNames.tags&&o.deleteObjectStore("tags"),o.objectStoreNames.collections&&o.deleteObjectStore("collections"),
o.objectStoreNames.files&&o.deleteObjectStore("files"),o.objectStoreNames.versions&&o.deleteObjectStore("versions"),Z.debug("Existing object store names:",3),Z.debug(JSON.stringify(o.objectStoreNames),3);var i=o.createObjectStore("items",{keyPath:"key"}),n=o.createObjectStore("collections",{keyPath:"key"}),a=o.createObjectStore("tags",{keyPath:"tag"});o.createObjectStore("files"),o.createObjectStore("versions");Z.debug("itemStore index names:",3),Z.debug(JSON.stringify(i.indexNames),3),Z.debug("collectionStore index names:",3),Z.debug(JSON.stringify(n.indexNames),3),Z.debug("tagStore index names:",3),Z.debug(JSON.stringify(a.indexNames),3),Object.keys(Zotero.Item.prototype.fieldMap).forEach(function(e){Z.debug("Creating index on "+e,3),i.createIndex(e,"data."+e,{unique:!1})}),i.createIndex("collectionKeys","data.collections",{unique:!1,multiEntry:!0}),i.createIndex("itemTagStrings","_supplement.tagstrings",{unique:!1,multiEntry:!0}),i.createIndex("parentItemKey","data.parentItem",{unique:!1}),i.createIndex("libraryKey","libraryKey",{unique:!1}),i.createIndex("deleted","data.deleted",{unique:!1}),n.createIndex("name","data.name",{unique:!1}),n.createIndex("key","key",{unique:!1}),n.createIndex("parentCollection","data.parentCollection",{unique:!1}),a.createIndex("tag","tag",{unique:!1})}};i.onupgradeneeded=n,i.onsuccess=function(){Z.debug("IDB success",3),e.db=i.result,e.initialized=!0,t(e)}})},Zotero.Idb.Library.prototype.deleteDB=function(){var e=this;return e.db.close(),new Promise(function(t,r){var o=e.indexedDB.deleteDatabase("Zotero_"+e.libraryString);o.onerror=function(){Z.error("Error deleting indexedDB"),r()},o.onsuccess=function(){Z.debug("Successfully deleted indexedDB",2),t()}})},Zotero.Idb.Library.prototype.getObjectStore=function(e,t){var r=this,o=r.db.transaction(e,t);return o.objectStore(e)},Zotero.Idb.Library.prototype.clearObjectStore=function(e){var t=this,r=t.getObjectStore(e,"readwrite");return new Promise(function(e,t){var o=r.clear();o.onsuccess=function(t){Z.debug("Store cleared",3),e()},o.onerror=function(e){Z.error("clearObjectStore:",e.target.errorCode),t()}})},Zotero.Idb.Library.prototype.addItems=function(e){return this.addObjects(e,"item")},Zotero.Idb.Library.prototype.updateItems=function(e){return this.updateObjects(e,"item")},Zotero.Idb.Library.prototype.removeItems=function(e){return this.removeObjects(e,"item")},Zotero.Idb.Library.prototype.getItem=function(e){var t=this;return new Promise(function(r,o){var i=function(e){r(e.target.result)};t.db.transaction("items").objectStore(["items"],"readonly").get(e).onsuccess=i})},Zotero.Idb.Library.prototype.getAllItems=function(){return this.getAllObjects("item")},Zotero.Idb.Library.prototype.getOrderedItemKeys=function(e,t){var r=this;return Z.debug("Zotero.Idb.getOrderedItemKeys",3),Z.debug(""+e+" "+t,3),new Promise(function(o,i){var n=r.db.transaction(["items"],"readonly").objectStore("items"),a=n.index(e);if(!a)throw new Error("Index for requested field '"+e+"'' not found");var s="next";"desc"==t&&(s="prev");var c=a.openKeyCursor(null,s),l=[];c.onsuccess=function(e){var t=e.target.result;t?(l.push(t.primaryKey),t["continue"]()):(Z.debug("No more cursor: done. Resolving deferred.",3),o(l))}.bind(this),c.onfailure=function(e){i()}.bind(this)})},Zotero.Idb.Library.prototype.filterItems=function(e,t){var r=this;return Z.debug("Zotero.Idb.filterItems "+e+" - "+t,3),new Promise(function(o,i){var n=[],a=r.db.transaction(["items"],"readonly").objectStore("items"),s=a.index(e);if(!s)throw new Error("Index for requested field '"+e+"'' not found");var c="next",l=IDBKeyRange.only(t),u=s.openKeyCursor(l,c);u.onsuccess=function(e){var t=e.target.result;t?(n.push(t.primaryKey),t["continue"]()):(Z.debug("No more cursor: done. Resolving deferred.",3),o(n))}.bind(this),u.onfailure=function(e){i()}.bind(this)})},Zotero.Idb.Library.prototype.inferType=function(e){if(!e)return!1;if(!e.instance)return!1;switch(e.instance){case"Zotero.Item":return"item";case"Zotero.Collection":return"collection";case"Zotero.Tag":return"tag";default:return!1}},Zotero.Idb.Library.prototype.getTransactionAndStore=function(e,t){var r,o,i=this;switch(e){case"item":r=i.db.transaction(["items"],t),o=r.objectStore("items");break;case"collection":r=i.db.transaction(["collections"],t),o=r.objectStore("collections");break;case"tag":r=i.db.transaction(["tags"],t),o=r.objectStore("tags");break;default:return Promise.reject()}return[r,o]},Zotero.Idb.Library.prototype.addObjects=function(e,t){Z.debug("Zotero.Idb.Library.addObjects",3);var r=this;t||(t=r.inferType(e[0]));var o=r.getTransactionAndStore(t,"readwrite"),i=o[0],n=o[1];return new Promise(function(t,r){i.oncomplete=function(e){Zotero.debug("Add Objects transaction completed.",3),t()},i.onerror=function(e){Zotero.error("Add Objects transaction failed."),r()};var o=function(e){Zotero.debug("Added Object "+e.target.result,4)};for(var a in e){var s=n.add(e[a].apiObj);s.onsuccess=o}})},Zotero.Idb.Library.prototype.updateObjects=function(e,t){Z.debug("Zotero.Idb.Library.updateObjects",3);var r=this;t||(t=r.inferType(e[0]));var o=r.getTransactionAndStore(t,"readwrite"),i=o[0],n=o[1];return new Promise(function(t,r){i.oncomplete=function(e){Zotero.debug("Update Objects transaction completed.",3),t()},i.onerror=function(e){Zotero.error("Update Objects transaction failed."),r()};var o=function(e){Zotero.debug("Updated Object "+e.target.result,4)};for(var a in e){var s=n.put(e[a].apiObj);s.onsuccess=o}})},Zotero.Idb.Library.prototype.removeObjects=function(e,t){var r=this;t||(t=r.inferType(e[0]));var o=r.getTransactionAndStore(t,"readwrite"),i=o[0],n=o[1];return new Promise(function(t,r){i.oncomplete=function(e){Zotero.debug("Remove Objects transaction completed.",3),t()},i.onerror=function(e){Zotero.error("Remove Objects transaction failed."),r()};var o=function(e){Zotero.debug("Removed Object "+e.target.result,4)};for(var a in e){var s=n["delete"](e[a].key);s.onsuccess=o}})},Zotero.Idb.Library.prototype.getAllObjects=function(e){var t=this;return new Promise(function(r,o){var i=[],n=t.db.transaction(e+"s").objectStore(e+"s");n.openCursor().onsuccess=function(e){var t=e.target.result;t?(i.push(t.value),t["continue"]()):r(i)}})},Zotero.Idb.Library.prototype.addCollections=function(e){return this.addObjects(e,"collection")},Zotero.Idb.Library.prototype.updateCollections=function(e){return Z.debug("Zotero.Idb.Library.updateCollections",3),this.updateObjects(e,"collection")},Zotero.Idb.Library.prototype.getCollection=function(e){var t=this;return new Promise(function(r,o){var i=function(e){r(e.target.result)};t.db.transaction("collections").objectStore(["collections"],"readonly").get(e).onsuccess=i})},Zotero.Idb.Library.prototype.removeCollections=function(e){return Z.debug("Zotero.Idb.Library.removeCollections",3),this.removeObjects(e,"collection")},Zotero.Idb.Library.prototype.getAllCollections=function(){return Z.debug("Zotero.Idb.Library.getAllCollections",3),this.getAllObjects("collection")},Zotero.Idb.Library.prototype.addTags=function(e){return this.addObjects(e,"tag")},Zotero.Idb.Library.prototype.updateTags=function(e){return Z.debug("Zotero.Idb.Library.updateTags",3),this.updateObjects(e,"tag")},Zotero.Idb.Library.prototype.getAllTags=function(){return Z.debug("getAllTags",3),this.getAllObjects("tag")},Zotero.Idb.Library.prototype.setVersion=function(e,t){Z.debug("Zotero.Idb.Library.setVersion",3);var r=this;return new Promise(function(o,i){var n=r.db.transaction(["versions"],"readwrite");n.oncomplete=function(e){Zotero.debug("set version transaction completed.",3),o()},n.onerror=function(e){Zotero.error("set version transaction failed."),i()};var a=n.objectStore("versions"),s=function(e){Zotero.debug("Set Version"+e.target.result,3)},c=a.put(t,e);c.onsuccess=s})},Zotero.Idb.Library.prototype.getVersion=function(e){Z.debug("Zotero.Idb.Library.getVersion",3);var t=this;return new Promise(function(r,o){var i=function(e){Z.debug("done getting version"),r(e.target.result)};t.db.transaction(["versions"],"readonly").objectStore("versions").get(e).onsuccess=i})},Zotero.Idb.Library.prototype.setFile=function(e,t){Z.debug("Zotero.Idb.Library.setFile",3);var r=this;return new Promise(function(o,i){var n=r.db.transaction(["files"],"readwrite");n.oncomplete=function(e){Zotero.debug("set file transaction completed.",3),o()},n.onerror=function(e){Zotero.error("set file transaction failed."),i()};var a=n.objectStore("files"),s=function(e){Zotero.debug("Set File"+e.target.result,3)},c=a.put(t,e);c.onsuccess=s})},Zotero.Idb.Library.prototype.getFile=function(e){Z.debug("Zotero.Idb.Library.getFile",3);var t=this;return new Promise(function(r,o){var i=function(e){Z.debug("done getting file"),r(e.target.result)};t.db.transaction(["files"],"readonly").objectStore("files").get(e).onsuccess=i})},Zotero.Idb.Library.prototype.deleteFile=function(e){Z.debug("Zotero.Idb.Library.deleteFile",3);var t=this;return new Promise(function(r,o){var i=t.db.transaction(["files"],"readwrite");i.oncomplete=function(e){Zotero.debug("delete file transaction completed.",3),r()},i.onerror=function(e){Zotero.error("delete file transaction failed."),o()};var n=i.objectStore("files"),a=function(e){Zotero.debug("Deleted File"+e.target.result,4)},s=n["delete"](e);s.onsuccess=a})},Zotero.Idb.Library.prototype.intersect=function(e,t){for(var r=[],o=0;o<e.length;o++)-1!==t.indexOf(e[o])&&r.push(e[o]);return r},Zotero.Idb.Library.prototype.intersectAll=function(e){for(var t=this,r=e[0],o=0;o<e.length-1;o++)r=t.intersect(r,e[o+1]);return r},Zotero.Library.prototype.processLoadedCollections=function(e){Z.debug("processLoadedCollections",3);var t=this;Z.debug("adding collections to library.collections");for(var r=t.collections.addCollectionsFromJson(e.data),o=0;o<r.length;o++)r[o].associateWithLibrary(t);return t.collections.updateSyncState(e.lastModifiedVersion),Zotero.trigger("loadedCollectionsProcessed",{library:t,collectionsAdded:r}),e},Zotero.Library.prototype.addCollection=function(e,t){Z.debug("Zotero.Library.addCollection",3);var r=this,o=new Zotero.Collection;return o.associateWithLibrary(r),o.set("name",e),o.set("parentCollection",t),r.collections.writeCollections([o])},Zotero.Library.prototype.fetchItemKeys=function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];Z.debug("Zotero.Library.fetchItemKeys",3);var t=this,r=Z.extend(!0,{target:"items",libraryType:this.libraryType,libraryID:this.libraryID,format:"keys"},e);return t.ajaxRequest(r)},Zotero.Library.prototype.getTrashKeys=function(){Z.debug("Zotero.Library.getTrashKeys",3);var e=this,t={target:"items",libraryType:e.libraryType,libraryID:e.libraryID,format:"keys",collectionKey:"trash"};return e.ajaxRequest(t)},Zotero.Library.prototype.emptyTrash=function(){Z.debug("Zotero.Library.emptyTrash",3);var e=this;return e.getTrashKeys().then(function(t){var r=t.data.split("\n");return e.items.deleteItems(r,t.lastModifiedVersion)})},Zotero.Library.prototype.loadItemKeys=function(e){Z.debug("Zotero.Library.loadItemKeys",3);var t=this;return this.fetchItemKeys(e).then(function(e){Z.debug("loadItemKeys proxied callback",3);var r=e.data.split(/[\s]+/);t.itemKeys=r})},Zotero.Library.prototype.loadItems=function(e){Z.debug("Zotero.Library.loadItems",3);var t=this;e||(e={});var r={target:"items",targetModifier:"top",start:0,limit:25,order:Zotero.config.defaultSortColumn,sort:Zotero.config.defaultSortOrder},o=Z.extend({},r,e),i=Z.extend({target:"items",libraryType:t.libraryType,libraryID:t.libraryID},o),n=Zotero.ajax.apiRequestString(i);return t.ajaxRequest(n).then(function(e){Z.debug("loadItems proxied callback",3);var r=t.items,o=r.addItemsFromJson(e.data);Z.debug("Looping over loadedItemsArray");for(var i=0;i<o.length;i++)o[i].associateWithLibrary(t);return e.loadedItems=o,Zotero.trigger("itemsChanged",{library:t}),e})},Zotero.Library.prototype.loadPublications=function(e){Z.debug("Zotero.Library.loadPublications",3);var t=this;e||(e={});var r={target:"publications",start:0,limit:50,order:Zotero.config.defaultSortColumn,sort:Zotero.config.defaultSortOrder,include:"bib"},o=Z.extend({},r,e),i=Z.extend({target:"publications",libraryType:t.libraryType,libraryID:t.libraryID},o),n=Zotero.ajax.apiRequestString(i);return t.ajaxRequest(n).then(function(e){Z.debug("loadPublications proxied callback",3);var t=[],r=e.data;return r.forEach(function(e){var r=new Zotero.Item(e);t.push(r)}),e.publicationItems=t,e})},Zotero.Library.prototype.processLoadedItems=function(e){Z.debug("processLoadedItems",3);for(var t=this,r=t.items,o=r.addItemsFromJson(e.data),i=0;i<o.length;i++)o[i].associateWithLibrary(t);return t.items.updateSyncState(e.lastModifiedVersion),Zotero.trigger("itemsChanged",{library:t,loadedItems:o}),e},Zotero.Library.prototype.loadItem=function(e){Z.debug("Zotero.Library.loadItem",3);var t=this;if(!r)var r={};var o={target:"item",libraryType:t.libraryType,libraryID:t.libraryID,itemKey:e};return t.ajaxRequest(o).then(function(e){Z.debug("Got loadItem response");var r=new Zotero.Item(e.data);return r.owningLibrary=t,t.items.itemObjects[r.key]=r,Zotero.trigger("itemsChanged",{library:t}),r},function(e){Z.debug("Error loading Item")})},Zotero.Library.prototype.trashItem=function(e){var t=this;return t.items.trashItems([t.items.getItem(e)])},Zotero.Library.prototype.untrashItem=function(e){if(Z.debug("Zotero.Library.untrashItem",3),!e)return!1;var t=this.items.getItem(e);return t.apiObj.deleted=0,t.writeItem()},Zotero.Library.prototype.deleteItem=function(e){Z.debug("Zotero.Library.deleteItem",3);var t=this;return t.items.deleteItem(e)},Zotero.Library.prototype.deleteItems=function(e){Z.debug("Zotero.Library.deleteItems",3);var t=this;return t.items.deleteItems(e)},Zotero.Library.prototype.addNote=function(e,t){Z.debug("Zotero.Library.prototype.addNote",3);var r=this,o={target:"children",libraryType:r.libraryType,libraryID:r.libraryID,itemKey:e},i=Zotero.ajax.apiRequestString(o);this.items.getItem(e);return r.ajaxRequest(i,"POST",{processData:!1})},Zotero.Library.prototype.fetchGlobalItems=function(e){Z.debug("Zotero.Library.fetchGlobalItems",3);var t=this;e||(e={});var r={target:"items",start:0,limit:25},o=Z.extend({},r,e),i=Z.extend({target:"items",libraryType:""},o),n=Zotero.ajax.apiRequestString(i);return t.ajaxRequest(n,"GET",{dataType:"json"}).then(function(e){return Z.debug("globalItems callback",3),e.data})},Zotero.Library.prototype.fetchGlobalItem=function(e){Z.debug("Zotero.Library.fetchGlobalItem",3),Z.debug(e);var t=this,r={target:"item"},o=Z.extend({},r),i=Z.extend({target:"item",libraryType:"",itemKey:e},o),n=Zotero.ajax.apiRequestString(i);return t.ajaxRequest(n,"GET",{dataType:"json"}).then(function(e){return Z.debug("globalItem callback",3),e.data})},Zotero.Library.prototype.fetchTags=function(e){Z.debug("Zotero.Library.fetchTags",3);var t={target:"tags",order:"title",sort:"asc",limit:100},r=Z.extend({},t,e),o=Z.extend({target:"tags",libraryType:this.libraryType,libraryID:this.libraryID},r);return Zotero.ajaxRequest(o)},Zotero.Library.prototype.loadTags=function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];Z.debug("Zotero.Library.loadTags",3);var t=this;return e.showAutomaticTags&&e.collectionKey&&delete e.collectionKey,t.tags.displayTagsArray=[],t.fetchTags(e).then(function(e){Z.debug("loadTags proxied callback",3);var r=e.lastModifiedVersion;t.tags.updateSyncState(r);t.tags.addTagsFromJson(e.data);return t.tags.updateTagsVersion(r),t.tags.rebuildTagsArray(),e.parsedLinks.hasOwnProperty("next")?(t.tags.hasNextLink=!0,t.tags.nextLink=e.parsedLinks.next):(t.tags.hasNextLink=!1,t.tags.nextLink=null),t.trigger("tagsChanged",{library:t}),t.tags})},Zotero.Library.prototype.loadAllTags=function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];Z.debug("Zotero.Library.loadAllTags",3);var t=this,r={target:"tags",order:"title",sort:"asc",limit:100,libraryType:t.libraryType,libraryID:t.libraryID},o=Z.extend({},r,e),i=Z.extend({},o),n=Zotero.ajax.apiRequestString(i),a=t.tags,s=(Z.extend({},r,a.loadedConfig),a.loadedRequestUrl);return Z.debug("requestUrl: "+n,4),Z.debug("loadedConfigRequestUrl: "+s,4),new Promise(function(r,o){var a=function s(r){Z.debug("loadAllTags continueLoadingCallback",3);var o=Zotero.Tags.prototype.plainTagsList(r.tagsArray);if(o.sort(Zotero.Library.prototype.comparer()),r.plainList=o,r.hasNextLink){Z.debug("still has next link.",3),r.tagsArray.sort(Zotero.Tag.prototype.tagComparer()),o=Zotero.Tags.prototype.plainTagsList(r.tagsArray),o.sort(Zotero.Library.prototype.comparer()),r.plainList=o;var i=r.nextLink,a=Zotero.utils.parseQuery(Zotero.utils.querystring(i)),c=Z.extend({},e);return c.start=a.start,c.limit=a.limit,t.loadTags(c).then(s)}Z.debug("no next in tags link",3),r.updateSyncedVersion(),r.tagsArray.sort(Zotero.Tag.prototype.tagComparer()),o=Zotero.Tags.prototype.plainTagsList(r.tagsArray),o.sort(Zotero.Library.prototype.comparer()),r.plainList=o,Z.debug("resolving loadTags deferred",3),t.tagsLoaded=!0,t.tags.loaded=!0,r.loadedConfig=e,r.loadedRequestUrl=n;for(var l=0;l<t.tags.tagsArray.length;l++)r.tagsArray[l].apiObj.version=r.tagsVersion;return t.trigger("tagsChanged",{library:t}),r};r(t.loadTags(i).then(a))})},Zotero.Library.prototype.loadIndexedDBCache=function(){Zotero.debug("Zotero.Library.loadIndexedDBCache",3);var e=this,t=e.idbLibrary.getAllItems(),r=e.idbLibrary.getAllCollections(),o=e.idbLibrary.getAllTags();return t.then(function(t){Z.debug("loadIndexedDBCache itemsD done",3);for(var r=0,o=0;o<t.length;o++){var i=new Zotero.Item(t[o]);e.items.addItem(i),i.version>r&&(r=i.version)}e.items.itemsVersion=r,e.items.loaded=!0,Z.debug("Done loading indexedDB items promise into library",3)}),r.then(function(t){Z.debug("loadIndexedDBCache collectionsD done",3);for(var r=0,o=0;o<t.length;o++){var i=new Zotero.Collection(t[o]);e.collections.addCollection(i),i.version>r&&(r=i.version)}e.collections.collectionsVersion=r,e.collections.initSecondaryData(),e.collections.loaded=!0}),o.then(function(t){Z.debug("loadIndexedDBCache tagsD done",3),Z.debug(t);for(var r=0,o=0,i=0;i<t.length;i++){var n=new Zotero.Tag(t[i]);e.tags.addTag(n),t[i].version>r&&(r=t[i].version)}o=r,e.tags.tagsVersion=o,e.tags.loaded=!0}),Promise.all([t,r,o])},Zotero.Library.prototype.saveIndexedDB=function(){var e=this,t=e.idbLibrary.updateItems(e.items.itemsArray),r=e.idbLibrary.updateCollections(e.collections.collectionsArray),o=e.idbLibrary.updateTags(e.tags.tagsArray);return Promise.all([t,r,o])},Zotero.Preferences=function(e,t){this.store=e,this.idString=t,this.preferencesObject={},this.defaults={debug_level:3,debug_log:!0,debug_mock:!1,listDisplayedFields:["title","creator","dateModified"],showAutomaticTags:!1,itemsPerPage:25,order:"title",title:"asc"},this.load()},Zotero.Preferences.prototype.setPref=function(e,t){var r=this;r.preferencesObject[e]=t,r.persist()},Zotero.Preferences.prototype.setPrefs=function(e){var t=this;if("object"!=("undefined"==typeof e?"undefined":_typeof(e)))throw new Error("Preferences must be an object");t.preferencesObject=e,t.persist()},Zotero.Preferences.prototype.getPref=function(e){var t=this;return t.preferencesObject[e]?t.preferencesObject[e]:t.defaults[e]?t.defaults[e]:null},Zotero.Preferences.prototype.getPrefs=function(){var e=this;return e.preferencesObject},Zotero.Preferences.prototype.persist=function(){var e=this,t="preferences_"+e.idString;e.store[t]=JSON.stringify(e.preferencesObject)},Zotero.Preferences.prototype.load=function(){var e=this,t="preferences_"+e.idString,r=e.store[t];r?e.preferencesObject=JSON.parse(r):e.preferencesObject={}},Zotero.Library.prototype.syncLibrary=function(e){var t=this;t.loadUpdatedCollections().then(function(){return t.loadUpdatedItems()})};