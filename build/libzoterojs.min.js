/*! libzoterojs 2015-11-20 */
"use strict";function _typeof(a){return a&&"undefined"!=typeof Symbol&&a.constructor===Symbol?"symbol":typeof a}!function(a,b){function c(a){return"string"==typeof a}function d(a){var b=w.call(arguments,1);return function(){return a.apply(this,b.concat(w.call(arguments)))}}function e(a){return a.replace(s,"$2")}function f(a){return a.replace(/(?:^[^?#]*\?([^#]*).*$)?.*/,"$1")}function g(b,d,e,f,g){var h,i,l,n,o;return f!==j?(l=e.match(b?s:/^([^#?]*)\??([^#]*)(#?.*)/),o=l[3]||"",2===g&&c(f)?i=f.replace(b?r:H,""):(n=m(l[2]),f=c(f)?m[b?D:C](f):f,i=2===g?f:1===g?a.extend({},f,n):a.extend({},n,f),i=k(i),b&&(i=i.replace(t,x))),h=l[1]+(b?v:i||!l[1]?"?":"")+i+o):h=d(e!==j?e:location.href),h}function h(a,b,d){return b===j||"boolean"==typeof b?(d=b,b=y[a?D:C]()):b=c(b)?b.replace(a?r:H,""):b,m(b,d)}function i(b,d,e,f){return c(e)||"object"===("undefined"==typeof e?"undefined":_typeof(e))||(f=e,e=d,d=j),this.each(function(){var c=a(this),g=d||q()[(this.nodeName||"").toLowerCase()]||"",h=g&&c.attr(g)||"";c.attr(g,y[b](h,e,f))})}var j,k,l,m,n,o,p,q,r,s,t,u,v,w=Array.prototype.slice,x=decodeURIComponent,y=a.param,z=a.bbq=a.bbq||{},A=a.event.special,B="hashchange",C="querystring",D="fragment",E="elemUrlAttr",F="href",G="src",H=/^.*\?|#.*$/g,I={};y[C]=d(g,0,f),y[D]=l=d(g,1,e),y.sorted=k=function(b,c){var d=[],e={};return a.each(y(b,c).split("&"),function(a,b){var c=b.replace(/(?:%5B|=).*$/,""),f=e[c];f||(f=e[c]=[],d.push(c)),f.push(b)}),a.map(d.sort(),function(a){return e[a]}).join("&")},l.noEscape=function(b){b=b||"";var c=a.map(b.split(""),encodeURIComponent);t=new RegExp(c.join("|"),"g")},l.noEscape(",/"),l.ajaxCrawlable=function(a){return a!==j&&(a?(r=/^.*(?:#!|#)/,s=/^([^#]*)(?:#!|#)?(.*)$/,v="#!"):(r=/^.*#/,s=/^([^#]*)#?(.*)$/,v="#"),u=!!a),u},l.ajaxCrawlable(0),a.deparam=m=function(b,c){var d={},e={"true":!0,"false":!1,"null":null};return a.each(b.replace(/\+/g," ").split("&"),function(b,f){var g,h=f.split("="),i=x(h[0]),k=d,l=0,m=i.split("]["),n=m.length-1;if(/\[/.test(m[0])&&/\]$/.test(m[n])?(m[n]=m[n].replace(/\]$/,""),m=m.shift().split("[").concat(m),n=m.length-1):n=0,2===h.length)if(g=x(h[1]),c&&(g=g&&!isNaN(g)?+g:"undefined"===g?j:e[g]!==j?e[g]:g),n)for(;n>=l;l++)i=""===m[l]?k.length:m[l],k=k[i]=n>l?k[i]||(m[l+1]&&isNaN(m[l+1])?{}:[]):g;else a.isArray(d[i])?d[i].push(g):d[i]!==j?d[i]=[d[i],g]:d[i]=g;else i&&(d[i]=c?j:"")}),d},m[C]=d(h,0),m[D]=n=d(h,1),a[E]||(a[E]=function(b){return a.extend(I,b)})({a:F,base:F,iframe:G,img:G,input:G,form:"action",link:F,script:G}),q=a[E],a.fn[C]=d(i,C),a.fn[D]=d(i,D),z.pushState=o=function(a,b){c(a)&&/^#/.test(a)&&b===j&&(b=2);var d=a!==j,e=l(location.href,d?a:{},d?b:2);location.href=e},z.getState=p=function(a,b){return a===j||"boolean"==typeof a?n(a):n(b)[a]},z.removeState=function(b){var c={};b!==j&&(c=p(),a.each(a.isArray(b)?b:arguments,function(a,b){delete c[b]})),o(c,2)},A[B]=a.extend(A[B],{add:function(b){function c(a){var b=a[D]=l();a.getState=function(a,c){return a===j||"boolean"==typeof a?m(b,a):m(b,c)[a]},d.apply(this,arguments)}var d;return a.isFunction(b)?(d=b,c):(d=b.handler,void(b.handler=c))}})}(jQuery,void 0),!function(){var a,b,c,d;!function(){var e={},f={};a=function(a,b,c){e[a]={deps:b,callback:c}},d=c=b=function(a){function c(b){if("."!==b.charAt(0))return b;for(var c=b.split("/"),d=a.split("/").slice(0,-1),e=0,f=c.length;f>e;e++){var g=c[e];if(".."===g)d.pop();else{if("."===g)continue;d.push(g)}}return d.join("/")}if(d._eak_seen=e,f[a])return f[a];if(f[a]={},!e[a])throw new Error("Could not find module "+a);for(var g,h=e[a],i=h.deps,j=h.callback,k=[],l=0,m=i.length;m>l;l++)"exports"===i[l]?k.push(g={}):k.push(b(c(i[l])));var n=j.apply(this,k);return f[a]=g||n}}(),a("promise/all",["./utils","exports"],function(a,b){function c(a){var b=this;if(!d(a))throw new TypeError("You must pass an array to all.");return new b(function(b,c){function d(a){return function(b){f(a,b)}}function f(a,c){h[a]=c,0===--i&&b(h)}var g,h=[],i=a.length;0===i&&b([]);for(var j=0;j<a.length;j++)g=a[j],g&&e(g.then)?g.then(d(j),c):f(j,g)})}var d=a.isArray,e=a.isFunction;b.all=c}),a("promise/asap",["exports"],function(a){function b(){return function(){process.nextTick(e)}}function c(){var a=0,b=new i(e),c=document.createTextNode("");return b.observe(c,{characterData:!0}),function(){c.data=a=++a%2}}function d(){return function(){j.setTimeout(e,1)}}function e(){for(var a=0;a<k.length;a++){var b=k[a],c=b[0],d=b[1];c(d)}k=[]}function f(a,b){var c=k.push([a,b]);1===c&&g()}var g,h="undefined"!=typeof window?window:{},i=h.MutationObserver||h.WebKitMutationObserver,j="undefined"!=typeof global?global:this,k=[];g="undefined"!=typeof process&&"[object process]"==={}.toString.call(process)?b():i?c():d(),a.asap=f}),a("promise/cast",["exports"],function(a){function b(a){if(a&&"object"==("undefined"==typeof a?"undefined":_typeof(a))&&a.constructor===this)return a;var b=this;return new b(function(b){b(a)})}a.cast=b}),a("promise/config",["exports"],function(a){function b(a,b){return 2!==arguments.length?c[a]:void(c[a]=b)}var c={instrument:!1};a.config=c,a.configure=b}),a("promise/polyfill",["./promise","./utils","exports"],function(a,b,c){function d(){var a="Promise"in window&&"cast"in window.Promise&&"resolve"in window.Promise&&"reject"in window.Promise&&"all"in window.Promise&&"race"in window.Promise&&function(){var a;return new window.Promise(function(b){a=b}),f(a)}();a||(window.Promise=e)}var e=a.Promise,f=b.isFunction;c.polyfill=d}),a("promise/promise",["./config","./utils","./cast","./all","./race","./resolve","./reject","./asap","exports"],function(a,b,c,d,e,f,g,h,i){function j(a){if(!w(a))throw new TypeError("You must pass a resolver function as the first argument to the promise constructor");if(!(this instanceof j))throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.");this._subscribers=[],k(a,this)}function k(a,b){function c(a){p(b,a)}function d(a){r(b,a)}try{a(c,d)}catch(e){d(e)}}function l(a,b,c,d){var e,f,g,h,i=w(c);if(i)try{e=c(d),g=!0}catch(j){h=!0,f=j}else e=d,g=!0;o(b,e)||(i&&g?p(b,e):h?r(b,f):a===F?p(b,e):a===G&&r(b,e))}function m(a,b,c,d){var e=a._subscribers,f=e.length;e[f]=b,e[f+F]=c,e[f+G]=d}function n(a,b){for(var c,d,e=a._subscribers,f=a._detail,g=0;g<e.length;g+=3)c=e[g],d=e[g+b],l(b,c,d,f);a._subscribers=null}function o(a,b){var c,d=null;try{if(a===b)throw new TypeError("A promises callback cannot return that same promise.");if(v(b)&&(d=b.then,w(d)))return d.call(b,function(d){return c?!0:(c=!0,void(b!==d?p(a,d):q(a,d)))},function(b){return c?!0:(c=!0,void r(a,b))}),!0}catch(e){return c?!0:(r(a,e),!0)}return!1}function p(a,b){a===b?q(a,b):o(a,b)||q(a,b)}function q(a,b){a._state===D&&(a._state=E,a._detail=b,u.async(s,a))}function r(a,b){a._state===D&&(a._state=E,a._detail=b,u.async(t,a))}function s(a){n(a,a._state=F)}function t(a){n(a,a._state=G)}var u=a.config,v=(a.configure,b.objectOrFunction),w=b.isFunction,x=(b.now,c.cast),y=d.all,z=e.race,A=f.resolve,B=g.reject,C=h.asap;u.async=C;var D=void 0,E=0,F=1,G=2;j.prototype={constructor:j,_state:void 0,_detail:void 0,_subscribers:void 0,then:function(a,b){var c=this,d=new this.constructor(function(){});if(this._state){var e=arguments;u.async(function(){l(c._state,d,e[c._state-1],c._detail)})}else m(this,d,a,b);return d},"catch":function(a){return this.then(null,a)}},j.all=y,j.cast=x,j.race=z,j.resolve=A,j.reject=B,i.Promise=j}),a("promise/race",["./utils","exports"],function(a,b){function c(a){var b=this;if(!d(a))throw new TypeError("You must pass an array to race.");return new b(function(b,c){for(var d,e=0;e<a.length;e++)d=a[e],d&&"function"==typeof d.then?d.then(b,c):b(d)})}var d=a.isArray;b.race=c}),a("promise/reject",["exports"],function(a){function b(a){var b=this;return new b(function(b,c){c(a)})}a.reject=b}),a("promise/resolve",["exports"],function(a){function b(a){var b=this;return new b(function(b){b(a)})}a.resolve=b}),a("promise/utils",["exports"],function(a){function b(a){return c(a)||"object"==("undefined"==typeof a?"undefined":_typeof(a))&&null!==a}function c(a){return"function"==typeof a}function d(a){return"[object Array]"===Object.prototype.toString.call(a)}var e=Date.now||function(){return(new Date).getTime()};a.objectOrFunction=b,a.isFunction=c,a.isArray=d,a.now=e}),b("promise/polyfill").polyfill()}(),function(a){if("object"===("undefined"==typeof exports?"undefined":_typeof(exports)))module.exports=a();else if("function"==typeof define&&define.amd)define(a);else{var b;try{b=window}catch(c){b=self}b.SparkMD5=a()}}(function(a){var b=function(a,b){return a+b&4294967295},c=function(a,c,d,e,f,g){return c=b(b(c,a),b(e,g)),b(c<<f|c>>>32-f,d)},d=function(a,b,d,e,f,g,h){return c(b&d|~b&e,a,b,f,g,h)},e=function(a,b,d,e,f,g,h){return c(b&e|d&~e,a,b,f,g,h)},f=function(a,b,d,e,f,g,h){return c(b^d^e,a,b,f,g,h)},g=function(a,b,d,e,f,g,h){return c(d^(b|~e),a,b,f,g,h)},h=function(a,c){var h=a[0],i=a[1],j=a[2],k=a[3];h=d(h,i,j,k,c[0],7,-680876936),k=d(k,h,i,j,c[1],12,-389564586),j=d(j,k,h,i,c[2],17,606105819),i=d(i,j,k,h,c[3],22,-1044525330),h=d(h,i,j,k,c[4],7,-176418897),k=d(k,h,i,j,c[5],12,1200080426),j=d(j,k,h,i,c[6],17,-1473231341),i=d(i,j,k,h,c[7],22,-45705983),h=d(h,i,j,k,c[8],7,1770035416),k=d(k,h,i,j,c[9],12,-1958414417),j=d(j,k,h,i,c[10],17,-42063),i=d(i,j,k,h,c[11],22,-1990404162),h=d(h,i,j,k,c[12],7,1804603682),k=d(k,h,i,j,c[13],12,-40341101),j=d(j,k,h,i,c[14],17,-1502002290),i=d(i,j,k,h,c[15],22,1236535329),h=e(h,i,j,k,c[1],5,-165796510),k=e(k,h,i,j,c[6],9,-1069501632),j=e(j,k,h,i,c[11],14,643717713),i=e(i,j,k,h,c[0],20,-373897302),h=e(h,i,j,k,c[5],5,-701558691),k=e(k,h,i,j,c[10],9,38016083),j=e(j,k,h,i,c[15],14,-660478335),i=e(i,j,k,h,c[4],20,-405537848),h=e(h,i,j,k,c[9],5,568446438),k=e(k,h,i,j,c[14],9,-1019803690),j=e(j,k,h,i,c[3],14,-187363961),i=e(i,j,k,h,c[8],20,1163531501),h=e(h,i,j,k,c[13],5,-1444681467),k=e(k,h,i,j,c[2],9,-51403784),j=e(j,k,h,i,c[7],14,1735328473),i=e(i,j,k,h,c[12],20,-1926607734),h=f(h,i,j,k,c[5],4,-378558),k=f(k,h,i,j,c[8],11,-2022574463),j=f(j,k,h,i,c[11],16,1839030562),i=f(i,j,k,h,c[14],23,-35309556),h=f(h,i,j,k,c[1],4,-1530992060),k=f(k,h,i,j,c[4],11,1272893353),j=f(j,k,h,i,c[7],16,-155497632),i=f(i,j,k,h,c[10],23,-1094730640),h=f(h,i,j,k,c[13],4,681279174),k=f(k,h,i,j,c[0],11,-358537222),j=f(j,k,h,i,c[3],16,-722521979),i=f(i,j,k,h,c[6],23,76029189),h=f(h,i,j,k,c[9],4,-640364487),k=f(k,h,i,j,c[12],11,-421815835),j=f(j,k,h,i,c[15],16,530742520),i=f(i,j,k,h,c[2],23,-995338651),h=g(h,i,j,k,c[0],6,-198630844),k=g(k,h,i,j,c[7],10,1126891415),j=g(j,k,h,i,c[14],15,-1416354905),i=g(i,j,k,h,c[5],21,-57434055),h=g(h,i,j,k,c[12],6,1700485571),k=g(k,h,i,j,c[3],10,-1894986606),j=g(j,k,h,i,c[10],15,-1051523),i=g(i,j,k,h,c[1],21,-2054922799),h=g(h,i,j,k,c[8],6,1873313359),k=g(k,h,i,j,c[15],10,-30611744),j=g(j,k,h,i,c[6],15,-1560198380),i=g(i,j,k,h,c[13],21,1309151649),h=g(h,i,j,k,c[4],6,-145523070),k=g(k,h,i,j,c[11],10,-1120210379),j=g(j,k,h,i,c[2],15,718787259),i=g(i,j,k,h,c[9],21,-343485551),a[0]=b(h,a[0]),a[1]=b(i,a[1]),a[2]=b(j,a[2]),a[3]=b(k,a[3])},i=function(a){var b,c=[];for(b=0;64>b;b+=4)c[b>>2]=a.charCodeAt(b)+(a.charCodeAt(b+1)<<8)+(a.charCodeAt(b+2)<<16)+(a.charCodeAt(b+3)<<24);return c},j=function(a){var b,c=[];for(b=0;64>b;b+=4)c[b>>2]=a[b]+(a[b+1]<<8)+(a[b+2]<<16)+(a[b+3]<<24);return c},k=function(a){var b,c,d,e,f,g,j=a.length,k=[1732584193,-271733879,-1732584194,271733878];for(b=64;j>=b;b+=64)h(k,i(a.substring(b-64,b)));for(a=a.substring(b-64),c=a.length,d=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],b=0;c>b;b+=1)d[b>>2]|=a.charCodeAt(b)<<(b%4<<3);if(d[b>>2]|=128<<(b%4<<3),b>55)for(h(k,d),b=0;16>b;b+=1)d[b]=0;return e=8*j,e=e.toString(16).match(/(.*?)(.{0,8})$/),f=parseInt(e[2],16),g=parseInt(e[1],16)||0,d[14]=f,d[15]=g,h(k,d),k},l=function(a){var b,c,d,e,f,g,i=a.length,k=[1732584193,-271733879,-1732584194,271733878];for(b=64;i>=b;b+=64)h(k,j(a.subarray(b-64,b)));for(a=i>b-64?a.subarray(b-64):new Uint8Array(0),c=a.length,d=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],b=0;c>b;b+=1)d[b>>2]|=a[b]<<(b%4<<3);if(d[b>>2]|=128<<(b%4<<3),b>55)for(h(k,d),b=0;16>b;b+=1)d[b]=0;return e=8*i,e=e.toString(16).match(/(.*?)(.{0,8})$/),f=parseInt(e[2],16),g=parseInt(e[1],16)||0,d[14]=f,d[15]=g,h(k,d),k},m=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],n=function(a){var b,c="";for(b=0;4>b;b+=1)c+=m[a>>8*b+4&15]+m[a>>8*b&15];return c},o=function(a){var b;for(b=0;b<a.length;b+=1)a[b]=n(a[b]);return a.join("")},p=function(a){return o(k(a))},q=function(){this.reset()};return"5d41402abc4b2a76b9719d911017c592"!==p("hello")&&(b=function(a,b){var c=(65535&a)+(65535&b),d=(a>>16)+(b>>16)+(c>>16);return d<<16|65535&c}),q.prototype.append=function(a){return/[\u0080-\uFFFF]/.test(a)&&(a=unescape(encodeURIComponent(a))),this.appendBinary(a),this},q.prototype.appendBinary=function(a){this._buff+=a,this._length+=a.length;var b,c=this._buff.length;for(b=64;c>=b;b+=64)h(this._state,i(this._buff.substring(b-64,b)));return this._buff=this._buff.substr(b-64),this},q.prototype.end=function(a){var b,c,d=this._buff,e=d.length,f=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(b=0;e>b;b+=1)f[b>>2]|=d.charCodeAt(b)<<(b%4<<3);return this._finish(f,e),c=a?this._state:o(this._state),this.reset(),c},q.prototype._finish=function(a,b){var c,d,e,f=b;if(a[f>>2]|=128<<(f%4<<3),f>55)for(h(this._state,a),f=0;16>f;f+=1)a[f]=0;c=8*this._length,c=c.toString(16).match(/(.*?)(.{0,8})$/),d=parseInt(c[2],16),e=parseInt(c[1],16)||0,a[14]=d,a[15]=e,h(this._state,a)},q.prototype.reset=function(){return this._buff="",this._length=0,this._state=[1732584193,-271733879,-1732584194,271733878],this},q.prototype.destroy=function(){delete this._state,delete this._buff,delete this._length},q.hash=function(a,b){/[\u0080-\uFFFF]/.test(a)&&(a=unescape(encodeURIComponent(a)));var c=k(a);return b?c:o(c)},q.hashBinary=function(a,b){var c=k(a);return b?c:o(c)},q.ArrayBuffer=function(){this.reset()},q.ArrayBuffer.prototype.append=function(a){var b,c=this._concatArrayBuffer(this._buff,a),d=c.length;for(this._length+=a.byteLength,b=64;d>=b;b+=64)h(this._state,j(c.subarray(b-64,b)));return this._buff=d>b-64?c.subarray(b-64):new Uint8Array(0),this},q.ArrayBuffer.prototype.end=function(a){var b,c,d=this._buff,e=d.length,f=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(b=0;e>b;b+=1)f[b>>2]|=d[b]<<(b%4<<3);return this._finish(f,e),c=a?this._state:o(this._state),this.reset(),c},q.ArrayBuffer.prototype._finish=q.prototype._finish,q.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._state=[1732584193,-271733879,-1732584194,271733878],this},q.ArrayBuffer.prototype.destroy=q.prototype.destroy,q.ArrayBuffer.prototype._concatArrayBuffer=function(a,b){var c=a.length,d=new Uint8Array(c+b.byteLength);return d.set(a),d.set(new Uint8Array(b),c),d},q.ArrayBuffer.hash=function(a,b){var c=l(new Uint8Array(a));return b?c:o(c)},q});var J=jQuery.noConflict(),Zotero={ajax:{},callbacks:{},ui:{callbacks:{},keyCode:{BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38}},url:{},utils:{},offline:{},temp:{},localizations:{},config:{librarySettings:{},baseApiUrl:"https://api.zotero.org",baseWebsiteUrl:"https://zotero.org",baseFeedUrl:"https://api.zotero.org",baseZoteroWebsiteUrl:"https://www.zotero.org",baseDownloadUrl:"https://www.zotero.org",debugLogEndpoint:"",storeDebug:!0,directDownloads:!0,proxyPath:"/proxyrequest",ignoreLoggedInStatus:!1,storePrefsRemote:!0,preferUrlItem:!0,sessionAuth:!1,proxy:!1,apiKey:"",ajax:1,apiVersion:3,eventful:!1,locale:"en-US",cacheStoreType:"localStorage",preloadCachedLibrary:!0,mobile:0,sortOrdering:{dateAdded:"desc",dateModified:"desc",date:"desc",year:"desc",accessDate:"desc",title:"asc",creator:"asc"},defaultSortColumn:"title",defaultSortOrder:"asc",largeFields:{title:1,abstractNote:1,extra:1},richTextFields:{note:1},maxFieldSummaryLength:{title:60},exportFormats:["bibtex","bookmarks","mods","refer","rdf_bibliontology","rdf_dc","rdf_zotero","ris","wikipedia"],exportFormatsMap:{bibtex:"BibTeX",bookmarks:"Bookmarks",mods:"MODS",refer:"Refer/BibIX",rdf_bibliontology:"Bibliontology RDF",rdf_dc:"Unqualified Dublin Core RDF",rdf_zotero:"Zotero RDF",ris:"RIS",wikipedia:"Wikipedia Citation Templates"},defaultApiArgs:{order:"title",sort:"asc",limit:50,start:0}},debug:function(a,b){var c=3;Zotero.config.storeDebug&&c>=b&&(Zotero.debugstring+="DEBUG:"+a+"\n"),"undefined"!=typeof console&&("number"!=typeof b&&(b=1),void 0!==Zotero.preferences&&(c=Zotero.preferences.getPref("debug_level")),c>=b&&console.log(a))},warn:function(a){Zotero.config.storeDebug&&(Zotero.debugstring+="WARN:"+a+"\n"),"undefined"==typeof console||"undefined"==typeof console.warn?this.debug(a):console.warn(a)},error:function(a){Zotero.config.storeDebug&&(Zotero.debugstring+="ERROR:"+a+"\n"),"undefined"==typeof console||"undefined"==typeof console.error?this.debug(a):console.error(a)},submitDebugLog:function(){response=J.post(Zotero.config.debugLogEndpoint,{debug_string:Zotero.debugstring},function(a){a.logID?alert("ZoteroWWW debug logID:"+a.logID):a.error&&alert("Error submitting ZoteroWWW debug log:"+a.error)})},catchPromiseError:function(a){Zotero.error(a)},libraries:{},validator:{patterns:{itemKey:/^.+$/,collectionKey:/^([A-Z0-9]{8,})|trash$/,libraryID:/^[0-9]+$/,libraryType:/^(user|group|)$/,target:/^(items?|collections?|tags|children|deleted|userGroups|key|settings|publications)$/,targetModifier:/^(top|file|file\/view)$/,sort:/^(asc|desc)$/,start:/^[0-9]*$/,limit:/^[0-9]*$/,order:/^\S*$/,content:/^((html|json|data|bib|none|bibtex|bookmarks|coins|csljson|mods|refer|rdf_bibliontology|rdf_dc|ris|tei|wikipedia),?)+$/,include:/^((html|json|data|bib|none|bibtex|bookmarks|coins|csljson|mods|refer|rdf_bibliontology|rdf_dc|ris|tei|wikipedia),?)+$/,q:/^.*$/,fq:/^\S*$/,itemType:/^\S*$/,locale:/^\S*$/,tag:/^.*$/,tagType:/^(0|1)$/,key:/^\S*/,format:/^(json|atom|bib|keys|versions|bibtex|bookmarks|mods|refer|rdf_bibliontology|rdf_dc|rdf_zotero|ris|wikipedia)$/,style:/^\S*$/,linkwrap:/^(0|1)*$/},validate:function(a,b){if(Z.debug("Zotero.validate",4),""===a)return null;if(null===a)return!0;Z.debug(a+" "+b,4);var c=this.patterns;return c.hasOwnProperty(b)?c[b].test(a):null}},_logEnabled:0,enableLogging:function(){Zotero._logEnabled++,Zotero._logEnabled>0},disableLogging:function(){Zotero._logEnabled--,Zotero._logEnabled<=0&&(Zotero._logEnabled=0)},init:function(){var a;a="localStorage"==Zotero.config.cacheStoreType&&"undefined"!=typeof localStorage?localStorage:"sessionStorage"==Zotero.config.cacheStoreType&&"undefined"!=typeof sessionStorage?sessionStorage:{},Zotero.store=a,Zotero.cache=new Zotero.Cache(a),Zotero.preferences=new Zotero.Preferences(Zotero.store,"global");var b="en-US";Zotero.config.locale&&(b=Zotero.config.locale),b="en-US",J.ajaxSettings.traditional=!0}};Zotero.Cache=function(a){this.store=a;var b=this.store._registry;(null===b||"undefined"==typeof b)&&(b={},this.store._registry=JSON.stringify(b))},Zotero.Cache.prototype.objectCacheString=function(a){var b=[];J.each(a,function(a,c){c&&(c instanceof Array?J.each(c,function(c,d){b.push(a+"/"+encodeURIComponent(d))}):b.push(a+"/"+encodeURIComponent(c)))}),b.sort(),Z.debug(b,4);var c=b.join("/");return c},Zotero.Cache.prototype.save=function(a,b,c){J.isArray(c)||(c=[]);var d=JSON.parse(this.store._registry);d||(d={});var e=this.objectCacheString(a);this.store[e]=JSON.stringify(b);var f={id:e,saved:Date.now(),cachetags:c};d[e]=f,this.store._registry=JSON.stringify(d)},Zotero.Cache.prototype.load=function(a){Z.debug("Zotero.Cache.load",3);var b=this.objectCacheString(a);Z.debug(b,4);try{var c=this.store[b];return c?JSON.parse(c):(Z.warn("No value found in cache store - "+b,3),null)}catch(d){return Z.error("Error parsing retrieved cache data: "+b+" : "+c),null}},Zotero.Cache.prototype.expireCacheTag=function(a){Z.debug("Zotero.Cache.expireCacheTag",3);var b=JSON.parse(this.store._registry),c=this.store;J.each(b,function(d,e){-1!=J.inArray(a,e.cachetags)&&(Z.debug("tag "+a+" found for item "+e.id+" : expiring",4),delete c[e.id],delete b[e.id])})},Zotero.Cache.prototype.clear=function(){"function"==typeof this.store.clear?this.store.clear():this.store={}},Zotero.ajaxRequest=function(a,b,c){Z.debug("Zotero.ajaxRequest ==== "+a,3),b||(b="GET"),c||(c={});var d={url:a,type:b};return d=J.extend({},d,c),Z.debug(d,3),Zotero.net.queueRequest(d)},Zotero.trigger=function(a,b,c){c&&(Z.debug("filter is not false"),a+="_"+c),Zotero.debug("Triggering eventful "+a,3),b||(b={}),b.zeventful=!0,(null===b.triggeringElement||void 0===b.triggeringElement)&&(b.triggeringElement=J("#eventful")),Zotero.debug("Triggering eventful "+a,3);var d=J.Event(a,b);try{J("#eventful").trigger(d)}catch(d){Z.error("failed triggering:"+a),Z.error(d)}},Zotero.listen=function(a,b,c,d){if(d){var e=a.split(" ");if(e.length>0){for(var f=0;f<e.length;f++)e[f]+="_"+d;a=e.join(" ")}}Z.debug("listening on "+a,3),J("#eventful").on(a,null,c,b)};var Z=Zotero;Zotero.ajax.errorCallback=function(a){Z.error(a),Z.debug("ajax error callback",2),Z.debug("textStatus: "+a.textStatus,2),Z.debug("errorThrown: ",2),Z.debug(a.errorThrown,2),Z.debug(a.jqxhr,2)},Zotero.ajax.error=Zotero.ajax.errorCallback,Zotero.ajax.activeRequests=[],Zotero.ajax.apiRequestUrl=function(a){if(Z.debug("Zotero.ajax.apiRequestUrl",4),Z.debug(a,4),J.each(a,function(b,c){"string"==typeof c&&(c=c.split("#",1),a[b]=c[0]),Zotero.validator.validate(c,b)===!1&&(Zotero.warn("API argument failed validation: "+b+" cannot be "+c),Zotero.warn(a),delete a[b])}),!a.target)throw new Error("No target defined for api request");if("user"!=a.libraryType&&"group"!=a.libraryType&&""!==a.libraryType)throw new Error("Unexpected libraryType for api request "+JSON.stringify(a));if(a.libraryType&&!a.libraryID)throw new Error("No libraryID defined for api request");if("publications"==a.target&&"user"!=a.libraryType)throw new Error("publications is only valid for user libraries");var b,c=Zotero.config.baseApiUrl;if(""!==a.libraryType){if(b=c+"/"+a.libraryType+"s/"+a.libraryID,a.collectionKey){if("trash"==a.collectionKey)return b+="/items/trash";-1!==a.collectionKey.indexOf(",")||"collections"!=a.target&&(b+="/collections/"+a.collectionKey)}}else b=c;switch(a.target){case"items":b+="/items";break;case"item":b+=a.itemKey?"/items/"+a.itemKey:"/items";break;case"collections":b+="/collections";break;case"childCollections":b+="/collections";break;case"collection":break;case"tags":b+="/tags";break;case"children":b+="/items/"+a.itemKey+"/children";break;case"key":b=c+"/users/"+a.libraryID+"/keys/"+a.apiKey;break;case"deleted":b+="/deleted";break;case"userGroups":b=c+"/users/"+a.libraryID+"/groups";break;case"settings":b+="/settings/"+(a.settingsKey||"");break;case"publications":b+="/publications/items";break;default:return!1}switch(a.targetModifier){case"top":b+="/top";break;case"file":b+="/file";break;case"viewsnapshot":b+="/file/view"}return b},Zotero.ajax.apiQueryString=function(a,b){if(Z.debug("Zotero.ajax.apiQueryString",4),Z.debug(a,4),(null===b||"undefined"==typeof b)&&(b=!0),J.each(a,function(b,c){"string"==typeof c&&(c=c.split("#",1),a[b]=c[0])}),a.hasOwnProperty("order")&&"creatorSummary"==a.order&&(a.order="creator"),a.hasOwnProperty("order")&&"year"==a.order&&(a.order="date"),b&&Zotero.config.sessionAuth){var c=Zotero.utils.readCookie(Zotero.config.sessionCookieName);a.session=c}else b&&Zotero.config.apiKey&&(a.key=Zotero.config.apiKey);a.hasOwnProperty("sort")&&"undefined"==a.sort&&(a.sort="asc"),Z.debug(a,4);var d="?",e=[],f=["start","limit","order","sort","content","include","format","q","fq","itemType","itemKey","collectionKey","searchKey","locale","tag","tagType","key","style","linkMode","linkwrap","session","newer","since"];f.sort();var g={};return J.each(f,function(b,c){a.hasOwnProperty(c)&&""!==a[c]&&(g[c]=a[c])}),a.hasOwnProperty("target")&&"items"!==a.target&&g.hasOwnProperty("itemKey")&&-1==g.itemKey.indexOf(",")&&delete g.itemKey,a.hasOwnProperty("target")&&"collections"!==a.target&&g.hasOwnProperty("collectionKey")&&-1===g.collectionKey.indexOf(",")&&delete g.collectionKey,J.each(g,function(a,b){b instanceof Array?J.each(b,function(b,c){"tag"==a&&"-"==c[0]&&(c="\\"+c),e.push(encodeURIComponent(a)+"="+encodeURIComponent(c))}):("tag"==a&&"-"==b[0]&&(b="\\"+b),e.push(encodeURIComponent(a)+"="+encodeURIComponent(b)))}),d+=e.join("&")},Zotero.ajax.apiRequestString=function(a){return Zotero.ajax.apiRequestUrl(a)+Zotero.ajax.apiQueryString(a)},Zotero.ajax.proxyWrapper=function(a,b){return Zotero.config.proxy?(b||(b="GET"),Zotero.config.proxyPath+"?requestMethod="+b+"&requestUrl="+encodeURIComponent(a)):a},Zotero.ajax.parseQueryString=function(a){},Zotero.ajax.webUrl=function(a){},Zotero.ajax.downloadBlob=function(a){return new Promise(function(b,c){var d=new XMLHttpRequest;d.open("GET",a,!0),d.responseType="blob",d.addEventListener("load",function(){200===d.status?(Z.debug("downloadBlob Image retrieved. resolving",3),b(d.response)):c(d.response)}),d.send()})},Zotero.ApiObject=function(){this.instance="Zotero.ApiObject",this.version=0},Zotero.ApiObject.prototype.associateWithLibrary=function(a){var b=this;return b.owningLibrary=a,"object"==_typeof(this.apiObj.library)&&(this.apiObj.library.type=a.type,this.apiObj.library.id=a.libraryID),b},Zotero.ApiObject.prototype.fieldComparer=function(a){if(window.Intl){var b=new window.Intl.Collator;return function(c,d){return b.compare(c.apiObj.data[a],d.apiObj.data[a])}}return function(b,c){return b.apiObj.data[a].toLowerCase()==c.apiObj.data[a].toLowerCase()?0:b.apiObj.data[a].toLowerCase()<c.apiObj.data[a].toLowerCase()?-1:1}},Zotero.ApiResponse=function(a){Z.debug("Zotero.ApiResponse",3),this.totalResults=0,this.apiVersion=null,this.lastModifiedVersion=0,this.linkHeader="",this.links={},a&&(a.isError?this.isError=!0:this.isError=!1,this.data=a.data,this.parseResponse(a))},Zotero.ApiResponse.prototype.parseResponse=function(a){Z.debug("parseResponse");var b=this;if(b.jqxhr=a.jqxhr,b.status=a.jqxhr.status,b.lastModifiedVersion=a.jqxhr.getResponseHeader("Last-Modified-Version"),b.apiVersion=a.jqxhr.getResponseHeader("Zotero-API-Version"),b.backoff=a.jqxhr.getResponseHeader("Backoff"),b.retryAfter=a.jqxhr.getResponseHeader("Retry-After"),b.contentType=a.jqxhr.getResponseHeader("Content-Type"),b.linkHeader=a.jqxhr.getResponseHeader("Link"),b.totalResults=a.jqxhr.getResponseHeader("Total-Results"),b.backoff&&(b.backoff=parseInt(b.backoff,10)),b.retryAfter&&(b.retryAfter=parseInt(b.retryAfter,10)),Z.debug("parse link header"),Z.debug(b.linkHeader),b.linkHeader){for(var c=b.linkHeader.split(","),d={},e=/^<([^>]+)>; rel="([^\"]*)"$/,f=0;f<c.length;f++){var g=e.exec(c[f].trim());g[2]&&(d[g[2]]=g[1])}b.parsedLinks=d}Z.debug("done parsing response")},Zotero.Net=function(){this.deferredQueue=[],this.numRunning=0,this.numConcurrent=3,this.backingOff=!1},Zotero.Net.prototype.queueDeferred=function(){var a=this,b=new J.Deferred;return a.deferredQueue.push(b),Promise.resolve(b)},Zotero.Net.prototype.queueRequest=function(a){Z.debug("Zotero.Net.queueRequest",3);var b,c=this;return b=J.isArray(a)?c.queueDeferred().then(function(){return Z.debug("running sequential after queued deferred resolved",4),c.runSequential(a)}).then(function(a){return Z.debug("runSequential done",3),c.queuedRequestDone(),a}):c.queueDeferred().then(function(){return Z.debug("running concurrent after queued deferred resolved",4),c.runConcurrent(a)}).then(function(a){return Z.debug("done with queuedRequest"),c.queuedRequestDone(),a}),c.runNext(),b["catch"](function(a){Z.error("Error before leaving Zotero.Net"),Z.error(a)})},Zotero.Net.prototype.runConcurrent=function(a){return Z.debug("Zotero.Net.runConcurrent",3),this.ajaxRequest(a).then(function(a){return Z.debug("done with runConcurrent request"),a})},Zotero.Net.prototype.runSequential=function(a){Z.debug("Zotero.Net.runSequential",3);for(var b=this,c=[],d=Promise.resolve(),e=0;e<a.length;e++){var f=a[e];d=d.then(function(){var a=b.ajaxRequest(f).then(function(a){Z.debug("pushing sequential response into result array"),c.push(a)});return a})}return d.then(function(){return Z.debug("done with sequential aggregator promise - returning responses"),c})},Zotero.Net.prototype.individualRequestDone=function(a){Z.debug("Zotero.Net.individualRequestDone",3);var b=this,c=(Date.now(),b.checkDelay(a));if(c>0){waitms=1e3*c,b.backingOff=!0;var d=Date.now()+waitms;d>b.waitingExpires&&(b.waitingExpires=d),window.setTimeout(b.runNext,waitms)}return a},Zotero.Net.prototype.queuedRequestDone=function(a){Z.debug("queuedRequestDone",3);var b=this;return b.numRunning--,b.runNext(),a},Zotero.Net.prototype.runNext=function(){Z.debug("Zotero.Net.runNext",3);var a=this,b=Date.now();if(a.backingOff&&a.waitingExpires>b-100){Z.debug("currently backing off",3);var c=a.waitingExpires-b;return void window.setTimeout(a.runNext,c)}for(a.backingOff&&a.waitingExpires<=b-100&&(a.backingOff=!1),Z.debug(a.numRunning+"/"+a.numConcurrent+" Running. "+a.deferredQueue.length+" queued.",3);a.deferredQueue.length>0&&a.numRunning<a.numConcurrent;){a.numRunning++;var d=a.deferredQueue.shift();d.resolve(),Z.debug(a.numRunning+"/"+a.numConcurrent+" Running. "+a.deferredQueue.length+" queued.",3)}},Zotero.Net.prototype.checkDelay=function(a){Z.debug("Zotero.Net.checkDelay"),Z.debug(a);var b=this,c=0;if(J.isArray(a))for(var d=0;d<a.length;d++)iwait=b.checkDelay(a[d]),iwait>c&&(c=iwait);else 429==a.status?c=a.retryAfter:a.backoff&&(c=a.backoff);return c},Zotero.Net.prototype.ajaxRequest=function(a){Z.debug("Zotero.Net.ajaxRequest",3);var b=this,c={type:"GET",headers:{"Zotero-API-Version":Zotero.config.apiVersion,"Content-Type":"application/json"},success:function(a){return a},error:function(a){return Z.error("ajaxRequest rejected:"+a.jqxhr.statusCode()+" - "+a.jqxhr.responseText),a}},d=J.extend({},c.headers,a.headers),e=J.extend({},c,a);if(e.headers=d,"object"==_typeof(e.url)&&(e.url=Zotero.ajax.apiRequestString(e.url)),e.url=Zotero.ajax.proxyWrapper(e.url,e.type),!e.url)throw"No url specified in Zotero.Net.ajaxRequest";e.zsuccess=e.success,e.zerror=e.error,delete e.success,delete e.error;var f=new Promise(function(a,b){J.ajax(e).then(function(b,c,d){Z.debug("library.ajaxRequest jqxhr resolved. resolving Promise",3);var e=new Zotero.ApiResponse({jqxhr:d,data:b,textStatus:c});a(e)},function(a,c,d){Z.debug("library.ajaxRequest jqxhr rejected. rejecting Promise",3);var e=new Zotero.ApiResponse({jqxhr:a,textStatus:c,errorThrown:d,isError:!0});b(e)})}).then(J.proxy(b.individualRequestDone,b)).then(function(a){if(a.isError)throw Z.error("re-throwing ApiResponse that was a rejection"),a;return a}).then(e.zsuccess,e.zerror);return f},Zotero.net=new Zotero.Net,Zotero.Library=function(a,b,c,d){Z.debug("Zotero.Library constructor",3),Z.debug("Library Constructor: "+a+" "+b+" ",3);var e=this;if(Z.debug(c,4),e.instance="Zotero.Library",e.libraryVersion=0,e.syncState={earliestVersion:null,latestVersion:null},e._apiKey=d||"",Zotero.config.librarySettings?e.libraryBaseWebsiteUrl=Zotero.config.librarySettings.libraryPathString:(e.libraryBaseWebsiteUrl=Zotero.config.baseWebsiteUrl,"group"==a&&(e.libraryBaseWebsiteUrl+="groups/"),c?this.libraryBaseWebsiteUrl+=c+"/items":Z.warn("no libraryUrlIdentifier specified")),e.items=new Zotero.Items,e.items.owningLibrary=e,e.itemKeys=[],e.collections=new Zotero.Collections,e.collections.libraryUrlIdentifier=e.libraryUrlIdentifier,e.collections.owningLibrary=e,e.tags=new Zotero.Tags,e.searches=new Zotero.Searches,e.searches.owningLibrary=e,e.groups=new Zotero.Groups,e.groups.owningLibrary=e,e.deleted=new Zotero.Deleted,e.deleted.owningLibrary=e,!a)return void Z.warn("No type specified for library");e.type=a,e.libraryType=a,e.libraryID=b,e.libraryString=Zotero.utils.libraryString(e.libraryType,e.libraryID),e.libraryUrlIdentifier=c,e.preferences=new Zotero.Preferences(Zotero.store,e.libraryString);var f=navigator.userAgent.indexOf("Chrome")>-1,g=(navigator.userAgent.indexOf("MSIE")>-1,navigator.userAgent.indexOf("Firefox")>-1,
navigator.userAgent.indexOf("Safari")>-1),h=navigator.userAgent.toLowerCase().indexOf("op")>-1;if(f&&g&&(g=!1),f&&h&&(f=!1),g&&(Zotero.config.useIndexedDB=!1,Zotero.warn("Safari detected; disabling indexedDB")),Zotero.config.useIndexedDB===!0){Z.debug("Library Constructor: indexedDB init",3);var i=new Zotero.Idb.Library(e.libraryString);i.owningLibrary=this,e.idbLibrary=i,i.init().then(function(){if(Z.debug("Library Constructor: idbInitD Done",3),Zotero.config.preloadCachedLibrary===!0){Z.debug("Library Constructor: preloading cached library",3);var a=e.loadIndexedDBCache();a.then(function(){Z.debug("Library Constructor: Library.items.itemsVersion: "+e.items.itemsVersion,3),Z.debug("Library Constructor: Library.collections.collectionsVersion: "+e.collections.collectionsVersion,3),Z.debug("Library Constructor: Library.tags.tagsVersion: "+e.tags.tagsVersion,3),Z.debug("Library Constructor: Triggering cachedDataLoaded",3),e.trigger("cachedDataLoaded")},function(a){throw Z.error("Error loading cached library"),Z.error(a),new Error("Error loading cached library")})}else e.trigger("cachedDataLoaded")},function(){Zotero.config.useIndexedDB=!1,e.trigger("indexedDBError"),e.trigger("cachedDataLoaded"),Z.error("Error initializing indexedDB. Promise rejected.")})}e.dirty=!1,e.tagsChanged=function(){},e.collectionsChanged=function(){},e.itemsChanged=function(){}},Zotero.Library.prototype.sortableColumns=["title","creator","itemType","date","year","publisher","publicationTitle","journalAbbreviation","language","accessDate","libraryCatalog","callNumber","rights","dateAdded","dateModified","addedBy"],Zotero.Library.prototype.displayableColumns=["title","creator","itemType","date","year","publisher","publicationTitle","journalAbbreviation","language","accessDate","libraryCatalog","callNumber","rights","dateAdded","dateModified","numChildren","addedBy"],Zotero.Library.prototype.groupOnlyColumns=["addedBy"],Zotero.Library.prototype.comparer=function(){return window.Intl?(new window.Intl.Collator).compare:function(a,b){return a.toLocaleLowerCase()==b.toLocaleLowerCase()?0:a.toLocaleLowerCase()<b.toLocaleLowerCase()?-1:1}},Zotero.Library.prototype.ajaxRequest=function(a,b,c){Z.debug("Library.ajaxRequest",3),b||(b="GET"),c||(c={});var d={url:a,type:b};return d=J.extend({},d,c),Z.debug(d,3),Zotero.net.queueRequest(d)},Zotero.Library.prototype.sequentialRequests=function(a){Z.debug("Zotero.Library.sequentialRequests",3);return Zotero.net.queueRequest(a)},Zotero.Library.prototype.websiteUrl=function(a){Z.debug("Zotero.library.websiteUrl",3),Z.debug(a,4);var b=this,c=[];J.each(a,function(a,b){""!==b&&c.push(a+"/"+b)}),c.sort(),Z.debug(c,4);var d=c.join("/");return b.libraryBaseWebsiteUrl+"/"+d},Zotero.Library.prototype.synchronize=function(){},Zotero.Library.prototype.loadUpdatedItems=function(){Z.debug("Zotero.Library.loadUpdatedItems",3);var a=this,b=a.libraryVersion?a.libraryVersion:a.items.itemsVersion;return Promise.resolve(a.updatedVersions("items",b)).then(function(b){Z.debug("itemVersions resolved",3),Z.debug("items Last-Modified-Version: "+b.lastModifiedVersion,3),a.items.updateSyncState(b.lastModifiedVersion);var c=b.data;a.itemVersions=c;var d=[];return J.each(c,function(b,c){var e=a.items.getItem(b);e&&e.apiObj.key==c||d.push(b)}),a.loadItemsFromKeys(d)}).then(function(b){Z.debug("loadItemsFromKeys resolved",3),a.items.updateSyncedVersion();var c=Zotero.state.getUrlVars();if(a.buildItemDisplayView(c),Zotero.config.useIndexedDB){a.idbLibrary.updateItems(a.items.objectArray)}})},Zotero.Library.prototype.loadUpdatedCollections=function(){Z.debug("Zotero.Library.loadUpdatedCollections",3);var a=this;Z.debug("library.collections.collectionsVersion:"+a.collections.collectionsVersion);var b=a.libraryVersion?a.libraryVersion:a.collections.collectionsVersion;return a.updatedVersions("collections",b).then(function(b){Z.debug("collectionVersions finished",3),Z.debug("Collections Last-Modified-Version: "+b.lastModifiedVersion,3),a.collections.updateSyncState(b.lastModifiedVersion);var c=b.data;a.collectionVersions=c;var d=[];return J.each(c,function(b,c){var e=a.collections.getCollection(b);e&&e.apiObj.version==c||d.push(b)}),0===d.length?(Z.debug("No collectionKeys need updating. resolving",3),b):(Z.debug("fetching collections by key",3),a.loadCollectionsFromKeys(d).then(function(){var b=a.collections;b.initSecondaryData(),Z.debug("All updated collections loaded",3),a.collections.updateSyncedVersion();Zotero.state.getUrlVars();return Z.debug("loadUpdatedCollections complete - saving collections to cache before resolving",3),Z.debug("collectionsVersion: "+a.collections.collectionsVersion,3),Zotero.config.useIndexedDB?a.idbLibrary.updateCollections(b.collectionsArray):void 0}))}).then(function(){return Z.debug("done getting collection data. requesting deleted data",3),a.getDeleted(a.libraryVersion)}).then(function(b){Z.debug("got deleted collections data: removing local copies",3),Z.debug(a.deleted),a.deleted.deletedData.collections&&a.deleted.deletedData.collections.length>0&&a.collections.removeLocalCollections(a.deleted.deletedData.collections)})},Zotero.Library.prototype.loadUpdatedTags=function(){Z.debug("Zotero.Library.loadUpdatedTags",3);var a=this;return Z.debug("tagsVersion: "+a.tags.tagsVersion,3),Promise.resolve(a.loadAllTags({since:a.tags.tagsVersion})).then(function(){return Z.debug("done getting tags, request deleted tags data",3),a.getDeleted(a.libraryVersion)}).then(function(b){if(Z.debug("got deleted tags data"),a.deleted.deletedData.tags&&a.deleted.deletedData.tags.length>0&&a.tags.removeTags(a.deleted.deletedData.tags),Zotero.config.useIndexedDB){Z.debug("saving updated tags to IDB",3);a.idbLibrary.updateTags(a.tags.tagsArray)}})},Zotero.Library.prototype.getDeleted=function(a){Z.debug("Zotero.Library.getDeleted",3);var b=this,c={target:"deleted",libraryType:b.libraryType,libraryID:b.libraryID,since:a};return b.deleted.pending?(Z.debug("getDeleted resolving with previously pending promise"),Promise.resolve(b.deleted.pendingPromise)):(Z.debug("version:"+a),Z.debug("sinceVersion:"+b.deleted.sinceVersion),Z.debug("untilVersion:"+b.deleted.untilVersion),b.deleted.untilVersion&&a>=b.deleted.sinceVersion?(Z.debug("deletedVersion matches requested: immediately resolving"),Promise.resolve(b.deleted.deletedData)):(b.deleted.pending=!0,b.deleted.pendingPromise=b.ajaxRequest(c).then(function(c){Z.debug("got deleted response"),b.deleted.deletedData=c.data,Z.debug("Deleted Last-Modified-Version:"+c.lastModifiedVersion,3),b.deleted.untilVersion=c.lastModifiedVersion,b.deleted.sinceVersion=a}).then(function(a){Z.debug("cleaning up deleted pending"),b.deleted.pending=!1,b.deleted.pendingPromise=!1}),b.deleted.pendingPromise))},Zotero.Library.prototype.processDeletions=function(a){var b=this;b.collections.processDeletions(a.collections),b.items.processDeletions(a.items)},Zotero.Library.prototype.loadFullBib=function(a,b){var c=this,d=a.join(","),e={target:"items",libraryType:c.libraryType,libraryID:c.libraryID,itemKey:d,format:"bib",linkwrap:"1"};1==a.length&&(e.target="item"),b&&(e.style=b);var f=c.ajaxRequest(e).then(function(a){return a.data});return f},Zotero.Library.prototype.loadItemBib=function(a,b){Z.debug("Zotero.Library.loadItemBib",3);var c=this,d={target:"item",libraryType:c.libraryType,libraryID:c.libraryID,itemKey:a,content:"bib"};b&&(d.style=b);var e=(Zotero.ajax.apiRequestString(d),c.ajaxRequest(d).then(function(a){var b=new Zotero.Item(a.data),c=b.apiObj.bib;return c}));return e},Zotero.Library.prototype.loadSettings=function(){Z.debug("Zotero.Library.loadSettings",3);var a=this,b={target:"settings",libraryType:a.libraryType,libraryID:a.libraryID};return a.ajaxRequest(b).then(function(b){var c;if(c="string"==typeof b.data?JSON.parse(b.data):b.data,a.preferences.setPref("settings",c),c.tagColors){var d=c.tagColors.value;a.preferences.setPref("tagColors",d)}return a.trigger("settingsLoaded"),a.preferences})},Zotero.Library.prototype.matchColoredTags=function(a){var b,c=this,d=c.preferences.getPref("tagColors");if(!d)return[];var e={};for(b=0;b<d.length;b++)e[d[b].name.toLowerCase()]=d[b].color;var f=[];for(b=0;b<a.length;b++)e.hasOwnProperty(a[b])&&f.push(e[a[b]]);return f},Zotero.Library.prototype.sendToLibrary=function(a,b){for(var c=[],d=0;d<a.length;d++){var e=a[d],f=e.emptyJsonItem();f.data=J.extend({},a[d].apiObj.data),f.data.key="",f.data.version=0,f.data.collections=[],delete f.data.dateModified,delete f.data.dateAdded;var g=new Zotero.Item(f);g.pristine=J.extend({},g.apiObj),g.initSecondaryData(),g.apiObj.data.relations||(g.apiObj.data.relations={}),g.apiObj.data.relations["owl:sameAs"]=Zotero.url.relationUrl(e.owningLibrary.libraryType,e.owningLibrary.libraryID,e.key),c.push(g)}return b.items.writeItems(c)},Zotero.Library.prototype.updatedVersions=function(a,b){Z.debug("Library.updatedVersions",3);var c=this;"undefined"==typeof a&&(a="items"),("undefined"==typeof b||null===b)&&(b=c.libraryVersion);var d={target:a,format:"versions",libraryType:c.libraryType,libraryID:c.libraryID,since:b};return c.ajaxRequest(d)},Zotero.Library.prototype.loadItemsFromKeys=function(a){Zotero.debug("Zotero.Library.loadItemsFromKeys",3);var b=this;return b.loadFromKeys(a,"items")},Zotero.Library.prototype.loadCollectionsFromKeys=function(a){Zotero.debug("Zotero.Library.loadCollectionsFromKeys",3);var b=this;return b.loadFromKeys(a,"collections")},Zotero.Library.prototype.loadSeachesFromKeys=function(a){Zotero.debug("Zotero.Library.loadSearchesFromKeys",3);var b=this;return b.loadFromKeys(a,"searches")},Zotero.Library.prototype.loadFromKeys=function(a,b){Zotero.debug("Zotero.Library.loadFromKeys",3),b||(b="items");for(var c=this,d=[];a.length>0;)d.push(a.splice(0,50));var e=[];J.each(d,function(a,d){var f=d.join(",");switch(b){case"items":e.push({url:{target:"items",targetModifier:null,itemKey:f,limit:50,libraryType:c.libraryType,libraryID:c.libraryID},type:"GET",success:J.proxy(c.processLoadedItems,c)});break;case"collections":e.push({url:{target:"collections",targetModifier:null,collectionKey:f,limit:50,libraryType:c.libraryType,libraryID:c.libraryID},type:"GET",success:J.proxy(c.processLoadedCollections,c)});break;case"searches":e.push({url:{target:"searches",targetModifier:null,searchKey:f,limit:50,libraryType:c.libraryType,libraryID:c.libraryID},type:"GET"})}});for(var f=[],g=0;g<e.length;g++)f.push(Zotero.net.queueRequest(e[g]));return Promise.all(f)},Zotero.Library.prototype.buildItemDisplayView=function(a){Z.debug("Zotero.Library.buildItemDisplayView",3),Z.debug(a,4);var b=this;if(!b.idbLibrary.db)return Promise.resolve([]);var c=[];a.collectionKey?"trash"==a.collectionKey?c.push(b.idbLibrary.filterItems("deleted",1)):c.push(b.idbLibrary.filterItems("collectionKeys",a.collectionKey)):c.push(b.idbLibrary.getOrderedItemKeys("title"));var d=a.tag||[];"string"==typeof d&&(d=[d]);for(var e=0;e<d.length;e++)Z.debug("adding selected tag filter",3),c.push(b.idbLibrary.filterItems("itemTagStrings",d[e]));return Promise.all(c).then(function(c){var d;for(d=0;d<c.length;d++)Z.debug("result from filterPromise: "+c[d].length,3),Z.debug(c[d],3);var e=b.idbLibrary.intersectAll(c);itemsArray=b.items.getItems(e),Z.debug("All filters applied - Down to "+itemsArray.length+" items displayed",3),Z.debug("remove child items and, if not viewing trash, deleted items",3);var f=[];for(d=0;d<itemsArray.length;d++)itemsArray[d].apiObj.data.parentItem||"trash"!=a.collectionKey&&itemsArray[d].apiObj.deleted||f.push(itemsArray[d]);var g=a.order||"title",h=a.sort||"asc";Z.debug("Sorting by "+g+" - "+h,3);var i=Zotero.Library.prototype.comparer();return f.sort(function(a,b){var c=a.get(g),d=b.get(g);return i(c,d)}),"desc"==h&&(Z.debug("sort is desc - reversing array",4),f.reverse()),Z.debug("triggering publishing displayedItemsUpdated",3),b.trigger("displayedItemsUpdated"),f})},Zotero.Library.prototype.trigger=function(a,b){var c=this;Zotero.trigger(a,b,c.libraryString)},Zotero.Library.prototype.listen=function(a,b,c){var d=this,e=d.libraryString;Zotero.listen(a,b,c,e)},Zotero.Container=function(){},Zotero.Container.prototype.initSecondaryData=function(){},Zotero.Container.prototype.addObject=function(a){Zotero.debug("Zotero.Container.addObject",4);var b=this;return b.objectArray.push(a),b.objectMap[a.key]=a,b.owningLibrary&&a.associateWithLibrary(b.owningLibrary),b},Zotero.Container.prototype.fieldComparer=function(a){if(window.Intl){var b=new window.Intl.Collator;return function(c,d){return b.compare(c.apiObj.data[a],d.apiObj.data[a])}}return function(b,c){return b.apiObj.data[a].toLowerCase()==c.apiObj.data[a].toLowerCase()?0:b.apiObj.data[a].toLowerCase()<c.apiObj.data[a].toLowerCase()?-1:1}},Zotero.Container.prototype.getObject=function(a){var b=this;return b.objectMap.hasOwnProperty(a)?b.objectMap[a]:!1},Zotero.Container.prototype.getObjects=function(a){for(var b,c=this,d=[],e=0;e<a.length;e++)b=c.getObject(a[e]),b&&d.push(b);return d},Zotero.Container.prototype.removeObject=function(a){container.objectMap.hasOwnProperty(a)&&(delete container.objectmap[a],container.initSecondaryData())},Zotero.Container.prototype.removeObjects=function(a){for(var b=this,c=0;c<a.length;c++)delete b.objectMap[a[c]];b.initSecondaryData()},Zotero.Container.prototype.writeObjects=function(a){},Zotero.Container.prototype.assignKeys=function(a){var b;for(i=0;i<a.length;i++){b=a[i];var c=b.get("key");if(!c){var d=Zotero.utils.getKey();b.set("key",d),b.set("version",0)}}return a},Zotero.Container.prototype.chunkObjectsArray=function(a){var b=50,c=[];for(i=0;i<a.length;i+=b)c.push(a.slice(i,i+b));return c},Zotero.Container.prototype.rawChunks=function(a){var b=[];for(i=0;i<a.length;i++){b[i]=[];for(var c=0;c<a[i].length;c++)b[i].push(a[i][c].writeApiObj())}return b},Zotero.Container.prototype.updateSyncState=function(a){var b=this;if(Z.debug("updateSyncState: "+a,3),!b.hasOwnProperty("syncState"))throw Z.debug("no syncState property"),new Error("Attempt to update sync state of object with no syncState property");null===b.syncState.earliestVersion&&(b.syncState.earliestVersion=a),null===b.syncState.latestVersion&&(b.syncState.latestVersion=a),a<b.syncState.earliestVersion&&(b.syncState.earliestVersion=a),a>b.syncState.latestVersion&&(b.syncState.latestVersion=a),Z.debug("done updating sync state",3)},Zotero.Container.prototype.updateSyncedVersion=function(a){var b=this;null!==b.syncState.earliestVersion&&b.syncState.earliestVersion==b.syncState.latestVersion?(b.version=b.syncState.latestVersion,b.synced=!0):null!==b.syncState.earliestVersion&&(b.version=b.syncState.earliestVersion)},Zotero.Container.prototype.processDeletions=function(a){for(var b=this,c=0;c<a.length;c++){var d=b.get(a[c]);d!==!1&&d.synced===!0&&b.removeObjects([a[c]])}},Zotero.Container.prototype.updateObjectsFromWriteResponse=function(a,b){Z.debug("Zotero.Container.updateObjectsFromWriteResponse",3),Z.debug("statusCode: "+b.status,3);var c=b.data;200==b.status?(Z.debug("newLastModifiedVersion: "+b.lastModifiedVersion,3),c.hasOwnProperty("success")&&J.each(c.success,function(c,d){var e=parseInt(c,10),f=a[e];if(""!==f.key&&f.key!==d)throw new Error("object key mismatch in multi-write response");""===f.key&&f.updateObjectKey(d),f.set("version",b.lastModifiedVersion),f.synced=!0,f.writeFailure=!1}),c.hasOwnProperty("failed")&&(Z.debug("updating objects with failed writes",3),J.each(c.failed,function(b,c){Z.error("failed write "+b+" - "+c);var d=parseInt(b,10),e=a[d];e.writeFailure=c}))):204==responsexhr.status&&(a[0].synced=!0)},Zotero.Container.prototype.extractKey=function(a){return"string"==typeof a?a:a.get("key")},Zotero.Collections=function(a){this.instance="Zotero.Collections",this.version=0,this.syncState={earliestVersion:null,latestVersion:null},this.collectionObjects={},this.collectionsArray=[],this.objectMap=this.collectionObjects,this.objectArray=this.collectionsArray,this.dirty=!1,this.loaded=!1,a&&(this.addCollectionsFromJson(a),this.initSecondaryData())},Zotero.Collections.prototype=new Zotero.Container,Zotero.Collections.prototype.initSecondaryData=function(){Z.debug("Zotero.Collections.initSecondaryData",3);var a=this;a.collectionsArray=[],J.each(a.collectionObjects,function(b,c){a.collectionsArray.push(c)}),a.collectionsArray.sort(Zotero.ApiObject.prototype.fieldComparer("name")),a.nestCollections(),a.assignDepths(0,a.collectionsArray)},Zotero.Collections.prototype.addCollection=function(a){return this.addObject(a),this},Zotero.Collections.prototype.addCollectionsFromJson=function(a){Z.debug("addCollectionsFromJson"),Z.debug(a);var b=this,c=[];return J.each(a,function(a,d){var e=new Zotero.Collection(d);b.addObject(e),c.push(e)}),c},Zotero.Collections.prototype.assignDepths=function(a,b){Z.debug("Zotero.Collections.assignDepths",3);var c=this,d=function e(a,b){J.each(b,function(b,c){c.nestingDepth=a,c.hasChildren&&e(a+1,c.children)})};J.each(c.collectionsArray,function(a,b){b.topLevel&&(b.nestingDepth=1,b.hasChildren&&d(2,b.children))})},Zotero.Collections.prototype.nestedOrderingArray=function(){Z.debug("Zotero.Collections.nestedOrderingArray",3);var a=this,b=[],c=function d(a,b){J.each(b,function(b,c){a.push(c),c.hasChildren&&d(a,c.children)})};return J.each(a.collectionsArray,function(a,d){d.topLevel&&(b.push(d),d.hasChildren&&c(b,d.children))}),Z.debug("Done with nestedOrderingArray",3),b},Zotero.Collections.prototype.getCollection=function(a){return this.getObject(a)},Zotero.Collections.prototype.remoteDeleteCollection=function(a){var b=this;return b.removeLocalCollection(a)},Zotero.Collections.prototype.removeLocalCollection=function(a){var b=this;return b.removeLocalCollections([a])},Zotero.Collections.prototype.removeLocalCollections=function(a){for(var b=this,c=0;c<a.length;c++)delete b.collectionObjects[a[c]];b.initSecondaryData()},Zotero.Collections.prototype.nestCollections=function(){var a=this;J.each(a.collectionsArray,function(a,b){b.children=[]}),a.collectionsArray.sort(Zotero.ApiObject.prototype.fieldComparer("name")),J.each(a.collectionsArray,function(b,c){c.nestCollection(a.collectionObjects)})},Zotero.Collections.prototype.writeCollections=function(a){Z.debug("Zotero.Collections.writeCollections",3);var b,c=this,d=c.owningLibrary,e={target:"collections",libraryType:c.owningLibrary.libraryType,libraryID:c.owningLibrary.libraryID},f=Zotero.ajax.apiRequestString(e);for(b=0;b<a.length;b++){var g=a[b],h=g.get("key");if(""===h||null===h){var i=Zotero.utils.getKey();g.set("key",i),g.set("version",0)}}var j=c.chunkObjectsArray(a),k=c.rawChunks(j),l=function(a){Z.debug("writeCollections successCallback",3);var b=this.library,c=this.writeChunk;b.collections.updateObjectsFromWriteResponse(this.writeChunk,a);for(var d=0;d<c.length;d++){var e=c[d];e.synced&&!e.writeFailure&&(b.collections.addCollection(e),Zotero.config.useIndexedDB&&(Z.debug("updating indexedDB collections"),b.idbLibrary.updateCollections(c)))}return a.returnCollections=c,a};Z.debug("collections.version: "+c.version,3),Z.debug("collections.libraryVersion: "+c.libraryVersion,3);var m=[];for(b=0;b<j.length;b++){var n={writeChunk:j[b],library:d};requestData=JSON.stringify(k[b]),m.push({url:f,type:"POST",data:requestData,processData:!1,headers:{},success:J.proxy(l,n)})}return d.sequentialRequests(m).then(function(a){return Z.debug("Done with writeCollections sequentialRequests promise",3),c.initSecondaryData(),J.each(a,function(a,b){if(b.isError||b.data.hasOwnProperty("failed")&&Object.keys(b.data.failed).length>0)throw new Error("failure when writing collections")}),a})["catch"](function(a){throw Z.error(a),a})},Zotero.Items=function(a){this.instance="Zotero.Items",this.itemsVersion=0,this.syncState={earliestVersion:null,latestVersion:null},this.itemObjects={},this.objectMap=this.itemObjects,this.objectArray=[],this.unsyncedItemKeys=[],this.newUnsyncedItems=[],a&&this.addItemsFromJson(a)},Zotero.Items.prototype=new Zotero.Container,Zotero.Items.prototype.getItem=function(a){return this.getObject(a)},Zotero.Items.prototype.getItems=function(a){return this.getObjects(a)},Zotero.Items.prototype.addItem=function(a){return this.addObject(a),this},Zotero.Items.prototype.addItemsFromJson=function(a){Z.debug("addItemsFromJson",3);var b=this,c=a,d=[];return Z.debug("looping"),J.each(c,function(a,c){Z.debug("creating new Item");var e=new Zotero.Item(c);b.addItem(e),d.push(e)}),d},Zotero.Items.prototype.removeLocalItem=function(a){return this.removeObject(a)},Zotero.Items.prototype.removeLocalItems=function(a){return this.removeObjects(a)},Zotero.Items.prototype.deleteItem=function(a){Z.debug("Zotero.Items.deleteItem",3);var b,c=this;if(!a)return!1;a=c.extractKey(a),b=c.getItem(a);var d=({target:"item",libraryType:c.owningLibrary.libraryType,libraryID:c.owningLibrary.libraryID,itemKey:b.key},{url:Zotero.ajax.apiRequestString(config),type:"DELETE",headers:{"If-Unmodified-Since-Version":b.get("version")}});return Zotero.net.ajaxRequest(d)},Zotero.Items.prototype.deleteItems=function(a,b){Z.debug("Zotero.Items.deleteItems",3);var c,d=this,e=[];b||0===d.itemsVersion||(b=d.itemsVersion);var f;for(c=0;c<a.length;c++)a[c]&&(f=d.extractKey(a[c]),f&&e.push(f));var g=d.chunkObjectsArray(e),h=[];for(c=0;c<g.length;c++){var i=g[c].join(","),j={target:"items",libraryType:d.owningLibrary.libraryType,libraryID:d.owningLibrary.libraryID,itemKey:i},k={url:j,type:"DELETE"};h.push(k)}return Zotero.net.queueRequest(h)},Zotero.Items.prototype.trashItems=function(a){var b,c=this;for(b=0;b<a.length;b++){var d=a[b];d.set("deleted",1)}return c.writeItems(a)},Zotero.Items.prototype.untrashItems=function(a){var b,c=this;for(b=0;b<a.length;b++){var d=a[b];d.set("deleted",0)}return c.writeItems(a)},Zotero.Items.prototype.findItems=function(a){var b=this,c=[];return J.each(b.itemObjects,function(d,e){a.collectionKey&&J.inArray(a.collectionKey,-1===e.apiObj.collections)||c.push(b.itemObjects[d])}),c},Zotero.Items.prototype.atomizeItems=function(a){for(var b,c=[],d=0;d<a.length;d++){b=a[d];var e=b.get("key");if(""===e||null===e){var f=Zotero.utils.getKey();b.set("key",f),b.set("version",0)}if(c.push(b),b.hasOwnProperty("notes")&&b.notes.length>0){for(var g=0;g<b.notes.length;g++)b.notes[g].set("parentItem",b.get("key"));c=c.concat(b.notes)}if(b.hasOwnProperty("attachments")&&b.attachments.length>0){for(var h=0;h<b.attachments.length;h++)b.attachments[h].set("parentItem",b.get("key"));c=c.concat(b.attachments)}}return c},Zotero.Items.prototype.writeItems=function(a){var b,c=this,d=c.owningLibrary,e=c.atomizeItems(a),f={target:"items",libraryType:c.owningLibrary.libraryType,libraryID:c.owningLibrary.libraryID},g=Zotero.ajax.apiRequestString(f),h=c.chunkObjectsArray(e),i=c.rawChunks(h),j=function(a){return Z.debug("writeItem successCallback",3),c.updateObjectsFromWriteResponse(this.writeChunk,a),Zotero.config.useIndexedDB&&this.library.idbLibrary.updateItems(this.writeChunk),Zotero.trigger("itemsChanged",{library:this.library}),a.returnItems=this.writeChunk,a};Z.debug("items.itemsVersion: "+c.itemsVersion,3),Z.debug("items.libraryVersion: "+c.libraryVersion,3);var k=[];for(b=0;b<h.length;b++){var l={writeChunk:h[b],library:d};requestData=JSON.stringify(i[b]),k.push({url:g,type:"POST",data:requestData,processData:!1,success:J.proxy(j,l)})}return d.sequentialRequests(k).then(function(a){return Z.debug("Done with writeItems sequentialRequests promise",3),a})},Zotero.Tags=function(a){this.instance="Zotero.Tags",this.tagsVersion=0,this.syncState={earliestVersion:null,latestVersion:null},this.displayTagsArray=[],this.displayTagsUrl="",this.tagObjects={},this.tagsArray=[],this.loaded=!1,a&&this.addTagsFromJson(a)},Zotero.Tags.prototype=new Zotero.Container,Zotero.Tags.prototype.addTag=function(a){var b=this;b.tagObjects[a.apiObj.tag]=a,b.tagsArray.push(a),b.owningLibrary&&a.associateWithLibrary(b.owningLibrary)},Zotero.Tags.prototype.getTag=function(a){var b=this;return b.tagObjects.hasOwnProperty(a)?this.tagObjects[a]:null},Zotero.Tags.prototype.removeTag=function(a){var b=this;delete b.tagObjects[a],b.updateSecondaryData()},Zotero.Tags.prototype.removeTags=function(a){var b=this;J.each(a,function(a,c){delete b.tagObjects[c]}),b.updateSecondaryData()},Zotero.Tags.prototype.plainTagsList=function(a){Z.debug("Zotero.Tags.plainTagsList",3);var b=[];return J.each(a,function(a,c){b.push(c.apiObj.tag)}),b},Zotero.Tags.prototype.clear=function(){Z.debug("Zotero.Tags.clear",3),this.tagsVersion=0,this.syncState.earliestVersion=null,this.syncState.latestVersion=null,this.displayTagsArray=[],this.displayTagsUrl="",this.tagObjects={},this.tagsArray=[]},Zotero.Tags.prototype.updateSecondaryData=function(){Z.debug("Zotero.Tags.updateSecondaryData",3);var a=this;a.tagsArray=[],J.each(a.tagObjects,function(b,c){a.tagsArray.push(c)}),a.tagsArray.sort(Zotero.Tag.prototype.tagComparer());var b=a.plainTagsList(a.tagsArray);b.sort(Zotero.Library.prototype.comparer()),a.plainList=b},Zotero.Tags.prototype.updateTagsVersion=function(a){var b=this;J.each(b.tagObjects,function(b,c){c.set("version",a)})},Zotero.Tags.prototype.rebuildTagsArray=function(){var a=this;a.tagsArray=[],J.each(a.tagObjects,function(b,c){a.tagsArray.push(c)})},Zotero.Tags.prototype.addTagsFromJson=function(a){Z.debug("Zotero.Tags.addTagsFromJson",3);var b=this,c=[];return J.each(a,function(a,d){var e=new Zotero.Tag(d);b.addTag(e),c.push(e)}),c},Zotero.Groups=function(a){this.instance="Zotero.Groups",this.groupsArray=[]},Zotero.Groups.prototype.fetchGroup=function(a,b){},Zotero.Groups.prototype.addGroupsFromJson=function(a){var b=this,c=[];return J.each(a,function(a,d){Z.debug(d);var e=new Zotero.Group(d);b.groupsArray.push(e),c.push(e)}),c},Zotero.Groups.prototype.fetchUserGroups=function(a,b){var c=this,d={target:"userGroups",libraryType:"user",libraryID:a,order:"title"};return b?d.key=b:c.owningLibrary&&(d.key=c.owningLibrary._apiKey),Zotero.ajaxRequest(d).then(function(a){return Z.debug("fetchUserGroups proxied callback",3),fetchedGroups=c.addGroupsFromJson(a.data),a.fetchedGroups=fetchedGroups,a})},Zotero.Searches=function(){this.instance="Zotero.Searches",this.searchObjects={},this.syncState={earliestVersion:null,latestVersion:null}},Zotero.Deleted=function(a){this.instance="Zotero.Deleted","string"==typeof a?this.deletedData=JSON.parse(a):this.deletedData=a,this.untilVersion=null,this.sinceVersion=null,this.waitingPromises=[],this.pending=!1},Zotero.Deleted.prototype.addWaiter=function(){},Zotero.Collection=function(a){this.instance="Zotero.Collection",this.libraryUrlIdentifier="",this.itemKeys=!1,this.key="",this.version=0,this.synced=!1,this.pristineData=null,this.apiObj={key:"",version:0,library:{},links:{},meta:{},data:{key:"",version:0,name:"",parentCollection:!1,relations:{}}},this.children=[],this.topLevel=!0,a&&this.parseJsonCollection(a)},Zotero.Collection.prototype=new Zotero.ApiObject,Zotero.Collection.prototype.instance="Zotero.Collection",Zotero.Collection.prototype.updateObjectKey=function(a){this.updateCollectionKey(a)},Zotero.Collection.prototype.updateCollectionKey=function(a){var b=this;return b.key=a,b.apiObj.key=a,b.apiObj.data.key=a,b},Zotero.Collection.prototype.parseJsonCollection=function(a){Z.debug("parseJsonCollection",4);var b=this;b.key=a.key,b.version=a.version,b.apiObj=J.extend({},a),b.pristineData=J.extend({},a.data),b.parentCollection=!1,b.topLevel=!0,b.synced=!0,b.initSecondaryData()},Zotero.Collection.prototype.initSecondaryData=function(){var a=this;a.apiObj.data.parentCollection?a.topLevel=!1:a.topLevel=!0,Zotero.config.librarySettings.libraryPathString?a.websiteCollectionLink=Zotero.config.librarySettings.libraryPathString+"/collectionKey/"+a.apiObj.key:a.websiteCollectionLink="",a.hasChildren=a.apiObj.meta.numCollections?!0:!1},Zotero.Collection.prototype.nestCollection=function(a){Z.debug("Zotero.Collection.nestCollection",4);var b=this,c=b.get("parentCollection");if(c!==!1&&a.hasOwnProperty(c)){var d=a[c];return d.children.push(b),d.hasChildren=!0,b.topLevel=!1,!0}return!1},Zotero.Collection.prototype.addItems=function(a){Z.debug("Zotero.Collection.addItems",3);var b=this,c={target:"items",libraryType:b.apiObj.library.type,libraryID:b.apiObj.library.id,collectionKey:b.key},d=Zotero.ajax.apiRequestUrl(c)+Zotero.ajax.apiQueryString(c),e=a.join(" ");return Zotero.ajaxRequest(d,"POST",{data:e,processData:!1})},Zotero.Collection.prototype.getMemberItemKeys=function(){Z.debug("Zotero.Collection.getMemberItemKeys",3);var a=this,b={target:"items",libraryType:a.apiObj.library.type,libraryID:a.apiObj.library.id,collectionKey:a.key,format:"keys"};return Zotero.ajaxRequest(b,"GET",{processData:!1}).then(function(b){Z.debug("getMemberItemKeys proxied callback",3);var c=b.data,d=J.trim(c).split(/[\s]+/);return a.itemKeys=d,d})},Zotero.Collection.prototype.removeItem=function(a){var b=this,c={target:"item",libraryType:b.apiObj.library.type,libraryID:b.apiObj.library.id,collectionKey:b.key,itemKey:a};return Zotero.ajaxRequest(c,"DELETE",{processData:!1,cache:!1})},Zotero.Collection.prototype.update=function(a,b){var c=this;b||(b=!1);var d={target:"collection",libraryType:c.apiObj.library.type,libraryID:c.apiObj.library.id,collectionKey:c.key};c.set("name",a),c.set("parentCollection",b);var e=c.writeApiObj(),f=JSON.stringify(e);return Zotero.ajaxRequest(d,"PUT",{data:f,processData:!1,headers:{"If-Unmodified-Since-Version":c.version},cache:!1})},Zotero.Collection.prototype.writeApiObj=function(){var a=this,b=J.extend({},a.pristineData,a.apiObj.data);return b},Zotero.Collection.prototype.remove=function(){Z.debug("Zotero.Collection.delete",3);var a=this,b=a.owningLibrary,c={target:"collection",libraryType:a.apiObj.library.type,libraryID:a.apiObj.library.id,collectionKey:a.key};return Zotero.ajaxRequest(c,"DELETE",{processData:!1,headers:{"If-Unmodified-Since-Version":a.version},cache:!1}).then(function(){Z.debug("done deleting collection. remove local copy.",3),b.collections.removeLocalCollection(a.key),b.trigger("libraryCollectionsUpdated")})},Zotero.Collection.prototype.get=function(a){var b=this;switch(a){case"title":case"name":return b.apiObj.data.name;case"collectionKey":case"key":return b.apiObj.key||b.key;case"collectionVersion":case"version":return b.apiObj.version;case"parentCollection":return b.apiObj.data.parentCollection}return a in b.apiObj.data?b.apiObj.data[a]:b.apiObj.meta.hasOwnProperty(a)?b.apiObj.meta[a]:b.hasOwnProperty(a)?b[a]:null},Zotero.Collection.prototype.set=function(a,b){var c=this;switch(a in c.apiObj.data&&(c.apiObj.data[a]=b),a){case"title":case"name":c.apiObj.data.name=b;break;case"collectionKey":case"key":c.key=b,c.apiObj.key=b,c.apiObj.data.key=b;break;case"parentCollection":c.apiObj.data.parentCollection=b;break;case"collectionVersion":case"version":c.version=b,c.apiObj.version=b,c.apiObj.data.version=b}c.hasOwnProperty(a)&&(c[a]=b)},Zotero.Item=function(a){this.instance="Zotero.Item",this.version=0,this.key="",this.synced=!1,this.apiObj={},this.pristineData=null,this.childItemKeys=[],this.writeErrors=[],this.notes=[],a?this.parseJsonItem(a):this.parseJsonItem(this.emptyJsonItem()),this.initSecondaryData()},Zotero.Item.prototype=new Zotero.ApiObject,Zotero.Item.prototype.parseJsonItem=function(a){Z.debug("parseJsonItem",3);var b=this;b.version=a.version,b.key=a.key,b.apiObj=J.extend({},a),b.pristineData=J.extend({},a.data),b.apiObj._supplement||(b.apiObj._supplement={})},Zotero.Item.prototype.emptyJsonItem=function(){return{key:"",version:0,library:{},links:{},data:{key:"",version:0,title:"",creators:[],collections:[],tags:[],relations:{}},meta:{},_supplement:{}}},Zotero.Item.prototype.initSecondaryData=function(){Z.debug("initSecondaryData",3);var a=this;a.version=a.apiObj.version,"attachment"==a.apiObj.data.itemType&&(a.mimeType=a.apiObj.data.contentType,a.translatedMimeType=Zotero.utils.translateMimeType(a.mimeType)),"linkMode"in a.apiObj&&(a.linkMode=a.apiObj.data.linkMode),a.attachmentDownloadUrl=Zotero.url.attachmentDownloadUrl(a),a.apiObj.meta.parsedDate?a.parsedDate=new Date(a.apiObj.meta.parsedDate):a.parsedDate=!1,a.synced=!1,a.updateTagStrings();
},Zotero.Item.prototype.updateTagStrings=function(){for(var a=this,b=[],c=0;c<a.apiObj.data.tags.length;c++)b.push(a.apiObj.data.tags[c].tag);a.apiObj._supplement.tagstrings=b},Zotero.Item.prototype.initEmpty=function(a,b){var c=this;return c.getItemTemplate(a,b).then(function(a){return c.initEmptyFromTemplate(a),c})},Zotero.Item.prototype.initEmptyNote=function(){var a=this;a.version=0;var b={itemType:"note",note:"",tags:[],collections:[],relations:{}};return a.initEmptyFromTemplate(b),a},Zotero.Item.prototype.initEmptyFromTemplate=function(a){var b=this;return b.version=0,b.key="",b.pristineData=J.extend({},a),b.apiObj={key:"",version:0,library:{},links:{},data:a,meta:{},_supplement:{}},b.initSecondaryData(),b},Zotero.Item.prototype.isSupplementaryItem=function(){var a=this,b=a.get("itemType");return"attachment"==b||"note"==b?!0:!1},Zotero.Item.prototype.isSnapshot=function(){var a=this;if(a.apiObj.links.enclosure){var b=a.apiObj.links.enclosure.type;if(!a.apiObj.links.enclosure.length&&"text/html"==b)return!0}return!1},Zotero.Item.prototype.updateObjectKey=function(a){return this.updateItemKey(a)},Zotero.Item.prototype.updateItemKey=function(a){var b=this;return b.key=a,b.apiObj.key=a,b.apiObj.data.key=a,b.pristineData.key=a,b},Zotero.Item.prototype.writeItem=function(){var a=this;if(!a.owningLibrary)throw new Error("Item must be associated with a library");return a.owningLibrary.items.writeItems([a])},Zotero.Item.prototype.writeApiObj=function(){var a=this;if(a.apiObj.data.creators){var b=a.apiObj.data.creators.filter(function(a){return a.name||a.firstName||a.lastName?!0:!1});a.apiObj.data.creators=b}var c=J.extend({},a.pristineData,a.apiObj.data);return c},Zotero.Item.prototype.createChildNotes=function(a){var b=this,c=[],d=[];J.proxy(function(a){c.push(a)},this);return J.each(a,function(a,e){var f=new Zotero.Item,g=f.initEmpty("note").then(function(a){a.set("note",e.note),a.set("parentItem",b.key),c.push(a)});d.push(g)}),Promise.all(d).then(function(){return b.owningLibrary.writeItems(c)})},Zotero.Item.prototype.writePatch=function(){},Zotero.Item.prototype.getChildren=function(a){Z.debug("Zotero.Item.getChildren");var b=this;return Promise.resolve().then(function(){if(!b.apiObj.meta.numChildren)return[];var c={url:{target:"children",libraryType:b.apiObj.library.type,libraryID:b.apiObj.library.id,itemKey:b.key}};return Zotero.net.queueRequest(c).then(function(b){Z.debug("getChildren proxied callback",4);for(var c=a.items,d=c.addItemsFromJson(b.data),e=d.length-1;e>=0;e--)d[e].associateWithLibrary(a);return d})})},Zotero.Item.prototype.getItemTypes=function(a){Z.debug("Zotero.Item.prototype.getItemTypes",3),a||(a="en-US"),a="en-US";var b=Zotero.cache.load({locale:a,target:"itemTypes"});if(b)return Z.debug("have itemTypes in localStorage",3),void(Zotero.Item.prototype.itemTypes=b);var c=Zotero.ajax.apiQueryString({locale:a}),d=Zotero.config.baseApiUrl+"/itemTypes"+c;J.getJSON(Zotero.ajax.proxyWrapper(d,"GET"),{},function(b,c,d){Z.debug("got itemTypes response",3),Z.debug(b,4),Zotero.Item.prototype.itemTypes=b,Zotero.cache.save({locale:a,target:"itemTypes"},Zotero.Item.prototype.itemTypes)})},Zotero.Item.prototype.getItemFields=function(a){Z.debug("Zotero.Item.prototype.getItemFields",3),a||(a="en-US"),a="en-US";var b=Zotero.cache.load({locale:a,target:"itemFields"});if(b)return Z.debug("have itemFields in localStorage",3),Zotero.Item.prototype.itemFields=b,void J.each(Zotero.Item.prototype.itemFields,function(a,b){Zotero.localizations.fieldMap[b.field]=b.localized});var c=Zotero.ajax.apiQueryString({locale:a}),d=Zotero.config.baseApiUrl+"/itemFields"+c;J.getJSON(Zotero.ajax.proxyWrapper(d),{},function(b,c,d){Z.debug("got itemTypes response",4),Zotero.Item.prototype.itemFields=b,Zotero.cache.save({locale:a,target:"itemFields"},b),J.each(Zotero.Item.prototype.itemFields,function(a,b){Zotero.localizations.fieldMap[b.field]=b.localized})})},Zotero.Item.prototype.getItemTemplate=function(a,b){if(Z.debug("Zotero.Item.prototype.getItemTemplate",3),"undefined"==typeof a&&(a="document"),"attachment"==a&&"undefined"==typeof b)throw new Error("attachment template requested with no linkMode");"undefined"==typeof b&&(b="");var c=Zotero.ajax.apiQueryString({itemType:a,linkMode:b}),d=Zotero.config.baseApiUrl+"/items/new"+c,e={itemType:a,target:"itemTemplate"},f=Zotero.cache.load(e);if(f){Z.debug("have itemTemplate in localStorage",3);var g=f;return Promise.resolve(g)}return Zotero.ajaxRequest(d,"GET",{dataType:"json"}).then(function(a){return Z.debug("got itemTemplate response",3),Zotero.cache.save(e,a.data),a.data})},Zotero.Item.prototype.getUploadAuthorization=function(a){Z.debug("Zotero.Item.getUploadAuthorization",3);var b=this,c={target:"item",targetModifier:"file",libraryType:b.owningLibrary.type,libraryID:b.owningLibrary.libraryID,itemKey:b.key},d={"Content-Type":"application/x-www-form-urlencoded"},e=b.get("md5");return e?d["If-Match"]=e:d["If-None-Match"]="*",Zotero.ajaxRequest(c,"POST",{processData:!0,data:a,headers:d})},Zotero.Item.prototype.registerUpload=function(a){Z.debug("Zotero.Item.registerUpload",3);var b=this,c={target:"item",targetModifier:"file",libraryType:b.owningLibrary.type,libraryID:b.owningLibrary.libraryID,itemKey:b.key},d={"Content-Type":"application/x-www-form-urlencoded"},e=b.get("md5");return e?d["If-Match"]=e:d["If-None-Match"]="*",Zotero.ajaxRequest(c,"POST",{processData:!0,data:{upload:a},headers:d})},Zotero.Item.prototype.fullUpload=function(a){},Zotero.Item.prototype.creatorTypes={},Zotero.Item.prototype.getCreatorTypes=function(a){Z.debug("Zotero.Item.prototype.getCreatorTypes: "+a,3),a||(a="document");var b=Zotero.cache.load({target:"creatorTypes"});if(b&&(Z.debug("have creatorTypes in localStorage",3),Zotero.Item.prototype.creatorTypes=b),Zotero.Item.prototype.creatorTypes[a])return Z.debug("creatorTypes of requested itemType available in localStorage",3),Z.debug(Zotero.Item.prototype.creatorTypes,4),Promise.resolve(Zotero.Item.prototype.creatorTypes[a]);Z.debug("sending request for creatorTypes",3);var c=Zotero.ajax.apiQueryString({itemType:a}),d=Zotero.config.baseApiUrl+"/itemTypeCreatorTypes"+c;return Zotero.ajaxRequest(d,"GET",{dataType:"json"}).then(function(b){return Z.debug("got creatorTypes response",4),Zotero.Item.prototype.creatorTypes[a]=b.data,Zotero.cache.save({target:"creatorTypes"},Zotero.Item.prototype.creatorTypes),Zotero.Item.prototype.creatorTypes[a]})},Zotero.Item.prototype.getCreatorFields=function(a){Z.debug("Zotero.Item.prototype.getCreatorFields",3);var b=Zotero.cache.load({target:"creatorFields"});if(b)return Z.debug("have creatorFields in localStorage",3),Zotero.Item.prototype.creatorFields=b,Promise.resolve(b);var c=Zotero.config.baseApiUrl+"/creatorFields";return Zotero.ajaxRequest(c,"GET",{dataType:"json"}).then(function(a){Z.debug("got itemTypes response",4),Zotero.Item.prototype.creatorFields=a.data,Zotero.cache.save({target:"creatorFields"},a.data)})},Zotero.Item.prototype.addItemTypes=function(a,b){},Zotero.Item.prototype.addItemFields=function(a,b){},Zotero.Item.prototype.addCreatorTypes=function(a,b){},Zotero.Item.prototype.addCreatorFields=function(a,b){},Zotero.Item.prototype.addItemTemplates=function(a){},Zotero.Item.prototype.itemTypeImageClass=function(){var a=this;if("attachment"!=a.apiObj.data.itemType)return a.apiObj.data.itemType;switch(a.apiObj.data.linkMode){case"imported_file":return"pdf"==a.translatedMimeType?a.itemTypeImageSrc.attachmentPdf:a.itemTypeImageSrc.attachmentFile;case"imported_url":return"pdf"==a.translatedMimeType?a.itemTypeImageSrc.attachmentPdf:a.itemTypeImageSrc.attachmentSnapshot;case"linked_file":return a.itemTypeImageSrc.attachmentLink;case"linked_url":return a.itemTypeImageSrc.attachmentWeblink;default:return a.itemTypeImageSrc.attachment}},Zotero.Item.prototype.itemTypeIconClass=function(){var a=this,b="fa fa-file-text-o";switch(a.apiObj.data.itemType){case"attachment":switch(a.apiObj.data.linkMode){case"imported_file":return"pdf"==a.translatedMimeType?"fa fa-file-pdf-o":"glyphicons glyphicons-file";case"imported_url":return"pdf"==a.translatedMimeType?"fa fa-file-pdf-o":"glyphicons glyphicons-file";case"linked_file":return"glyphicons glyphicons-link";case"linked_url":return"glyphicons glyphicons-link";default:return"glyphicons glyphicons-paperclip"}return"glyphicons file";case"artwork":return"glyphicons glyphicons-picture";case"audioRecording":return"glyphicons glyphicons-microphone";case"bill":return b;case"blogPost":return"glyphicons glyphicons-blog";case"book":return"glyphicons glyphicons-book";case"bookSection":return"glyphicons glyphicons-book-open";case"case":return b;case"computerProgram":return"glyphicons glyphicons-floppy-disk";case"conferencePaper":return b;case"dictionaryEntry":return"glyphicons glyphicons-translate";case"document":return"glyphicons glyphicons-file";case"email":return"glyphicons glyphicons-envelope";case"encyclopediaArticle":return"glyphicons glyphicons-bookmark";case"film":return"glyphicons glyphicons-film";case"forumPost":return"glyphicons glyphicons-bullhorn";case"hearing":return"fa fa-gavel";case"instantMessage":return"fa fa-comment-o";case"interview":return"fa fa-comments-o";case"journalArticle":return"fa fa-file-text-o";case"letter":return"glyphicons glyphicons-message-full";case"magazineArticle":return b;case"manuscript":return"glyphicons glyphicons-pen";case"map":return"glyphicons glyphicons-google-maps";case"newspaperArticle":return"fa fa-newspaper-o";case"note":return"glyphicons glyphicons-notes noteyellow";case"patent":return"glyphicons glyphicons-lightbulb";case"podcast":return"glyphicons glyphicons-ipod";case"presentation":return"glyphicons glyphicons-keynote";case"radioBroadcast":return"glyphicons glyphicons-wifi-alt";case"report":return"glyphicons glyphicons-notes-2";case"statue":return"glyphicons glyphicons-bank";case"thesis":return"fa fa-graduation-cap";case"tvBroadcast":return"glyphicons glyphicons-display";case"videoRecording":return"glyphicons glyphicons-facetime-video";case"webpage":return"glyphicons glyphicons-embed-close";default:return"glyphicons file"}},Zotero.Item.prototype.get=function(a){var b=this;switch(a){case"title":;return"note"==b.apiObj.data.itemType?b.noteTitle(b.apiObj.data.note):b.apiObj.data.title;case"creatorSummary":case"creator":return"undefined"!=typeof b.apiObj.meta.creatorSummary?b.apiObj.meta.creatorSummary:"";case"year":return b.parsedDate?b.parsedDate.getFullYear():""}return a in b.apiObj.data?b.apiObj.data[a]:a in b.apiObj.meta?b.apiObj.meta[a]:b.hasOwnProperty(a)?b[a]:null},Zotero.Item.prototype.set=function(a,b){var c=this;switch(a in c.apiObj&&(c.apiObj[a]=b),a in c.apiObj.data&&(c.apiObj.data[a]=b),a in c.apiObj.meta&&(c.apiObj.meta[a]=b),a){case"itemKey":case"key":c.key=b,c.apiObj.data.key=b;break;case"itemVersion":case"version":c.version=b,c.apiObj.data.version=b;break;case"itemType":c.itemType=b;break;case"linkMode":break;case"deleted":c.apiObj.data.deleted=b;break;case"parentItem":""===b&&(b=!1),c.apiObj.data.parentItem=b}return c},Zotero.Item.prototype.noteTitle=function(a){var b=120,c=J(a).text(),d=c.indexOf("\n");return-1!=d&&b>d?c.substr(0,d):c.substr(0,b)},Zotero.Item.prototype.setParent=function(a){var b=this;return"string"!=typeof a&&a.hasOwnProperty("instance")&&"Zotero.Item"==a.instance&&(a=a.key),b.set("parentItem",a),b},Zotero.Item.prototype.addToCollection=function(a){var b=this;"string"!=typeof a&&"Zotero.Collection"==a.instance&&(a=a.key),-1===J.inArray(a,b.apiObj.data.collections)&&b.apiObj.data.collections.push(a)},Zotero.Item.prototype.removeFromCollection=function(a){var b=this;"string"!=typeof a&&"Zotero.Collection"==a.instance&&(a=a.key);var c=J.inArray(a,b.apiObj.data.collections);-1!=c&&b.apiObj.data.collections.splice(c,1)},Zotero.Item.prototype.uploadChildAttachment=function(a,b,c){var d=this;return Z.debug("uploadChildAttachment",3),d.owningLibrary?(a.set("parentItem",d.key),a.associateWithLibrary(d.owningLibrary),a.writeItem().then(function(e){return d.numChildren++,a.uploadFile(b,c)},function(a){throw{message:"Failure during attachmentItem write.",code:a.status,serverMessage:a.jqxhr.responseText,response:a}})):Promise.reject(new Error("Item must be associated with a library"))},Zotero.Item.prototype.uploadFile=function(a,b){var c=this;Z.debug("Zotero.Item.uploadFile",3);var d={md5:a.md5,filename:c.get("title"),filesize:a.filesize,mtime:a.mtime,contentType:a.contentType,params:1};return""===a.contentType&&(d.contentType="application/octet-stream"),c.getUploadAuthorization(d).then(function(b){Z.debug("uploadAuth callback",3);var d;return d="string"==typeof b.data?JSON.parse(data):b.data,1==d.exists?{message:"File Exists"}:Zotero.file.uploadFile(d,a).then(function(){return c.registerUpload(d.uploadKey).then(function(a){if(a.isError){var b={message:"Failed to register uploaded file.",code:a.status,serverMessage:a.jqxhr.responseText,response:a};throw Z.error(b),b}return{message:"Upload Successful"}})})})["catch"](function(a){throw Z.debug("Failure caught during upload",3),Z.debug(a,3),{message:"Failure during upload.",code:a.status,serverMessage:a.jqxhr.responseText,response:a}})},Zotero.Item.prototype.cslItem=function(){var a=this,b=a.get("itemType"),c=a.cslTypeMap.hasOwnProperty(b)?a.cslTypeMap[b]:!1;c||(c="article");var d=(a.get("accessDate")||a.get("url"))&&b in{journalArticle:1,newspaperArticle:1,magazineArticle:1}&&a.get("pages")&&a.citePaperJournalArticleURL;cslItem={type:c},a.owningLibrary?cslItem.id=a.apiObj.library.id+"/"+a.get("key"):cslItem.id=Zotero.utils.getKey(),J.each(a.cslFieldMap,function(b,c){"URL"==b&&d||J.each(c,function(c,d){var e=a.get(d);e&&(cslItem[b]=e)})});var e=a.get("creators");return J.each(e,function(a,b){var c=b.creatorType;if(c){var d;d=b.hasOwnProperty("name")?{literal:b.name}:{family:b.lastName,given:b.firstName},cslItem.hasOwnProperty(c)?cslItem[c].push(d):cslItem[c]=[d]}}),J.each(a.cslDateMap,function(b,c){var d=a.get(c);d&&(cslItem[b]={raw:d})}),cslItem},Zotero.Item.prototype.fieldMap={itemType:"Item Type",title:"Title",dateAdded:"Date Added",dateModified:"Date Modified",source:"Source",notes:"Notes",tags:"Tags",attachments:"Attachments",related:"Related",url:"URL",rights:"Rights",series:"Series",volume:"Volume",issue:"Issue",edition:"Edition",place:"Place",publisher:"Publisher",pages:"Pages",ISBN:"ISBN",publicationTitle:"Publication",ISSN:"ISSN",date:"Date",year:"Year",section:"Section",callNumber:"Call Number",archive:"Archive",archiveLocation:"Loc. in Archive",libraryCatalog:"Library Catalog",distributor:"Distributor",extra:"Extra",journalAbbreviation:"Journal Abbr",DOI:"DOI",accessDate:"Accessed",seriesTitle:"Series Title",seriesText:"Series Text",seriesNumber:"Series Number",institution:"Institution",reportType:"Report Type",code:"Code",session:"Session",legislativeBody:"Legislative Body",history:"History",reporter:"Reporter",court:"Court",numberOfVolumes:"# of Volumes",committee:"Committee",assignee:"Assignee",patentNumber:"Patent Number",priorityNumbers:"Priority Numbers",issueDate:"Issue Date",references:"References",legalStatus:"Legal Status",codeNumber:"Code Number",artworkMedium:"Medium",number:"Number",artworkSize:"Artwork Size",repository:"Repository",videoRecordingType:"Recording Type",interviewMedium:"Medium",letterType:"Type",manuscriptType:"Type",mapType:"Type",scale:"Scale",thesisType:"Type",websiteType:"Website Type",audioRecordingType:"Recording Type",label:"Label",presentationType:"Type",meetingName:"Meeting Name",studio:"Studio",runningTime:"Running Time",network:"Network",postType:"Post Type",audioFileType:"File Type",versionNumber:"Version Number",system:"System",company:"Company",conferenceName:"Conference Name",encyclopediaTitle:"Encyclopedia Title",dictionaryTitle:"Dictionary Title",language:"Language",programmingLanguage:"Language",university:"University",abstractNote:"Abstract",websiteTitle:"Website Title",reportNumber:"Report Number",billNumber:"Bill Number",codeVolume:"Code Volume",codePages:"Code Pages",dateDecided:"Date Decided",reporterVolume:"Reporter Volume",firstPage:"First Page",documentNumber:"Document Number",dateEnacted:"Date Enacted",publicLawNumber:"Public Law Number",country:"Country",applicationNumber:"Application Number",forumTitle:"Forum/Listserv Title",episodeNumber:"Episode Number",blogTitle:"Blog Title",caseName:"Case Name",nameOfAct:"Name of Act",subject:"Subject",proceedingsTitle:"Proceedings Title",bookTitle:"Book Title",shortTitle:"Short Title",docketNumber:"Docket Number",numPages:"# of Pages",note:"Note",numChildren:"# of Children",addedBy:"Added By",creator:"Creator"},Zotero.localizations.fieldMap=Zotero.Item.prototype.fieldMap,Zotero.Item.prototype.typeMap={note:"Note",attachment:"Attachment",book:"Book",bookSection:"Book Section",journalArticle:"Journal Article",magazineArticle:"Magazine Article",newspaperArticle:"Newspaper Article",thesis:"Thesis",letter:"Letter",manuscript:"Manuscript",interview:"Interview",film:"Film",artwork:"Artwork",webpage:"Web Page",report:"Report",bill:"Bill","case":"Case",hearing:"Hearing",patent:"Patent",statute:"Statute",email:"E-mail",map:"Map",blogPost:"Blog Post",instantMessage:"Instant Message",forumPost:"Forum Post",audioRecording:"Audio Recording",presentation:"Presentation",videoRecording:"Video Recording",tvBroadcast:"TV Broadcast",radioBroadcast:"Radio Broadcast",podcast:"Podcast",computerProgram:"Computer Program",conferencePaper:"Conference Paper",document:"Document",encyclopediaArticle:"Encyclopedia Article",dictionaryEntry:"Dictionary Entry"},Zotero.localizations.typeMap=Zotero.Item.prototype.typeMap,Zotero.Item.prototype.creatorMap={author:"Author",contributor:"Contributor",editor:"Editor",translator:"Translator",seriesEditor:"Series Editor",interviewee:"Interview With",interviewer:"Interviewer",director:"Director",scriptwriter:"Scriptwriter",producer:"Producer",castMember:"Cast Member",sponsor:"Sponsor",counsel:"Counsel",inventor:"Inventor",attorneyAgent:"Attorney/Agent",recipient:"Recipient",performer:"Performer",composer:"Composer",wordsBy:"Words By",cartographer:"Cartographer",programmer:"Programmer",reviewedAuthor:"Reviewed Author",artist:"Artist",commenter:"Commenter",presenter:"Presenter",guest:"Guest",podcaster:"Podcaster"},Zotero.Item.prototype.hideFields=["mimeType","linkMode","charset","md5","mtime","version","key","collections","relations","parentItem","contentType","filename","tags"],Zotero.Item.prototype.noEditFields=["accessDate","modified","filename","dateAdded","dateModified"],Zotero.localizations.creatorMap=Zotero.Item.prototype.creatorMap,Zotero.Item.prototype.itemTypeImageSrc={note:"note",attachment:"attachment-pdf",attachmentPdf:"attachment-pdf",attachmentWeblink:"attachment-web-link",attachmentSnapshot:"attachment-snapshot",attachmentFile:"attachment-file",attachmentLink:"attachment-link",book:"book",bookSection:"book_open",journalArticle:"page_white_text",magazineArticle:"layout",newspaperArticle:"newspaper",thesis:"report",letter:"email_open",manuscript:"script",interview:"comments",film:"film",artwork:"picture",webpage:"page",report:"report",bill:"page_white","case":"page_white",hearing:"page_white",patent:"page_white",statute:"page_white",email:"email",map:"map",blogPost:"layout",instantMessage:"page_white",forumPost:"page",audioRecording:"ipod",presentation:"page_white",videoRecording:"film",tvBroadcast:"television",radioBroadcast:"transmit",podcast:"ipod_cast",computerProgram:"page_white_code",conferencePaper:"treeitem-conferencePaper",document:"page_white",encyclopediaArticle:"page_white",dictionaryEntry:"page_white"},Zotero.Item.prototype.cslNameMap={author:"author",editor:"editor",bookAuthor:"container-author",composer:"composer",interviewer:"interviewer",recipient:"recipient",seriesEditor:"collection-editor",translator:"translator"},Zotero.Item.prototype.cslFieldMap={title:["title"],"container-title":["publicationTitle","reporter","code"],"collection-title":["seriesTitle","series"],"collection-number":["seriesNumber"],publisher:["publisher","distributor"],"publisher-place":["place"],authority:["court"],page:["pages"],volume:["volume"],issue:["issue"],"number-of-volumes":["numberOfVolumes"],"number-of-pages":["numPages"],edition:["edition"],versionNumber:["version"],section:["section"],genre:["type","artworkSize"],medium:["medium","system"],archive:["archive"],archive_location:["archiveLocation"],event:["meetingName","conferenceName"],"event-place":["place"],"abstract":["abstractNote"],URL:["url"],DOI:["DOI"],ISBN:["ISBN"],"call-number":["callNumber"],note:["extra"],number:["number"],references:["history"],shortTitle:["shortTitle"],journalAbbreviation:["journalAbbreviation"],language:["language"]},Zotero.Item.prototype.cslDateMap={issued:"date",accessed:"accessDate"},Zotero.Item.prototype.cslTypeMap={book:"book",bookSection:"chapter",journalArticle:"article-journal",magazineArticle:"article-magazine",newspaperArticle:"article-newspaper",thesis:"thesis",encyclopediaArticle:"entry-encyclopedia",dictionaryEntry:"entry-dictionary",conferencePaper:"paper-conference",letter:"personal_communication",manuscript:"manuscript",interview:"interview",film:"motion_picture",artwork:"graphic",webpage:"webpage",report:"report",bill:"bill","case":"legal_case",hearing:"bill",patent:"patent",statute:"bill",email:"personal_communication",map:"map",blogPost:"webpage",instantMessage:"personal_communication",forumPost:"webpage",audioRecording:"song",presentation:"speech",videoRecording:"motion_picture",tvBroadcast:"broadcast",radioBroadcast:"broadcast",podcast:"song",computerProgram:"book"},Zotero.Item.prototype.citePaperJournalArticleURL=!1,Zotero.Tag=function(a){this.instance="Zotero.Tag",this.color=null,this.version=0,"object"==("undefined"==typeof a?"undefined":_typeof(a))?this.parseJsonTag(a):"string"==typeof a?this.parseJsonTag(this.templateApiObj(a)):this.parseJsonTag(this.tamplateApiObj(""))},Zotero.Tag.prototype=new Zotero.ApiObject,Zotero.Tag.prototype.parseJsonTag=function(a){var b=this;b.apiObj=J.extend({},a),b.urlencodedtag=encodeURIComponent(b.apiObj.tag),b.version=b.apiObj.version},Zotero.Tag.prototype.templateApiObj=function(a){return{tag:a,links:{},meta:{type:0,numItems:1}}},Zotero.Tag.prototype.tagComparer=function(){if(window.Intl){var a=new window.Intl.Collator;return function(b,c){return a.compare(b.apiObj.tag,c.apiObj.tag)}}return function(a,b){return a.apiObj.tag.toLocaleLowerCase()==b.apiObj.tag.toLocaleLowerCase()?0:a.apiObj.tag.toLocaleLowerCase()<b.apiObj.tag.toLocaleLowerCase()?-1:1}},Zotero.Tag.prototype.set=function(a,b){var c=this;switch(a in c.apiObj&&(c.apiObj[a]=b),a in c.apiObj.meta&&(c.apiObj.meta[a]=b),a){case"tagVersion":case"version":c.version=b,c.apiObj.version=b}return c},Zotero.Search=function(){this.instance="Zotero.Search",this.searchObject={}},Zotero.Group=function(a){var b=this;b.instance="Zotero.Group",a&&this.parseJsonGroup(a)},Zotero.Group.prototype=new Zotero.ApiObject,Zotero.Group.prototype.parseJsonGroup=function(a){var b=this;b.apiObj=a},Zotero.Group.prototype.get=function(a){var b=this;switch(a){case"title":case"name":return b.apiObj.data.name}return a in b.apiObj?b.apiObj[a]:a in b.apiObj.data?b.apiObj.data[a]:a in b.apiObj.meta?b.apiObj.meta[a]:b.hasOwnProperty(a)?b[a]:null},Zotero.Group.prototype.isWritable=function(a){var b=this;switch(!0){case b.get("owner")==a:return!0;case b.apiObj.data.admins&&-1!=b.apiObj.data.admins.indexOf(a):return!0;case"members"==b.apiObj.data.libraryEditing&&b.apiObj.data.members&&-1!=b.apiObj.data.members.indexOf(a):return!0;default:return!1}},Zotero.Group.prototype.typeMap={Private:"Private",PublicOpen:"Public, Open Membership",PublicClosed:"Public, Closed Membership"},Zotero.Group.prototype.accessMap={all:{members:"Anyone can view, only members can edit",admins:"Anyone can view, only admins can edit"},members:{members:"Only members can view and edit",admins:"Only members can view, only admins can edit"},admins:{members:"Only admins can view, only members can edit",admins:"Only admins can view and edit"}},Zotero.User=function(){this.instance="Zotero.User"},Zotero.User.prototype=new Zotero.ApiObject,Zotero.User.prototype.loadObject=function(a){this.title=a.title,this.author=a.author,this.tagID=a.tagID,this.published=a.published,this.updated=a.updated,this.links=a.links,this.numItems=a.numItems,this.items=a.items,this.tagType=a.tagType,this.modified=a.modified,this.added=a.added,this.key=a.key},Zotero.User.prototype.parseXmlUser=function(a){this.parseXmlEntry(a);var b=a.find("content>tag");0!==b.length&&(this.tagKey=b.attr("key"),this.libraryID=b.attr("libraryID"),this.tagName=b.attr("name"),this.dateAdded=b.attr("dateAdded"),this.dateModified=b.attr("dateModified"))},Zotero.utils={randomString:function(a,b){b||(b="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"),a||(a=8);for(var c="",d=0;a>d;d++){var e=Math.floor(Math.random()*b.length);c+=b.substring(e,e+1)}return c},getKey:function(){var a="23456789ABCDEFGHIJKMNPQRSTUVWXZ";return Zotero.utils.randomString(8,a)},slugify:function(a){var b=J.trim(a);return b=b.toLowerCase(),b=b.replace(/[^a-z0-9 ._-]/g,""),b=b.replace(/\s/g,"_")},prependAutocomplete:function(a,b){Z.debug("Zotero.utils.prependAutocomplete",3),Z.debug("prepend match: "+a);var c;if(b||Z.debug("source is not defined"),""===a)return c=b.slice(0);var d=a.length,e=a.toLowerCase();return c=J.map(b,function(a){return a.substr(0,d).toLowerCase()==e?a:null})},matchAnyAutocomplete:function(a,b){Z.debug("Zotero.utils.matchAnyAutocomplete",3),Z.debug("matchAny match: "+a);var c;if(b||Z.debug("source is not defined"),""===a)return c=b.slice(0);var d=(a.length,a.toLowerCase());return c=J.map(b,function(a){return-1!=a.toLowerCase().indexOf(d)?a:null})},libraryString:function(a,b){var c="";return"user"==a?c="u":"group"==a&&(c="g"),c+=b},parseLibString:function(a){var b,c;if("u"==a.charAt(0))b="user";else{if("g"!=a.charAt(0))throw new Error("unexpected type character in libraryString");b="group"}return c=parseInt(a.substring(1)),{libraryType:b,libraryID:c}},stale:function(a,b){var c=Date.now(),d=c.getTime()-a.getTime();return d/6e4>b?!0:!1},entityify:function(a){var b={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"};return a.replace(/[<>&"]/g,function(a){return b[a]})},parseApiDate:function(a,b){var c=/([0-9]+)-([0-9]+)-([0-9]+)T([0-9]+):([0-9]+):([0-9]+)Z/,d=c.exec(a);return null===d?(Z.error("error parsing api date: "+a),null):b=new Date(Date.UTC(d[1],d[2]-1,d[3],d[4],d[5],d[6]))},readCookie:function(a){for(var b=a+"=",c=document.cookie.split(";"),d=0;d<c.length;d++){for(var e=c[d];" "==e.charAt(0);)e=e.substring(1,e.length);if(0===e.indexOf(b))return e.substring(b.length,e.length)}return null},compareObs:function(a,b,c){var d=c,e=!1,f=[];return void 0===c&&(d=a,e=!0),J.each(d,function(c,d){var g=d;e&&(g=c),"object"==_typeof(a[c])?Zotero.utils.compareObs(a[g],b[g]).length&&f.push(g):a[g]!=b[g]&&f.push(g)}),f},translateMimeType:function(a){switch(a){case"text/html":return"html";case"application/pdf":case"application/x-pdf":case"application/acrobat":case"applications/vnd.pdf":case"text/pdf":case"text/x-pdf":return"pdf";case"image/jpg":case"image/jpeg":return"jpg";case"image/gif":return"gif";case"application/msword":case"application/doc":case"application/vnd.msword":case"application/vnd.ms-word":case"application/winword":case"application/word":case"application/x-msw6":case"application/x-msword":return"doc";case"application/vnd.oasis.opendocument.text":case"application/x-vnd.oasis.opendocument.text":return"odt";case"video/flv":case"video/x-flv":return"flv";case"image/tif":case"image/tiff":case"image/tif":case"image/x-tif":case"image/tiff":case"image/x-tiff":case"application/tif":case"application/x-tif":case"application/tiff":case"application/x-tiff":return"tiff";case"application/zip":case"application/x-zip":case"application/x-zip-compressed":case"application/x-compress":case"application/x-compressed":case"multipart/x-zip":return"zip";case"video/quicktime":case"video/x-quicktime":return"mov";case"video/avi":case"video/msvideo":case"video/x-msvideo":return"avi";case"audio/wav":case"audio/x-wav":case"audio/wave":return"wav";case"audio/aiff":case"audio/x-aiff":case"sound/aiff":return"aiff";case"text/plain":return"plain text";case"application/rtf":return"rtf";default:return a}},getKeyPermissions:function(a,b){if(!a)return!1;if(!b)return!1;var c={target:"key",libraryType:"user",libraryID:a,apiKey:b},d=Zotero.ajax.apiRequestString(c);return Zotero.ajaxRequest(d).then(function(a){var b=J(a.data).find("key"),c=Zotero.utils.parseKey(b);return c})},parseKey:function(a){var b={library:"0",notes:"0",write:"0",groups:{}},c=a.find("access");return c.each(function(){var a=J(this);if(a.attr("library")&&(b.library=a.attr("library")),a.attr("notes")&&(b.notes=a.attr("notes")),a.attr("group")){var c="1"==a.attr("write")?"write":"read";b.groups[a.attr("group")]=c}else a.attr("write")&&(b.write=a.attr("write"))}),b}},Zotero.url.itemHref=function(a){var b="";return b+=Zotero.config.librarySettings.libraryPathString+"/itemKey/"+a.get("key")},Zotero.url.attachmentDownloadLink=function(a){var b="",c=a.attachmentDownloadUrl;a.get("contentType");if(a.apiObj.links&&a.apiObj.links.enclosure){if(a.apiObj.links.enclosure.length||!a.isSnapshot()){var d=Zotero.utils.translateMimeType(a.apiObj.links.enclosure.type),e=a.apiObj.links.enclosure,f=parseInt(e.length,10),g=""+f+" B";return f>1073741824?g=""+(f/1073741824).toFixed(1)+" GB":f>1048576?g=""+(f/1048576).toFixed(1)+" MB":f>1024&&(g=""+(f/1024).toFixed(1)+" KB"),Z.debug(d,3),b+='<a href="'+c+'">',b+="undefined"==d||""===d||"undefined"==typeof d?g+"</a>":d+", "+g+"</a>"}b+='<a href="'+c+'">View Snapshot</a>'}return b},Zotero.url.attachmentDownloadUrl=function(a){return a.apiObj.links&&a.apiObj.links.enclosure?Zotero.config.proxyDownloads?Zotero.url.wwwDownloadUrl(a):Zotero.url.apiDownloadUrl(a):!1},Zotero.url.apiDownloadUrl=function(a){return a.apiObj.links.enclosure?a.apiObj.links.enclosure.href:!1},Zotero.url.proxyDownloadUrl=function(a){return a.apiObj.links.enclosure?Zotero.config.proxyDownloads?Zotero.config.baseDownloadUrl+"?itemkey="+a.get("key"):Zotero.url.apiDownloadUrl(a):!1},Zotero.url.wwwDownloadUrl=function(a){return a.apiObj.links.enclosure?Zotero.config.baseZoteroWebsiteUrl+Zotero.config.librarySettings.libraryPathString+"/"+a.get("key")+"/file/view":!1},Zotero.url.publicationsDownloadUrl=function(a){return a.apiObj.links.enclosure?a.apiObj.links.enclosure.href:!1},Zotero.url.attachmentFileDetails=function(a){if(!a.apiObj.links.enclosure)return"";var b=Zotero.utils.translateMimeType(a.apiObj.links.enclosure.type),c=a.apiObj.links.enclosure,d="";if(c.length){var e=parseInt(c.length,10);return d=""+e+" B",e>1073741824?d=""+(e/1073741824).toFixed(1)+" GB":e>1048576?d=""+(e/1048576).toFixed(1)+" MB":e>1024&&(d=""+(e/1024).toFixed(1)+" KB"),"("+b+", "+d+")"}return"("+b+")"},Zotero.url.userWebLibrary=function(a){return[Zotero.config.baseWebsiteUrl,a,"items"].join("/")},Zotero.url.groupWebLibrary=function(a){return"Private"==a.type?[Zotero.config.baseWebsiteUrl,"groups",a.get("id"),"items"].join("/"):[Zotero.config.baseWebsiteUrl,"groups",Zotero.utils.slugify(a.get("name")),"items"].join("/")},Zotero.url.exportUrls=function(a){Z.debug("Zotero.url.exportUrls",3);var b={},c={};return J.each(Zotero.config.exportFormats,function(d,e){c=J.extend(a,{format:e}),b[e]=Zotero.ajax.apiRequestUrl(c)+Zotero.ajax.apiQueryString({format:e,limit:"25"})}),b},Zotero.url.relationUrl=function(a,b,c){return"http://zotero.org/"+a+"s/"+b+"/items/"+c},Zotero.file={},Zotero.file.getFileInfo=function(a){return"function"!=typeof FileReader?Promise.reject(new Error("FileReader not supported")):new Promise(function(b,c){var d={},e=new FileReader;e.onload=function(c){Z.debug("Zotero.file.getFileInfo onloadFunc",3);var e=c.target.result;Zotero.debug(e,3),d.md5=SparkMD5.ArrayBuffer.hash(e),d.filename=a.name,d.filesize=a.size,d.mtime=Date.now(),d.contentType=a.type,d.filedata=e,b(d)},e.readAsArrayBuffer(a)})},Zotero.file.uploadFile=function(a,b){
Z.debug("Zotero.file.uploadFile",3),Z.debug(a,4);var c=new FormData;J.each(a.params,function(a,b){c.append(a,b)});var d=new Blob([b.filedata],{type:b.contentType});c.append("file",d);var e=new XMLHttpRequest;return e.open("POST",a.url,!0),new Promise(function(a,b){e.onload=function(c){Z.debug("uploadFile onload event",3),201==this.status?(Z.debug("successful upload - 201",3),a()):(Z.error("uploadFile failed - "+e.status),b({message:"Failure uploading file.",code:e.status,serverMessage:e.responseText}))},e.onprogress=function(a){Z.debug("progress event"),Z.debug(a)},e.send(c)})},Zotero.Idb={},Zotero.Idb.Library=function(a){Z.debug("Zotero.Idb.Library",3),Z.debug("Initializing Zotero IDB",3),this.libraryString=a,this.owningLibrary=null,this.initialized=!1},Zotero.Idb.Library.prototype.init=function(){var a=this;return new Promise(function(b,c){var d=window.indexedDB;a.indexedDB=d,Z.debug("requesting indexedDb from browser",3);var e=d.open("Zotero_"+a.libraryString,4);e.onerror=function(a){Zotero.error("ERROR OPENING INDEXED DB"),c()};var f=function(b){Z.debug("Zotero.Idb onupgradeneeded or onsuccess",3);var c=b.oldVersion;Z.debug("oldVersion: "+b.oldVersion,3);var d=b.target.result;if(a.db=d,4>c){Z.debug("Existing object store names:",3),Z.debug(JSON.stringify(d.objectStoreNames),3),Z.debug("Deleting old object stores",3),d.objectStoreNames.items&&d.deleteObjectStore("items"),d.objectStoreNames.tags&&d.deleteObjectStore("tags"),d.objectStoreNames.collections&&d.deleteObjectStore("collections"),d.objectStoreNames.files&&d.deleteObjectStore("files"),d.objectStoreNames.versions&&d.deleteObjectStore("versions"),Z.debug("Existing object store names:",3),Z.debug(JSON.stringify(d.objectStoreNames),3);var e=d.createObjectStore("items",{keyPath:"key"}),f=d.createObjectStore("collections",{keyPath:"key"}),g=d.createObjectStore("tags",{keyPath:"tag"});d.createObjectStore("files"),d.createObjectStore("versions");Z.debug("itemStore index names:",3),Z.debug(JSON.stringify(e.indexNames),3),Z.debug("collectionStore index names:",3),Z.debug(JSON.stringify(f.indexNames),3),Z.debug("tagStore index names:",3),Z.debug(JSON.stringify(g.indexNames),3),J.each(Zotero.Item.prototype.fieldMap,function(a,b){Z.debug("Creating index on "+a,3),e.createIndex(a,"data."+a,{unique:!1})}),e.createIndex("collectionKeys","data.collections",{unique:!1,multiEntry:!0}),e.createIndex("itemTagStrings","_supplement.tagstrings",{unique:!1,multiEntry:!0}),e.createIndex("parentItemKey","data.parentItem",{unique:!1}),e.createIndex("libraryKey","libraryKey",{unique:!1}),e.createIndex("deleted","data.deleted",{unique:!1}),f.createIndex("name","data.name",{unique:!1}),f.createIndex("key","key",{unique:!1}),f.createIndex("parentCollection","data.parentCollection",{unique:!1}),g.createIndex("tag","tag",{unique:!1})}};e.onupgradeneeded=f,e.onsuccess=function(){Z.debug("IDB success",3),a.db=e.result,a.initialized=!0,b(a)}})},Zotero.Idb.Library.prototype.deleteDB=function(){var a=this;return a.db.close(),new Promise(function(b,c){var d=a.indexedDB.deleteDatabase("Zotero_"+a.libraryString);d.onerror=function(){Z.error("Error deleting indexedDB"),c()},d.onsuccess=function(){Z.debug("Successfully deleted indexedDB",2),b()}})},Zotero.Idb.Library.prototype.getObjectStore=function(a,b){var c=this,d=c.db.transaction(a,b);return d.objectStore(a)},Zotero.Idb.Library.prototype.clearObjectStore=function(a){var b=getObjectStore(a,"readwrite");return new Promise(function(a,c){var d=b.clear();d.onsuccess=function(b){Z.debug("Store cleared",3),a()},d.onerror=function(a){Z.error("clearObjectStore:",a.target.errorCode),c()}})},Zotero.Idb.Library.prototype.addItems=function(a){return this.addObjects(a,"item")},Zotero.Idb.Library.prototype.updateItems=function(a){return this.updateObjects(a,"item")},Zotero.Idb.Library.prototype.removeItems=function(a){return this.removeObjects(a,"item")},Zotero.Idb.Library.prototype.getItem=function(a){var b=this;return new Promise(function(c,d){var e=function(a){c(a.target.result)};b.db.transaction("items").objectStore(["items"],"readonly").get(a).onsuccess=e})},Zotero.Idb.Library.prototype.getAllItems=function(){return this.getAllObjects("item")},Zotero.Idb.Library.prototype.getOrderedItemKeys=function(a,b){var c=this;return Z.debug("Zotero.Idb.getOrderedItemKeys",3),Z.debug(""+a+" "+b,3),new Promise(function(d,e){var f=c.db.transaction(["items"],"readonly").objectStore("items"),g=f.index(a);if(!g)throw new Error("Index for requested field '"+a+"'' not found");var h="next";"desc"==b&&(h="prev");var i=g.openKeyCursor(null,h),j=[];i.onsuccess=J.proxy(function(a){var b=a.target.result;b?(j.push(b.primaryKey),b["continue"]()):(Z.debug("No more cursor: done. Resolving deferred.",3),d(j))},this),i.onfailure=J.proxy(function(a){e()},this)})},Zotero.Idb.Library.prototype.filterItems=function(a,b){var c=this;return Z.debug("Zotero.Idb.filterItems "+a+" - "+b,3),new Promise(function(d,e){var f=[],g=c.db.transaction(["items"],"readonly").objectStore("items"),h=g.index(a);if(!h)throw new Error("Index for requested field '"+a+"'' not found");var i="next",j=IDBKeyRange.only(b),k=h.openKeyCursor(j,i);k.onsuccess=J.proxy(function(a){var b=a.target.result;b?(f.push(b.primaryKey),b["continue"]()):(Z.debug("No more cursor: done. Resolving deferred.",3),d(f))},this),k.onfailure=J.proxy(function(a){e()},this)})},Zotero.Idb.Library.prototype.inferType=function(a){if(!a)return!1;if(!a.instance)return!1;switch(a.instance){case"Zotero.Item":return"item";case"Zotero.Collection":return"collection";case"Zotero.Tag":return"tag";default:return!1}},Zotero.Idb.Library.prototype.getTransactionAndStore=function(a,b){var c,d,e=this;switch(a){case"item":c=e.db.transaction(["items"],b),d=c.objectStore("items");break;case"collection":c=e.db.transaction(["collections"],b),d=c.objectStore("collections");break;case"tag":c=e.db.transaction(["tags"],b),d=c.objectStore("tags");break;default:return Promise.reject()}return[c,d]},Zotero.Idb.Library.prototype.addObjects=function(a,b){Z.debug("Zotero.Idb.Library.addObjects",3);var c=this;b||(b=c.inferType(a[0]));var d=c.getTransactionAndStore(b,"readwrite"),e=d[0],f=d[1];return new Promise(function(b,c){e.oncomplete=function(a){Zotero.debug("Add Objects transaction completed.",3),b()},e.onerror=function(a){Zotero.error("Add Objects transaction failed."),c()};var d=function(a){Zotero.debug("Added Object "+a.target.result,4)};for(var g in a){var h=f.add(a[g].apiObj);h.onsuccess=d}})},Zotero.Idb.Library.prototype.updateObjects=function(a,b){Z.debug("Zotero.Idb.Library.updateObjects",3);var c=this;b||(b=c.inferType(a[0]));var d=c.getTransactionAndStore(b,"readwrite"),e=d[0],f=d[1];return new Promise(function(b,c){e.oncomplete=function(a){Zotero.debug("Update Objects transaction completed.",3),b()},e.onerror=function(a){Zotero.error("Update Objects transaction failed."),c()};var d=function(a){Zotero.debug("Updated Object "+a.target.result,4)};for(var g in a){var h=f.put(a[g].apiObj);h.onsuccess=d}})},Zotero.Idb.Library.prototype.removeObjects=function(a,b){var c=this;b||(b=c.inferType(a[0]));var d=c.getTransactionAndStore(b,"readwrite"),e=d[0],f=d[1];return new Promise(function(b,c){e.oncomplete=function(a){Zotero.debug("Remove Objects transaction completed.",3),b()},e.onerror=function(a){Zotero.error("Remove Objects transaction failed."),c()};var d=function(a){Zotero.debug("Removed Object "+a.target.result,4)};for(var g in collections){var h=f["delete"](a[g].key);h.onsuccess=d}})},Zotero.Idb.Library.prototype.getAllObjects=function(a){var b=this;return a||(a=b.inferType(objects[0])),new Promise(function(c,d){var e=[],f=b.db.transaction(a+"s").objectStore(a+"s");f.openCursor().onsuccess=function(a){var b=a.target.result;b?(e.push(b.value),b["continue"]()):c(e)}})},Zotero.Idb.Library.prototype.addCollections=function(a){return this.addObjects(a,"collection")},Zotero.Idb.Library.prototype.updateCollections=function(a){return Z.debug("Zotero.Idb.Library.updateCollections",3),this.updateObjects(a,"collection")},Zotero.Idb.Library.prototype.getCollection=function(a){var b=this;return new Promise(function(c,d){var e=function(a){c(a.target.result)};b.db.transaction("collections").objectStore(["collections"],"readonly").get(a).onsuccess=e})},Zotero.Idb.Library.prototype.removeCollections=function(a){return Z.debug("Zotero.Idb.Library.removeCollections",3),this.removeObjects(a,"collection")},Zotero.Idb.Library.prototype.getAllCollections=function(){return Z.debug("Zotero.Idb.Library.getAllCollections",3),this.getAllObjects("collection")},Zotero.Idb.Library.prototype.addTags=function(a){return this.addObjects(a,"tag")},Zotero.Idb.Library.prototype.updateTags=function(a){return Z.debug("Zotero.Idb.Library.updateTags",3),this.updateObjects(a,"tag")},Zotero.Idb.Library.prototype.getAllTags=function(){return Z.debug("getAllTags",3),this.getAllObjects("tag")},Zotero.Idb.Library.prototype.setVersion=function(a,b){Z.debug("Zotero.Idb.Library.setVersion",3);var c=this;return new Promise(function(d,e){var f=c.db.transaction(["versions"],"readwrite");f.oncomplete=function(a){Zotero.debug("set version transaction completed.",3),d()},f.onerror=function(a){Zotero.error("set version transaction failed."),e()};var g=f.objectStore("versions"),h=function(a){Zotero.debug("Set Version"+a.target.result,3)},i=g.put(b,a);i.onsuccess=h})},Zotero.Idb.Library.prototype.getVersion=function(a){Z.debug("Zotero.Idb.Library.getVersion",3);var b=this;return new Promise(function(c,d){var e=function(a){Z.debug("done getting version"),c(a.target.result)};b.db.transaction(["versions"],"readonly").objectStore("versions").get(a).onsuccess=e})},Zotero.Idb.Library.prototype.setFile=function(a,b){Z.debug("Zotero.Idb.Library.setFile",3);var c=this;return new Promise(function(d,e){var f=c.db.transaction(["files"],"readwrite");f.oncomplete=function(a){Zotero.debug("set file transaction completed.",3),d()},f.onerror=function(a){Zotero.error("set file transaction failed."),e()};var g=f.objectStore("files"),h=function(a){Zotero.debug("Set File"+a.target.result,3)},i=g.put(b,a);i.onsuccess=h})},Zotero.Idb.Library.prototype.getFile=function(a){Z.debug("Zotero.Idb.Library.getFile",3);var b=this;return new Promise(function(c,d){var e=function(a){Z.debug("done getting file"),c(a.target.result)};b.db.transaction(["files"],"readonly").objectStore("files").get(a).onsuccess=e})},Zotero.Idb.Library.prototype.deleteFile=function(a){Z.debug("Zotero.Idb.Library.deleteFile",3);var b=this;return new Promise(function(a,c){var d=b.db.transaction(["files"],"readwrite");d.oncomplete=function(b){Zotero.debug("delete file transaction completed.",3),a()},d.onerror=function(a){Zotero.error("delete file transaction failed."),c()};var e=d.objectStore("files"),f=function(a){Zotero.debug("Deleted File"+a.target.result,4)},g=e["delete"](key);g.onsuccess=f})},Zotero.Idb.Library.prototype.intersect=function(a,b){for(var c=[],d=0;d<a.length;d++)-1!==b.indexOf(a[d])&&c.push(a[d]);return c},Zotero.Idb.Library.prototype.intersectAll=function(a){for(var b=this,c=a[0],d=0;d<a.length-1;d++)c=b.intersect(c,a[d+1]);return c},Zotero.Library.prototype.processLoadedCollections=function(a){Z.debug("processLoadedCollections",3);var b=this;Z.debug("adding collections to library.collections");for(var c=b.collections.addCollectionsFromJson(a.data),d=0;d<c.length;d++)c[d].associateWithLibrary(b);return b.collections.updateSyncState(a.lastModifiedVersion),Zotero.trigger("loadedCollectionsProcessed",{library:b,collectionsAdded:c}),a},Zotero.Library.prototype.addCollection=function(a,b){Z.debug("Zotero.Library.addCollection",3);var c=this,d=new Zotero.Collection;return d.associateWithLibrary(c),d.set("name",a),d.set("parentCollection",b),c.collections.writeCollections([d])},Zotero.Library.prototype.fetchItemKeys=function(a){Z.debug("Zotero.Library.fetchItemKeys",3);var b=this;"undefined"==typeof a&&(a={});var c=J.extend(!0,{target:"items",libraryType:this.libraryType,libraryID:this.libraryID,format:"keys"},a);return b.ajaxRequest(c)},Zotero.Library.prototype.getTrashKeys=function(){Z.debug("Zotero.Library.getTrashKeys",3);var a=this,b={target:"items",libraryType:a.libraryType,libraryID:a.libraryID,format:"keys",collectionKey:"trash"};return a.ajaxRequest(b)},Zotero.Library.prototype.emptyTrash=function(){Z.debug("Zotero.Library.emptyTrash",3);var a=this;return a.getTrashKeys().then(function(b){var c=b.data.split("\n");return a.items.deleteItems(c,b.lastModifiedVersion)})},Zotero.Library.prototype.loadItemKeys=function(a){Z.debug("Zotero.Library.loadItemKeys",3);var b=this;return this.fetchItemKeys(a).then(function(a){Z.debug("loadItemKeys proxied callback",3);var c=a.data.split(/[\s]+/);b.itemKeys=c})},Zotero.Library.prototype.loadItems=function(a){Z.debug("Zotero.Library.loadItems",3);var b=this;a||(a={});var c={target:"items",targetModifier:"top",start:0,limit:25,order:Zotero.config.defaultSortColumn,sort:Zotero.config.defaultSortOrder},d=J.extend({},c,a),e=J.extend({target:"items",libraryType:b.libraryType,libraryID:b.libraryID},d),f=Zotero.ajax.apiRequestString(e);return b.ajaxRequest(f).then(function(a){Z.debug("loadItems proxied callback",3);var c=b.items,d=c.addItemsFromJson(a.data);Z.debug("Looping over loadedItemsArray");for(var e=0;e<d.length;e++)d[e].associateWithLibrary(b);return a.loadedItems=d,Zotero.trigger("itemsChanged",{library:b}),a})},Zotero.Library.prototype.loadPublications=function(a){Z.debug("Zotero.Library.loadPublications",3);var b=this;a||(a={});var c={target:"publications",start:0,limit:50,order:Zotero.config.defaultSortColumn,sort:Zotero.config.defaultSortOrder,include:"bib"},d=J.extend({},c,a),e=J.extend({target:"publications",libraryType:b.libraryType,libraryID:b.libraryID},d),f=Zotero.ajax.apiRequestString(e);return b.ajaxRequest(f).then(function(a){return Z.debug("loadPublications proxied callback",3),publicationItems=[],parsedItemJson=a.data,J.each(parsedItemJson,function(a,b){var c=new Zotero.Item(b);publicationItems.push(c)}),a.publicationItems=publicationItems,a})},Zotero.Library.prototype.processLoadedItems=function(a){Z.debug("processLoadedItems",3);for(var b=this,c=b.items,d=c.addItemsFromJson(a.data),e=0;e<d.length;e++)d[e].associateWithLibrary(b);return b.items.updateSyncState(a.lastModifiedVersion),Zotero.trigger("itemsChanged",{library:b,loadedItems:d}),a},Zotero.Library.prototype.loadItem=function(a){Z.debug("Zotero.Library.loadItem",3);var b=this;if(!c)var c={};var d={target:"item",libraryType:b.libraryType,libraryID:b.libraryID,itemKey:a};return b.ajaxRequest(d).then(function(a){Z.debug("Got loadItem response");var c=new Zotero.Item(a.data);return c.owningLibrary=b,b.items.itemObjects[c.key]=c,Zotero.trigger("itemsChanged",{library:b}),c},function(a){Z.debug("Error loading Item")})},Zotero.Library.prototype.trashItem=function(a){var b=this;return b.items.trashItems([b.items.getItem(a)])},Zotero.Library.prototype.untrashItem=function(a){if(Z.debug("Zotero.Library.untrashItem",3),!a)return!1;var b=this.items.getItem(a);return b.apiObj.deleted=0,b.writeItem()},Zotero.Library.prototype.deleteItem=function(a){Z.debug("Zotero.Library.deleteItem",3);var b=this;return b.items.deleteItem(a)},Zotero.Library.prototype.deleteItems=function(a){Z.debug("Zotero.Library.deleteItems",3);var b=this;return b.items.deleteItems(a)},Zotero.Library.prototype.addNote=function(a,b){Z.debug("Zotero.Library.prototype.addNote",3);var c=this,d={target:"children",libraryType:c.libraryType,libraryID:c.libraryID,itemKey:a},e=Zotero.ajax.apiRequestString(d);this.items.getItem(a);return c.ajaxRequest(e,"POST",{processData:!1})},Zotero.Library.prototype.fetchGlobalItems=function(a){Z.debug("Zotero.Library.fetchGlobalItems",3);var b=this;a||(a={});var c={target:"items",start:0,limit:25},d=J.extend({},c,a),e=J.extend({target:"items",libraryType:""},d),f=Zotero.ajax.apiRequestString(e);return b.ajaxRequest(f,"GET",{dataType:"json"}).then(function(a){return Z.debug("globalItems callback",3),a.data})},Zotero.Library.prototype.fetchGlobalItem=function(a){Z.debug("Zotero.Library.fetchGlobalItem",3),Z.debug(a);var b=this,c={target:"item"},d=J.extend({},c),e=J.extend({target:"item",libraryType:"",itemKey:a},d),f=Zotero.ajax.apiRequestString(e);return b.ajaxRequest(f,"GET",{dataType:"json"}).then(function(a){return Z.debug("globalItem callback",3),a.data})},Zotero.Library.prototype.fetchTags=function(a){Z.debug("Zotero.Library.fetchTags",3);var b={target:"tags",order:"title",sort:"asc",limit:100},c=J.extend({},b,a),d=J.extend({target:"tags",libraryType:this.libraryType,libraryID:this.libraryID},c);return Zotero.ajaxRequest(d)},Zotero.Library.prototype.loadTags=function(a){Z.debug("Zotero.Library.loadTags",3);var b=this;return"undefined"==typeof a&&(a={}),a.showAutomaticTags&&a.collectionKey&&delete a.collectionKey,b.tags.displayTagsArray=[],b.fetchTags(a).then(function(a){Z.debug("loadTags proxied callback",3);var c=a.lastModifiedVersion;b.tags.updateSyncState(c);b.tags.addTagsFromJson(a.data);return b.tags.updateTagsVersion(c),b.tags.rebuildTagsArray(),a.parsedLinks.hasOwnProperty("next")?(b.tags.hasNextLink=!0,b.tags.nextLink=a.parsedLinks.next):(b.tags.hasNextLink=!1,b.tags.nextLink=null),b.trigger("tagsChanged",{library:b}),b.tags})},Zotero.Library.prototype.loadAllTags=function(a){Z.debug("Zotero.Library.loadAllTags",3);var b=this;"undefined"==typeof a&&(a={});var c={target:"tags",order:"title",sort:"asc",limit:100,libraryType:b.libraryType,libraryID:b.libraryID},d=J.extend({},c,a),e=J.extend({},d),f=Zotero.ajax.apiRequestString(e),g=b.tags,h=(J.extend({},c,g.loadedConfig),g.loadedRequestUrl);return Z.debug("requestUrl: "+f,4),Z.debug("loadedConfigRequestUrl: "+h,4),new Promise(function(c,d){var g=function h(c){Z.debug("loadAllTags continueLoadingCallback",3);var d=Zotero.Tags.prototype.plainTagsList(c.tagsArray);if(d.sort(Zotero.Library.prototype.comparer()),c.plainList=d,c.hasNextLink){Z.debug("still has next link.",3),c.tagsArray.sort(Zotero.Tag.prototype.tagComparer()),d=Zotero.Tags.prototype.plainTagsList(c.tagsArray),d.sort(Zotero.Library.prototype.comparer()),c.plainList=d;var e=c.nextLink,g=J.deparam(J.param.querystring(e)),i=J.extend({},a);return i.start=g.start,i.limit=g.limit,b.loadTags(i).then(h)}Z.debug("no next in tags link",3),c.updateSyncedVersion(),c.tagsArray.sort(Zotero.Tag.prototype.tagComparer()),d=Zotero.Tags.prototype.plainTagsList(c.tagsArray),d.sort(Zotero.Library.prototype.comparer()),c.plainList=d,Z.debug("resolving loadTags deferred",3),b.tagsLoaded=!0,b.tags.loaded=!0,c.loadedConfig=a,c.loadedRequestUrl=f;for(var j=0;j<b.tags.tagsArray.length;j++)c.tagsArray[j].apiObj.version=c.tagsVersion;return b.trigger("tagsChanged",{library:b}),c};c(b.loadTags(e).then(g))})},Zotero.Library.prototype.loadIndexedDBCache=function(){Zotero.debug("Zotero.Library.loadIndexedDBCache",3);var a=this,b=a.idbLibrary.getAllItems(),c=a.idbLibrary.getAllCollections(),d=a.idbLibrary.getAllTags();return b.then(function(b){Z.debug("loadIndexedDBCache itemsD done",3);for(var c=0,d=0;d<b.length;d++){var e=new Zotero.Item(b[d]);a.items.addItem(e),e.version>c&&(c=e.version)}a.items.itemsVersion=c,a.items.loaded=!0,Z.debug("Done loading indexedDB items promise into library",3)}),c.then(function(b){Z.debug("loadIndexedDBCache collectionsD done",3);for(var c=0,d=0;d<b.length;d++){var e=new Zotero.Collection(b[d]);a.collections.addCollection(e),e.version>c&&(c=e.version)}a.collections.collectionsVersion=c,a.collections.initSecondaryData(),a.collections.loaded=!0}),d.then(function(b){Z.debug("loadIndexedDBCache tagsD done",3),Z.debug(b);for(var c=0,d=0,e=0;e<b.length;e++){var f=new Zotero.Tag(b[e]);a.tags.addTag(f),b[e].version>c&&(c=b[e].version)}d=c,a.tags.tagsVersion=d,a.tags.loaded=!0}),Promise.all([b,c,d])},Zotero.Library.prototype.saveIndexedDB=function(){var a=this,b=a.idbLibrary.updateItems(a.items.itemsArray),c=a.idbLibrary.updateCollections(a.collections.collectionsArray),d=a.idbLibrary.updateTags(a.tags.tagsArray);return Promise.all([b,c,d])},Zotero.Preferences=function(a,b){this.store=a,this.idString=b,this.preferencesObject={},this.defaults={debug_level:3,debug_log:!0,debug_mock:!1,listDisplayedFields:["title","creator","dateModified"],showAutomaticTags:!1,itemsPerPage:25,order:"title",title:"asc"},this.load()},Zotero.Preferences.prototype.setPref=function(a,b){var c=this;c.preferencesObject[a]=b,c.persist()},Zotero.Preferences.prototype.setPrefs=function(a){var b=this;if("object"!=("undefined"==typeof a?"undefined":_typeof(a)))throw new Error("Preferences must be an object");b.preferencesObject=a,b.persist()},Zotero.Preferences.prototype.getPref=function(a){var b=this;return b.preferencesObject[a]?b.preferencesObject[a]:b.defaults[a]?b.defaults[a]:null},Zotero.Preferences.prototype.getPrefs=function(){var a=this;return a.preferencesObject},Zotero.Preferences.prototype.persist=function(){var a=this,b="preferences_"+a.idString;a.store[b]=JSON.stringify(a.preferencesObject)},Zotero.Preferences.prototype.load=function(){var a=this,b="preferences_"+a.idString,c=a.store[b];c?a.preferencesObject=JSON.parse(c):a.preferencesObject={}},Zotero.Library.prototype.syncLibrary=function(a){var b=this;b.loadUpdatedCollections().then(function(){return b.loadUpdatedItems()})};